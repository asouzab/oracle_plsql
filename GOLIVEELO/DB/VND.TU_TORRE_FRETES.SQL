--------------------------------------------------------
--  DDL for Trigger TU_TORRE_FRETES
--------------------------------------------------------

  CREATE OR REPLACE TRIGGER "VND"."TU_TORRE_FRETES" BEFORE UPDATE ON VND.ELO_CARTEIRA 
REFERENCING NEW AS new FOR EACH ROW

DECLARE
V_CUSTOMER_SERVICE_NEW NUMBER;
V_CUSTOMER_SERVICE_PRO NUMBER;
V_CUSTOMER_SERVICE_FIN NUMBER;


BEGIN

    BEGIN
    SELECT I_ST_NEW_PRO.CD_ELO_STATUS INTO V_CUSTOMER_SERVICE_NEW
    FROM VND.ELO_STATUS I_ST_NEW_PRO
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
    ON 
    I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
    WHERE
    I_ST_NEW_PRO.SG_STATUS IN('CANEW') 
    AND I_ST_TIPO_NP.SG_TIPO_STATUS = 'CARTE' ;
    EXCEPTION 
    WHEN OTHERS THEN 
        V_CUSTOMER_SERVICE_NEW:= NULL;
    END;

    BEGIN
    SELECT I_ST_NEW_PRO.CD_ELO_STATUS INTO V_CUSTOMER_SERVICE_PRO
    FROM VND.ELO_STATUS I_ST_NEW_PRO
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
    ON 
    I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
    WHERE
    I_ST_NEW_PRO.SG_STATUS IN('CAPRO') 
    AND I_ST_TIPO_NP.SG_TIPO_STATUS = 'CARTE' ;
    EXCEPTION 
    WHEN OTHERS THEN 
        V_CUSTOMER_SERVICE_PRO:= NULL;
    END;
    


    BEGIN
    SELECT I_ST_NEW_PRO.CD_ELO_STATUS INTO V_CUSTOMER_SERVICE_FIN
    FROM VND.ELO_STATUS I_ST_NEW_PRO
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
    ON 
    I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
    WHERE
    I_ST_NEW_PRO.SG_STATUS IN('CAFIN') 
    AND I_ST_TIPO_NP.SG_TIPO_STATUS = 'CARTE' ;
    EXCEPTION 
    WHEN OTHERS THEN 
        V_CUSTOMER_SERVICE_FIN:= NULL;
    END;


     
    IF :new.CD_STATUS_TORRE_FRETES = V_CUSTOMER_SERVICE_PRO AND 
        NOT(:new.CD_STATUS_CUSTOMER_SERVICE = :old.CD_STATUS_CUSTOMER_SERVICE AND
        :new.CD_STATUS_TORRE_FRETES = :old.CD_STATUS_TORRE_FRETES AND
        :new.IC_PERMITIR_CS = :old.IC_PERMITIR_CS AND
        :new.SG_DESTINO_BACKLOG_CIF = :old.SG_DESTINO_BACKLOG_CIF ) THEN

        :new.DH_MODIFICACAO_TORRE_FRETES:= CURRENT_DATE; 
        :new.DH_CONTRATACAO_TORRE_FRETES:= CURRENT_DATE; 
            
    END IF;
    
    IF :new.SG_DESTINO_BACKLOG_CIF IS NOT NULL AND 
    :new.CD_ELO_CARTEIRA_GROUPING IS NOT NULL AND 
    (:new.SG_DESTINO_BACKLOG_CIF IS NOT NULL AND NVL(TRIM(:old.SG_DESTINO_BACKLOG_CIF), '') = '' ) THEN 
    :new.DH_BACKLOG_CIF:= CURRENT_DATE;
    END IF;
       

    IF :new.CD_STATUS_TORRE_FRETES = V_CUSTOMER_SERVICE_PRO OR :new.CD_STATUS_TORRE_FRETES = V_CUSTOMER_SERVICE_NEW AND 
    :new.CD_ELO_CARTEIRA_GROUPING IS NOT NULL AND :new.CD_STATUS_CUSTOMER_SERVICE IS NOT NULL  THEN 
        :new.CD_STATUS_CUSTOMER_SERVICE:= V_CUSTOMER_SERVICE_FIN;
        :new.NU_PROTOCOLO_ENTREGA:= 'SCS:)' || TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD HH:MI');
    END IF;
  





END;
/
ALTER TRIGGER "VND"."TU_TORRE_FRETES" ENABLE;
