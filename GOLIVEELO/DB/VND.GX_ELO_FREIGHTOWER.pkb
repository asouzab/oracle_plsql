CREATE OR REPLACE PACKAGE BODY VND."GX_ELO_FREIGHTOWER" AS



    PROCEDURE PX_GET_POLOS ( P_RETURN OUT T_CURSOR )
        IS
    BEGIN
        OPEN P_RETURN FOR
            SELECT
                CD_POLO,
                DS_POLO
            FROM
                CTF.POLO
            WHERE
                IC_ATIVO = 'S';

    END PX_GET_POLOS;

    PROCEDURE PX_GET_POLO (
        P_RETURN   OUT T_CURSOR,
        P_CD_POLO   IN VARCHAR2
    )
        IS
    BEGIN
        OPEN P_RETURN FOR
            SELECT
                CD_POLO,
                DS_POLO
            FROM
                CTF.POLO
            WHERE
                    IC_ATIVO = 'S'
                AND
                    CD_POLO IN( P_CD_POLO);

    END PX_GET_POLO;



    PROCEDURE PX_GET_CENTERS ( P_RETURN OUT T_CURSOR )
    IS
    BEGIN
        OPEN P_RETURN FOR

        SELECT ce.CD_CENTRO_EXPEDIDOR,
               ce.CD_CENTRO_EXPEDIDOR || '-' || ce.DS_CENTRO_EXPEDIDOR DS_CENTRO_EXPEDIDOR
          from CTF.CENTRO_EXPEDIDOR ce
         where ce.IC_ATIVO = 'S'
      order by ce.DS_CENTRO_EXPEDIDOR;

    END PX_GET_CENTERS;


    PROCEDURE PX_GET_FREIGHT_TOWER_REASON ( P_RETURN OUT T_CURSOR )
    IS
    BEGIN
        OPEN P_RETURN FOR
        SELECT 
        CD_ELO_FREIGHT_TOWER_REASON,
        DS_FREIGHT_TOWER_REASON,
        DS_COLOR,
        CD_DEPARTAMENTO
        FROM ELO_FREIGHT_TOWER_REASON ;

    END PX_GET_FREIGHT_TOWER_REASON;



	PROCEDURE PX_GET_CENTERS ( P_CD_POLO   IN VARCHAR2, 
	P_RETURN OUT T_CURSOR )
    IS
    BEGIN
	    IF ((NVL(P_CD_POLO, '9999') = '9999') OR (P_CD_POLO = '0'))   THEN

			OPEN P_RETURN FOR

			SELECT CE.CD_CENTRO_EXPEDIDOR,
				   CE.CD_CENTRO_EXPEDIDOR || '-' || CE.DS_CENTRO_EXPEDIDOR DS_CENTRO_EXPEDIDOR
			  from CTF.CENTRO_EXPEDIDOR CE
			 where CE.IC_ATIVO = 'S'
		  order by CE.DS_CENTRO_EXPEDIDOR;

		  ELSE 

				OPEN P_RETURN FOR
                SELECT DISTINCT
                    CE.CD_CENTRO_EXPEDIDOR,
                    CE.CD_CENTRO_EXPEDIDOR || '-' ||  CE.DS_CENTRO_EXPEDIDOR DS_CENTRO_EXPEDIDOR
                FROM
                    CTF.CENTRO_EXPEDIDOR CE
                    INNER JOIN CTF.POLO_CENTRO_EXPEDIDOR PC 
                    ON 
                    PC.CD_CENTRO_EXPEDIDOR = CE.CD_CENTRO_EXPEDIDOR
                WHERE
                        PC.CD_POLO IN( P_CD_POLO)
                    AND
                        CE.IC_ATIVO = 'S'
                        AND PC.IC_ATIVO =  'S'
                ORDER BY DS_CENTRO_EXPEDIDOR;


		  END IF ;

    END PX_GET_CENTERS;


    PROCEDURE PX_GET_MACHINES ( P_CD_CENTRO     IN VARCHAR2,
                                P_RETURN        OUT T_CURSOR )
    IS
    BEGIN




        OPEN P_RETURN FOR

        SELECT DISTINCT ma.CD_MACHINE,
               ma.DS_MACHINE
          FROM CTF.MACHINE ma
         INNER JOIN CTF.CENTRO_EXPEDIDOR_MACHINE cem 
		 ON 
		 ma.CD_MACHINE = cem.CD_MACHINE
         INNER JOIN CTF.CENTRO_EXPEDIDOR ce
         ON
         ce.CD_CENTRO_EXPEDIDOR = cem.CD_CENTRO_EXPEDIDOR
         WHERE ma.IC_ATIVO = 'S'
         and cem.IC_ATIVO = 'S'
         and ce.IC_ATIVO = 'S'

           AND (P_CD_CENTRO IS NULL OR P_CD_CENTRO = '0' OR P_CD_CENTRO = '9999') OR cem.CD_CENTRO_EXPEDIDOR IN (P_CD_CENTRO)
      ORDER BY ma.DS_MACHINE;

    END PX_GET_MACHINES;

    PROCEDURE PX_GET_CD_WEEK (
        P_RETURN   OUT T_CURSOR
    )
        IS
    BEGIN
        OPEN P_RETURN FOR
        SELECT AG.CD_WEEK, 'W' ||TO_char(AG.DT_WEEK_START, 'YYYYWW') WEEK_OF_YEAR  
        FROM VND.ELO_AGENDAMENTO AG
        WHERE AG.IC_ATIVO = 'S'
        AND EXISTS 
            (SELECT 1 
            FROM VND.ELO_CARTEIRA E_CT 
            INNER JOIN VND.ELO_CARTEIRA_TORRE_FRETES TF
            ON E_CT.CD_ELO_CARTEIRA = TF.CD_ELO_CARTEIRA

            INNER JOIN VND.ELO_STATUS I_ST_NEW_PRO
            ON
            E_CT.CD_STATUS_TORRE_FRETES =  I_ST_NEW_PRO.CD_ELO_STATUS
            INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
            ON 
            I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS

            WHERE E_CT.CD_ELO_AGENDAMENTO = AG.CD_ELO_AGENDAMENTO 
            AND I_ST_NEW_PRO.SG_STATUS  IN('CANEW', 'CAPRO')  --TORRE FRETE
            AND I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'             
            AND E_CT.IC_ATIVO = 'S')
        GROUP BY 
        AG.CD_WEEK, TO_char(AG.DT_WEEK_START, 'YYYYWW')
        ORDER BY TO_char(AG.DT_WEEK_START, 'YYYYWW');



    END PX_GET_CD_WEEK;


    PROCEDURE PX_GET_TRANSPORTADORA(
        P_RETURN   OUT T_CURSOR
    )
        IS
    BEGIN
        OPEN P_RETURN FOR
    SELECT 

    CD_TRANSPORTADORA  ,   
    CD_USUARIO     ,
    NO_TRANSPORTADORA, 
    DS_EMAIL      ,
    NU_CPF       ,
    NU_CNPJ       ,
    NU_INSCRICAO_ESTADUAL,     
    DS_ENDERECO  ,
    DS_BAIRRO     ,
    NO_MUNICIPIO  ,
    CD_ESTADO      , 
    NU_CEP    ,
    NU_TELEFONE,       
    NU_FAX      ,  
    IC_VISUALIZAR   
    FROM VND.TRANSPORTADORA;



    END PX_GET_TRANSPORTADORA;


   PROCEDURE PX_GET_TORRE_FRETES (
        P_CD_POLO               IN VARCHAR2,
        P_CD_CENTRO_EXPEDIDOR   IN VARCHAR2,
        P_MACHINE               IN VARCHAR2,
        P_DT_WEEK_FROM          IN VARCHAR2,
        P_DT_WEEK_TO            IN VARCHAR2,
        P_RETURN                OUT T_CURSOR
    )

    IS

        L_CD_POLO                VARCHAR2(4000);
        L_CD_CENTRO_EXPEDIDOR    VARCHAR2(4000);
        L_MACHINE                VARCHAR2(4000);
        L_DT_WEEK_FROM           VARCHAR2(20);
        L_DT_WEEK_TO             VARCHAR2(20); 
        L_DT_FROM_NULL           DATE;
BEGIN

        SELECT   
        DECODE(P_CD_POLO,  '0', '9999', P_CD_POLO),
         DECODE(P_CD_CENTRO_EXPEDIDOR, '0', '9999', P_CD_CENTRO_EXPEDIDOR),
         DECODE(P_MACHINE,  '0', '9999', P_MACHINE),
        DECODE(P_DT_WEEK_FROM, NULL, TO_CHAR(SYSDATE, 'YYYY-MM-DD'),  P_DT_WEEK_FROM),
         DECODE(P_DT_WEEK_TO, NULL, TO_CHAR(SYSDATE, 'YYYY-MM-DD'),  P_DT_WEEK_TO)
         INTO
        L_CD_POLO, 
        L_CD_CENTRO_EXPEDIDOR,
        L_MACHINE,
        L_DT_WEEK_FROM,
        L_DT_WEEK_TO
        FROM DUAL;

--        IF TO_DATE( L_DT_WEEK_TO, 'YYYY-MM-DD') - TO_DATE(L_DT_WEEK_FROM, 'YYYY-MM-DD') > 366 THEN
--          L_DT_WEEK_FROM:=   TO_CHAR(TRUNC(TO_DATE( L_DT_WEEK_TO, 'YYYY-MM-DD') - 31, 'MM'), 'YYYY-MM-DD');
--          END IF;

        L_DT_FROM_NULL:= null; --TO_DATE('1900-01-01', 'YYYY-MM-DD');

        --ALTERE AQUI E O COPIE PARA O EXCEL 2017-11-27
        OPEN P_RETURN FOR

WITH CTE_ELO_AGENDAMENTO AS 
(
----------------INCLUDE FILTER BY DATE AND DATE+2WEEK AND REPLAN
SELECT FILAG.CD_ELO_AGENDAMENTO FROM 

(
 
SELECT DISTINCT 
CAG.CD_ELO_AGENDAMENTO--, 
--CAG.DT_WEEK_START, 
----CAG.CD_CENTRO_EXPEDIDOR, --CAG.CD_POLO, --CAG.CD_MACHINE, 
--CAG.CD_WEEK ,
--
--E_AGCMAC.CD_CENTRO_EXPEDIDOR , 
--E_AGCMAC.CD_MACHINE , 
--E_AGPC.CD_POLO  
 
FROM VND.VW_ELO_AGENDAMENTO_ALL CAG
WHERE
CAG.IC_ATIVO = 'S'
AND
((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
(L_CD_POLO = '9999' OR (CAG.CD_POLO IN (  select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null))))
 
AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
(L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
 
AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
(L_MACHINE = '9999' OR ((CAG.CD_MACHINE) IN (  L_MACHINE))))
 
AND 
    (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
     AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD'),'YYYYWW'))
UNION 
 
SELECT DISTINCT 
CAG.CD_ELO_AGENDAMENTO--, 

FROM VND.VW_ELO_AGENDAMENTO_ALL  CAG

WHERE
CAG.IC_ATIVO = 'S'
AND
((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
(L_CD_POLO = '9999' OR (CAG.CD_POLO IN  ( select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null ))))
    
AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
(L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN(   select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
 
AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
(L_MACHINE = '9999' OR ((CAG.CD_MACHINE)  IN ( L_MACHINE))))
 
AND 
        --HERE NEED CHANGE DT_WEEK_START TO DT_WEEK_REPLAN
    (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
     AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD') ,'YYYYWW'))
AND 
EXISTS (
    SELECT 1 FROM VND.VW_ELO_CARTEIRA_ALL CCT
    INNER JOIN VND.ELO_STATUS EST_REPLAN
    ON
    CCT.CD_TIPO_AGENDAMENTO = EST_REPLAN.CD_ELO_STATUS
    AND EST_REPLAN.SG_STATUS = 'REPLAN'
    
    WHERE 
    CCT.CD_ELO_AGENDAMENTO = CAG.CD_ELO_AGENDAMENTO
    AND CCT.IC_ATIVO = 'S'
    AND CCT.CD_INCOTERMS = 'CIF'
    AND CCT.IC_COOPERATIVE IN ('S', 'N')
    )         
-----------------------------------------------------------------------------------------------------------
UNION
 
SELECT CAG.CD_ELO_AGENDAMENTO FROM VND.ELO_AGENDAMENTO CAG
WHERE 
     CAG.IC_ATIVO = 'S'
    AND
    ((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
    (L_CD_POLO = '9999' OR (CAG.CD_POLO IN (  select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null))))
    
    AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
    (L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
    
    AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
    (L_MACHINE = '9999' OR ((CAG.CD_MACHINE) IN (  L_MACHINE))))
  
    AND 
        (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
         AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD'),'YYYYWW'))
UNION 
SELECT CAG.CD_ELO_AGENDAMENTO FROM VND.ELO_AGENDAMENTO CAG
 
WHERE 
     CAG.IC_ATIVO = 'S'
    AND
    ((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
    (L_CD_POLO = '9999' OR (CAG.CD_POLO IN  ( select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null))))
    
    AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
    (L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN(   select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
    
    AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
    (L_MACHINE = '9999' OR ((CAG.CD_MACHINE)  IN ( L_MACHINE))))
 
    AND 
            --HERE NEED CHANGE DT_WEEK_START TO DT_WEEK_REPLAN
        (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
         AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD') ,'YYYYWW'))
    AND 
    EXISTS (
        SELECT 1 FROM VND.VW_ELO_CARTEIRA_ALL CCT
        INNER JOIN VND.ELO_STATUS EST_REPLAN
        ON
        CCT.CD_TIPO_AGENDAMENTO = EST_REPLAN.CD_ELO_STATUS
        AND EST_REPLAN.SG_STATUS = 'REPLAN'
        
        WHERE 
        CCT.CD_ELO_AGENDAMENTO = CAG.CD_ELO_AGENDAMENTO
        AND CCT.IC_ATIVO = 'S'
        AND CCT.CD_INCOTERMS = 'CIF'
        AND CCT.IC_COOPERATIVE IN ('S', 'N')
    )         
         

) FILAG
WHERE 
EXISTS (
        SELECT 1 FROM VND.VW_ELO_CARTEIRA_ALL CCTE
        INNER JOIN VND.ELO_STATUS E_ST_CS
        ON
        CCTE.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS 

        INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR SUP  --INSERIR LINHAS
        ON
        SUP.CD_ELO_AGENDAMENTO = CCTE.CD_ELO_AGENDAMENTO
        AND SUP.IC_ATIVO = 'S'

        INNER JOIN VND.ELO_AGENDAMENTO_ITEM ITEM
        ON
        ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
        AND ITEM.CD_ELO_AGENDAMENTO_ITEM = CCTE.CD_ELO_AGENDAMENTO_ITEM
        AND ITEM.IC_ATIVO = 'S'
        AND ITEM.CD_INCOTERMS = 'CIF'
        
        INNER JOIN VND.ELO_CARTEIRA_GROUPING CT_CHOGRP
        ON CT_CHOGRP.CD_ELO_CARTEIRA_GROUPING = CCTE.CD_ELO_CARTEIRA_GROUPING 
        AND CT_CHOGRP.CD_ELO_CARTEIRA = CCTE.CD_ELO_CARTEIRA

        WHERE 
        CCTE.CD_ELO_AGENDAMENTO = FILAG.CD_ELO_AGENDAMENTO
        AND CCTE.IC_ATIVO = 'S'
        AND CCTE.CD_INCOTERMS = 'CIF'
        AND CCTE.IC_COOPERATIVE IN ('S', 'N')

        AND E_ST_CS.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN') 
           ) 

), 
CTE_CARTEIRA_FILTER AS 
(
SELECT DISTINCT T.CD_ELO_CARTEIRA, T.CD_ELO_AGENDAMENTO, T.CD_ELO_AGENDAMENTO_ITEM 
FROM VND.VW_ELO_CARTEIRA_ALL T
INNER JOIN  CTE_ELO_AGENDAMENTO CTAG 
ON CTAG.CD_ELO_AGENDAMENTO = T.CD_ELO_AGENDAMENTO
--INNER JOIN VND.ELO_STATUS E_ST_CS
--ON
--T.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS
WHERE 
T.IC_ATIVO = 'S'
AND T.CD_INCOTERMS = 'CIF'
AND T.IC_COOPERATIVE IN ('S', 'N')
--AND E_ST_CS.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')
AND (T.CD_STATUS_CUSTOMER_SERVICE IS NOT NULL )
AND EXISTS (
        SELECT 1 FROM VND.ELO_AGENDAMENTO_SUPERVISOR SUP  --INSERIR LINHAS
        INNER JOIN VND.ELO_AGENDAMENTO_ITEM ITEM
        ON
        ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
        WHERE
        SUP.CD_ELO_AGENDAMENTO = T.CD_ELO_AGENDAMENTO
        AND ITEM.CD_ELO_AGENDAMENTO_ITEM = T.CD_ELO_AGENDAMENTO_ITEM
        AND SUP.IC_ATIVO = 'S'
        AND ITEM.IC_ATIVO = 'S'
        AND ITEM.CD_INCOTERMS = 'CIF'   
        )
AND EXISTS (
        SELECT 1 FROM VND.ELO_CARTEIRA_GROUPING CT_CHOGRP
        WHERE 
        CT_CHOGRP.CD_ELO_CARTEIRA_GROUPING = T.CD_ELO_CARTEIRA_GROUPING 
        )
        

--and T.CD_ELO_CARTEIRA IN (100000271, 100000272, 100000273, 100000274, 100000275, 100000276, 100000277) 	
), 

CTE_APPLY_ANTECIPADO AS 
(
    SELECT 
    CHECKATEN.CD_ELO_CARTEIRA, 
    CHECKATEN.QT_REGRA_ANTECIPADO, 
    CHECKATEN.MIN_SEMANA_SAIDA,
    CHECKATEN.IS_SEMANA_EXECUCAO,
    CASE
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 1 AND CHECKATEN.QT_REGRA_ANTECIPADO > 0 THEN 1
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 1 AND CHECKATEN.QT_REGRA_ANTECIPADO = 0 THEN 0
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 0 AND CHECKATEN.QT_REGRA_ANTECIPADO = 0 THEN 0
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 0 AND CHECKATEN.QT_REGRA_ANTECIPADO > 0 THEN 0
    ELSE 0

    END IS_SHOW_ANTECIPADO

    FROM
    (
    SELECT CART_FIL.CD_ELO_CARTEIRA, 
    NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CART
    ON    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_AGENDAMENTO E_AGEND
    ON    E_AGEND.CD_ELO_AGENDAMENTO = E_CART.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON     I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS
    WHERE     CART_FIL.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND E_MAR.DH_SAIDA IS NOT NULL
    AND E_MAR.IC_ATIVO = 'S'
    AND NOT(TO_CHAR(E_AGEND.DT_WEEK_START,'YYYYWW') = TO_CHAR(E_MAR.DH_SAIDA,'YYYYWW'))
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG' 
    GROUP BY E_CART.CD_ELO_CARTEIRA),0) + 

    NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CART
    ON    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_AGENDAMENTO E_AGEND
    ON    E_AGEND.CD_ELO_AGENDAMENTO = E_CART.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON     I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS
    WHERE     CART_FIL.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'REPLAN'
    AND E_MAR.DH_SAIDA IS NOT NULL
    AND E_MAR.IC_ATIVO = 'S'
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG' 
    GROUP BY E_CART.CD_ELO_CARTEIRA),0) QT_REGRA_ANTECIPADO,

    (SELECT  TO_CHAR(MIN(O_MAR.DH_SAIDA) ,'YYYYWW') MIN_SEMANA_SAIDA 
    FROM VND.ELO_MARCACAO O_MAR
    WHERE 
    O_MAR.DH_SAIDA IS NOT NULL
    AND O_MAR.IC_ATIVO = 'S'
    AND CART_FIL.CD_ELO_CARTEIRA = O_MAR.CD_ELO_CARTEIRA
    GROUP BY O_MAR.CD_ELO_CARTEIRA) MIN_SEMANA_SAIDA, 


    NVL((SELECT 1 
    FROM VND.VW_ELO_CARTEIRA_ALL E_CART
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    CART_FIL.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS  IN('PLAN', 'AGCTR')  --EM EXECUCAO
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'AGEND'
    AND ROWNUM =1 )
    ,0) IS_SEMANA_EXECUCAO,
    0 IS_SHOW_ANTECIPADO

    FROM CTE_CARTEIRA_FILTER CART_FIL
    ) CHECKATEN


),

CTE_SUM_OF_COTA AS 

(
SELECT 

ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 1 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_SEG,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 2 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END)  ,2) COTA_NUQ_TER,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 3 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_QUA,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 4 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_QUI,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 5 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_SEX,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 6 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_SAB,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 7 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_DOM

FROM CTE_ELO_AGENDAMENTO ICTE_AG
INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR IE_A_SUP  --INSERIR LINHAS
ON
IE_A_SUP.CD_ELO_AGENDAMENTO = ICTE_AG.CD_ELO_AGENDAMENTO
AND IE_A_SUP.IC_ATIVO = 'S'

INNER JOIN VND.ELO_AGENDAMENTO_ITEM IE_AG_ITEM
ON
IE_AG_ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = IE_A_SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
AND IE_AG_ITEM.IC_ATIVO = 'S'

--INNER JOIN CTE_CARTEIRA_FILTER CCC
--ON
--CCC.CD_ELO_AGENDAMENTO = ICTE_AG.CD_ELO_AGENDAMENTO
--AND CCC.CD_ELO_AGENDAMENTO_ITEM = IE_AG_ITEM.CD_ELO_AGENDAMENTO_ITEM

INNER JOIN VND.ELO_AGENDAMENTO_WEEK IEAG_WE_I
ON IE_AG_ITEM.CD_ELO_AGENDAMENTO_ITEM = IEAG_WE_I.CD_ELO_AGENDAMENTO_ITEM

INNER JOIN ELO_AGENDAMENTO_DAY IE_AGDAY
ON 
IE_AGDAY.CD_ELO_AGENDAMENTO_WEEK = IEAG_WE_I.CD_ELO_AGENDAMENTO_WEEK

WHERE 
 IE_AG_ITEM.CD_INCOTERMS = 'CIF'
GROUP BY 1 

) 

SELECT 
GRSAP.CD_ELO_CARTEIRA  , 
GRSAP.CD_ELO_AGENDAMENTO_ITEM  , 
GRSAP.DH_CARTEIRA  , 
GRSAP.CD_SALES_ORG  , 
GRSAP.NU_CONTRATO_SAP  , 
GRSAP.CD_TIPO_CONTRATO  , 
GRSAP.NU_CONTRATO_SUBSTITUI  , 
GRSAP.DT_PAGO  , 
GRSAP.NU_CONTRATO  , 
GRSAP.NU_ORDEM_VENDA  , 
GRSAP.IC_SEM_ORDEM_VENDA  , 
GRSAP.DS_STATUS_CONTRATO_SAP  , 
GRSAP.CD_CLIENTE  , 
GRSAP.NO_CLIENTE  , 
GRSAP.COOPERADO  , 
GRSAP.CD_INCOTERMS  , 
GRSAP.CD_SALES_DISTRICT  , 
GRSAP.CD_SALES_OFFICE  , 
GRSAP.NO_SALES_OFFICE  , 
GRSAP.CD_SALES_GROUP  , 
GRSAP.NO_SALES_GROUP  , 
GRSAP.CD_AGENTE_VENDA  , 
GRSAP.NO_AGENTE  , 
GRSAP.DH_VENCIMENTO_PEDIDO  , 
GRSAP.DT_CREDITO  , 
GRSAP.DT_INICIO  , 
GRSAP.DT_FIM  , 
GRSAP.DH_INCLUSAO  , 
GRSAP.DH_ENTREGA  , 
GRSAP.SG_ESTADO  , 
GRSAP.NO_MUNICIPIO  , 
GRSAP.DS_BAIRRO  , 
GRSAP.CD_PRODUTO_SAP  , 
GRSAP.NO_PRODUTO_SAP  , 
SUM(GRSAP.QT_PROGRAMADA) QT_PROGRAMADA , 
SUM(GRSAP.QT_ENTREGUE)  QT_ENTREGUE , 
SUM(GRSAP.QT_SALDO) QT_SALDO , 
SUM(GRSAP.QT_SALDO_PROGRAMADA) QT_SALDO_PROGRAMADA , 
GRSAP.LIST_OF_NR_PROTOCOLO  , 
SUM(GRSAP.SALDO_ORDEM_VENDA_PROTOCOLO) SALDO_ORDEM_VENDA_PROTOCOLO , 
SUM(GRSAP.VL_UNITARIO) VL_UNITARIO , 
SUM(GRSAP.VL_BRL)  VL_BRL, 
SUM(GRSAP.VL_TAXA_DOLAR) VL_TAXA_DOLAR, 
SUM(GRSAP.VL_USD) VL_USD ,
GRSAP.PC_COMISSAO ,
GRSAP.CD_SACARIA ,
GRSAP.DS_SACARIA ,
GRSAP.CD_CULTURA_SAP ,
GRSAP.DS_CULTURA_SAP ,
GRSAP.CD_BLOQUEIO_REMESSA ,
GRSAP.CD_BLOQUEIO_FATURAMENTO ,
GRSAP.CD_BLOQUEIO_CREDITO , 
GRSAP.CD_BLOQUEIO_REMESSA_ITEM ,
GRSAP.CD_BLOQUEIO_FATURAMENTO_ITEM ,
GRSAP.CD_MOTIVO_RECUSA ,
GRSAP.CD_LOGIN ,
GRSAP.CD_SEGMENTACAO_CLIENTE ,
GRSAP.DS_SEGMENTACAO_CLIENTE ,
GRSAP.DS_SEGMENTO_CLIENTE_SAP ,
GRSAP.CD_FORMA_PAGAMENTO ,
GRSAP.CD_TIPO_PAGAMENTO , 
GRSAP.DS_TIPO_PAGAMENTO ,
GRSAP.CD_AGRUPAMENTO ,
GRSAP.CD_BLOQUEIO_ENTREGA ,
GRSAP.NU_CNPJ ,
GRSAP.NU_CPF ,
GRSAP.NU_INSCRICAO_ESTADUAL ,
GRSAP.NU_INSCRICAO_MUNICIPAL ,
GRSAP.NU_CEP ,
GRSAP.DS_ENDERECO , 
GRSAP.CD_CLIENTE_RECEBEDOR ,
GRSAP.NO_CLIENTE_RECEBEDOR ,
GRSAP.CD_MOEDA ,
GRSAP.CD_SUPPLY_GROUP ,
GRSAP.DS_VENDA_COMPARTILHADA ,
GRSAP.CD_STATUS_LIBERACAO ,
GRSAP.CD_ITEM_PEDIDO ,
GRSAP.CD_CLIENTE_PAGADOR ,
GRSAP.NO_CLIENTE_PAGADOR,
GRSAP.IC_RELACIONAMENTO,
GRSAP.CD_PRIORIDADE,
GRSAP.NU_ORDEM,
SUM(GRSAP.QT_AGENDADA) QT_AGENDADA,
SUM(GRSAP.QT_AGENDADA_FABRICA) QT_AGENDADA_FABRICA,
SUM(GRSAP.QT_AGENDADA_SAP) QT_AGENDADA_SAP,
GRSAP.CD_USUARIO_REFRESH,
GRSAP.DH_REFRESH,
SUM(GRSAP.QT_PROGRAMADA_REFRESH) QT_PROGRAMADA_REFRESH,
SUM(GRSAP.QT_ENTREGUE_REFRESH) QT_ENTREGUE_REFRESH,
SUM(GRSAP.QT_SALDO_REFRESH) QT_SALDO_REFRESH,
SUM(GRSAP.QT_AGENDADA_CONFIRMADA) QT_AGENDADA_CONFIRMADA,
GRSAP.CD_TIPO_AGENDAMENTO,
GRSAP.DS_STATUS_TIPO_AGENDAMENTO,
GRSAP.CD_TIPO_REPLAN,
GRSAP.CD_BLOQUEIO_REMESSA_R,
GRSAP.CD_BLOQUEIO_FATURAMENTO_R,
GRSAP.CD_BLOQUEIO_CREDITO_R,
GRSAP.CD_BLOQUEIO_REMESSA_ITEM_R,
GRSAP.CD_BLOQUEIO_FATURAMENTO_ITEM_R,
GRSAP.DS_OBSERVACAO_ADVEN,
GRSAP.IC_PERMITIR_CS,
GRSAP.DH_LIBERACAO_TORRE_FRETES,
GRSAP.DH_MODIFICACAO_TORRE_FRETES,
GRSAP.DH_CONTRATACAO_TORRE_FRETES,
GRSAP.CD_ELO_FREIGHT_TOWER_REASON,
GRSAP.IC_NAO_LIBERADA_SEM_PROTOCOLO,
GRSAP.IC_ENTREGA_CADENCIADA_CLIENTE,
GRSAP.IC_DIFICULDADE_CONTRATACAO,
GRSAP.IC_OUTROS,
GRSAP.CD_STATUS_CUSTOMER_SERVICE,
GRSAP.DS_STATUS_CUSTOMER_SERVICE,
GRSAP.SG_STATUS_CUSTOMER_SERVICE,
GRSAP.CD_STATUS_TORRE_FRETES,
GRSAP.DS_STATUS_TORRE_FRETES,
GRSAP.SG_STATUS_TORRE_FRETES,
GRSAP.CD_STATUS_CONTROLADORIA,
GRSAP.SG_STATUS_CONTROLADORIA,
GRSAP.IC_ATIVO,
GRSAP.CD_GRUPO_EMBALAGEM,
GRSAP.DS_CREDIT_BLOCK_REASON,
GRSAP.DH_CREDIT_BLOCK, 
GRSAP.SG_DESTINO_BACKLOG_CIF,
GRSAP.CD_STATUS_BACKLOG_CIF,
GRSAP.SG_STATUS_BACKLOG_CIF,
SUM(GRSAP.QT_AGENDADA_ANTERIOR) QT_AGENDADA_ANTERIOR,
GRSAP.DH_BACKLOG_CIF,
SUM(GRSAP.QT_BACKLOG_CIF) QT_BACKLOG_CIF,
GRSAP.CD_ELO_AGENDAMENTO,
SUM(GRSAP.QT_AGENDADA_REFRESH) QT_AGENDADA_REFRESH,
GRSAP.CD_USUARIO_FABRICA,
GRSAP.DH_FABRICA,
GRSAP.CD_USUARIO_CORTADO_FABRICA, 
GRSAP.DH_CORTADO_FABRICA,
GRSAP.CD_USUARIO_AJUSTE_SAP,
GRSAP.DH_AJUSTE_SAP,
GRSAP.CD_ITEM_CONTRATO,
GRSAP.CD_STATUS_LOGISTICA,
GRSAP.SG_STATUS_LOGISTICA,
GRSAP.IC_CORTADO_FABRICA,
GRSAP.IC_COOPERATIVE,
GRSAP.TIPO_PROCESSO_VENDAS,
GRSAP.IC_SPLIT,
GRSAP.IC_EMERGENCIAL,
SUM(GRSAP.QT_EMERGENCIAL) QT_EMERGENCIAL,
GRSAP.DS_ROTEIRO_ENTREGA,
GRSAP.CD_ELO_PRIORITY_OPTION,
SUM(GRSAP.QT_AJUSTADA_FABRICA) QT_AJUSTADA_FABRICA,
SUM(GRSAP.QT_AJUSTADA_SAP) QT_AJUSTADA_SAP,
GRSAP.IC_FA,
GRSAP.DESTINO,
GRSAP.VL_FRETE_DISTRIBUICAO,
GRSAP.LIST_OF_NO_TRANSPORTADORA,
GRSAP.CD_ELO_CARTEIRA_TORRE_FRETES,
GRSAP.CD_TRANSPORTADORA,
GRSAP.NO_TRANSPORTADORA,
GRSAP.NU_SEMANA,
GRSAP.NU_DIA_SEMANA,
SUM(GRSAP.NU_QUANTIDADE) NU_QUANTIDADE,
GRSAP.VL_FRETE_CONTRATADO VL_FRETE_CONTRATADO,
SUM(GRSAP.VL_FRETE_CONTRATADO_CTF) VL_FRETE_CONTRATADO_CTF,
SUM(GRSAP.NU_QUANTIDADE_TOTAL_CTF) NU_QUANTIDADE_TOTAL_CTF,
GRSAP.DS_OBSERVACAO_TORRE_FRETES , 
GRSAP.CD_DIA_EXATO,
GRSAP.DS_FREIGHT_TOWER_REASON,
GRSAP.DS_COLOR,
GRSAP.CD_DEPARTAMENTO,
GRSAP.CTF_SEG ,
GRSAP.CTF_TER ,
GRSAP.CTF_QUA ,
GRSAP.CTF_QUI ,
GRSAP.CTF_SEX,
GRSAP.CTF_SAB ,
GRSAP.CTF_DOM ,
SUM(GRSAP.CTF_NUQ_SEG) CTF_NUQ_SEG,
SUM(GRSAP.CTF_NUQ_TER) CTF_NUQ_TER,
SUM(GRSAP.CTF_NUQ_QUA) CTF_NUQ_QUA,
SUM(GRSAP.CTF_NUQ_QUI) CTF_NUQ_QUI,
SUM(GRSAP.CTF_NUQ_SEX) CTF_NUQ_SEX,
SUM(GRSAP.CTF_NUQ_SAB) CTF_NUQ_SAB,
SUM(GRSAP.CTF_NUQ_DOM) CTF_NUQ_DOM,
SUM(GRSAP.NUQ_SEG) NUQ_SEG,
SUM(GRSAP.NUQ_TER) NUQ_TER,
SUM(GRSAP.NUQ_QUA) NUQ_QUA,
SUM(GRSAP.NUQ_QUI) NUQ_QUI,    
SUM(GRSAP.NUQ_SEX) NUQ_SEX,
SUM(GRSAP.NUQ_SAB) NUQ_SAB,    
SUM(GRSAP.NUQ_DOM) NUQ_DOM,       
GRSAP.NU_CARTEIRA_VERSION,
GRSAP.DH_LIMITE,
SUM(GRSAP.QT_OVERBOOKING_SUPERVISORES) QT_OVERBOOKING_SUPERVISORES,
SUM(GRSAP.QT_LIMITE_EMERGENCIAL) QT_LIMITE_EMERGENCIAL,
GRSAP.AG_CD_ELO_STATUS,
GRSAP.DS_STATUS,
GRSAP.SG_STATUS,
max(GRSAP.NU_SEMANAS) NU_SEMANAS,
GRSAP.CD_WEEK,
GRSAP.CD_POLO, 
GRSAP.CD_CENTRO_EXPEDIDOR,                     
GRSAP.CD_MACHINE,                
GRSAP.CD_ELO_AGENDAMENTO_SUPERVISOR,       
GRSAP.CD_PRODUTO_SAP_AG_ITEM,       
GRSAP.CD_COTA_COMPARTILHADA,   
GRSAP.IC_CORTADO_SEMANA_ANTERIOR, 
GRSAP.DS_OBSERVACAO_PARA_TF,
GRSAP.CD_INDICADOR_COMPOSICAO_CARGA, 
SUM(GRSAP.QT_MARCACAO_CARREGADO_FAT) QT_MARCACAO_CARREGADO_FAT, 
SUM(GRSAP.QT_MARCACAO_EM_CARREGAMENTO) QT_MARCACAO_EM_CARREGAMENTO, 
SUM(GRSAP.QT_MARCACAO_ANTECIPADO) QT_MARCACAO_ANTECIPADO,
SUM(GRSAP.QT_AGENDAMENTO_SOMA) QT_AGENDAMENTO_SOMA,
SUM(GRSAP.QT_MARCACAO_VOL_REAL) QT_MARCACAO_VOL_REAL,
SUM(GRSAP.QT_MARCACAO_VOL_REAL_PLANO) QT_MARCACAO_VOL_REAL_PLANO,
SUM(GRSAP.QT_MARCACAO_VOL_REAL_MENOR) QT_MARCACAO_VOL_REAL_MENOR,
GRSAP.COTA_NUQ_SEG,
GRSAP.COTA_NUQ_TER,
GRSAP.COTA_NUQ_QUA,
GRSAP.COTA_NUQ_QUI,
GRSAP.COTA_NUQ_SEX,
GRSAP.COTA_NUQ_SAB,
GRSAP.COTA_NUQ_DOM


FROM 
(


SELECT 
------------VND.ELO_CARTEIRA-------------

E_SEL.CD_ELO_CARTEIRA ,
E_SEL.CD_ELO_AGENDAMENTO_ITEM ,
E_SEL.DH_CARTEIRA ,
E_SEL.CD_SALES_ORG ,
E_SEL.NU_CONTRATO_SAP ,
E_SEL.CD_TIPO_CONTRATO ,
E_SEL.NU_CONTRATO_SUBSTITUI ,
NVL(E_SEL.DT_PAGO , L_DT_FROM_NULL) DT_PAGO,
NVL(E_SEL.NU_CONTRATO, 0) NU_CONTRATO ,
E_SEL.NU_ORDEM_VENDA ,
E_SEL.IC_SEM_ORDEM_VENDA ,
E_SEL.DS_STATUS_CONTRATO_SAP ,
CASE 
WHEN E_SEL.IC_COOPERATIVE = 'S' THEN E_CT.CD_CLIENTE_RECEBEDOR--'Revenda'
WHEN E_SEL.IC_COOPERATIVE = 'N' THEN E_CT.CD_CLIENTE--'Venda Direta'
END CD_CLIENTE,

CASE 
WHEN E_SEL.IC_COOPERATIVE = 'S' THEN E_CT.NO_CLIENTE_RECEBEDOR--'Revenda'
WHEN E_SEL.IC_COOPERATIVE = 'N' THEN E_CT.NO_CLIENTE--'Venda Direta'
END NO_CLIENTE,

CASE
WHEN E_SEL.IC_COOPERATIVE = 'S' THEN 
    GX_ELO_FREIGHTOWER.FX_GET_COOPERADO(E_SEL.CD_ELO_CARTEIRA_GROUPING  ) ELSE '***' END COOPERADO, 

E_SEL.CD_INCOTERMS ,
E_SEL.CD_SALES_DISTRICT ,
E_SEL.CD_SALES_OFFICE ,
NVL(E_SEL.CD_SALES_OFFICE, '-') || '-' || NVL(E_SEL.NO_SALES_OFFICE, '-') NO_SALES_OFFICE,
E_SEL.CD_SALES_GROUP ,
NVL(E_SEL.CD_SALES_GROUP, '-') ||'-' || NVL(E_SEL.NO_SALES_GROUP, '-') NO_SALES_GROUP,
E_SEL.CD_AGENTE_VENDA ,
E_SEL.NO_AGENTE ,
NVL(E_SEL.DH_VENCIMENTO_PEDIDO , L_DT_FROM_NULL) DH_VENCIMENTO_PEDIDO,
NVL(E_SEL.DT_CREDITO , L_DT_FROM_NULL ) DT_CREDITO,
NVL(E_SEL.DT_INICIO , L_DT_FROM_NULL) DT_INICIO,
NVL(E_SEL.DT_FIM ,L_DT_FROM_NULL) DT_FIM,
NVL(E_SEL.DH_INCLUSAO ,L_DT_FROM_NULL) DH_INCLUSAO,
NVL(E_SEL.DH_ENTREGA ,L_DT_FROM_NULL) DH_ENTREGA,
E_SEL.SG_ESTADO ,
E_SEL.NO_MUNICIPIO ,
E_SEL.DS_BAIRRO ,
E_SEL.CD_PRODUTO_SAP ,
E_SEL.NO_PRODUTO_SAP ,
NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) QT_PROGRAMADA,
NVL(E_CT.QT_ENTREGUE ,0) QT_ENTREGUE,
COALESCE( E_CT.QT_SALDO_REFRESH,E_CT.QT_SALDO, 0) QT_SALDO,

--NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) - 
--NVL(( SELECT 
--    SUM(E_CTFI.NU_QUANTIDADE) NU_QUANTIDADE
--    FROM CTE_CARTEIRA_FILTER EC_I
--    INNER JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTFI
--    ON EC_I.CD_ELO_CARTEIRA = E_CTFI.CD_ELO_CARTEIRA
--    WHERE E_CTFI.VL_FRETE_CONTRATADO > 0
--    AND EC_I.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
--    GROUP BY EC_I.CD_ELO_CARTEIRA),0)  QT_SALDO_PROGRAMADA,

NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) - 
NVL(( SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_SALDO_PROGRAMADA,

CASE
WHEN E_SEL.IC_COOPERATIVE = 'S' THEN 
    
    GX_ELO_FREIGHTOWER.FX_GET_NR_PROTOCOLO(E_SEL.CD_ELO_CARTEIRA_GROUPING)
    ELSE '***' END LIST_OF_NR_PROTOCOLO, 

CASE 
WHEN E_SEL.IC_COOPERATIVE = 'S' THEN --'Revenda'
--E_CT.QT_AGENDADA_PROTOCOLO

NVL((SELECT SUM(VBPROT.QT_AGENDADA_PROTOCOLO ) SOMM
           FROM VND.ELO_VBAK_PROTOCOLO VBPROT
           WHERE VBPROT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA),0)

--        NVL((SELECT 
--        SUM(NVL(CPT_ENT.QT_QUANTIDADE,0) - NVL(CPT_ENT.QT_FORNECIDO,0)) SALDO
--        FROM CTE_CARTEIRA_FILTER EC_I
--        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
--        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--
--        INNER JOIN CTE_ELO_AGENDAMENTO CTE_AGE  --FILTER INCLUSIVE REPLAN
--        ON 
--        CTE_AGE.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO        
--
--		INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
--        ON 
--        EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--        AND EA_SUP_I.IC_ATIVO = 'S'
--
--		INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
--
--        ON 
--		EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
--        AND EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EC_I.CD_ELO_AGENDAMENTO_ITEM
--        AND EAG_ITEM_I.IC_ATIVO = 'S'	
--
--		INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
--        ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
--
--		INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
--        ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
--        AND EAG_GRO_I.SG_TIPO_DOCUMENTO = 'P'
--
--		INNER JOIN CPT.ENTREGA CPT_ENT
--        ON CPT_ENT.NU_PROTOCOLO_ENTREGA = EAG_GRO_I.NU_DOCUMENTO
--
--		INNER JOIN CPT.AUTORIZACAO_ENTREGA CPT_AUT_ENT 
--        ON CPT_AUT_ENT.CD_AUTORIZACAO_ENTREGA = CPT_ENT.CD_AUTORIZACAO_ENTREGA
--
--		WHERE 
--        EC_I.CD_ELO_AGENDAMENTO = E_CT.CD_ELO_AGENDAMENTO
--        AND EC_I.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
--        GROUP BY EC_I.CD_ELO_AGENDAMENTO),0)
WHEN E_SEL.IC_COOPERATIVE = 'N' THEN COALESCE( E_CT.QT_SALDO_REFRESH,E_CT.QT_SALDO, 0)
ELSE 0 
END SALDO_ORDEM_VENDA_PROTOCOLO, 

NVL(E_SEL.VL_UNITARIO,0) VL_UNITARIO ,
NVL(E_SEL.VL_BRL ,0) VL_BRL,
NVL(E_SEL.VL_TAXA_DOLAR ,0) VL_TAXA_DOLAR,
NVL(E_SEL.VL_USD ,0) VL_USD,
NVL(E_SEL.PC_COMISSAO ,0) PC_COMISSAO,
E_SEL.CD_SACARIA ,
E_SEL.DS_SACARIA ,
E_SEL.CD_CULTURA_SAP ,
E_SEL.DS_CULTURA_SAP ,
E_SEL.CD_BLOQUEIO_REMESSA ,
E_SEL.CD_BLOQUEIO_FATURAMENTO ,
E_SEL.CD_BLOQUEIO_CREDITO ,
E_SEL.CD_BLOQUEIO_REMESSA_ITEM ,
E_SEL.CD_BLOQUEIO_FATURAMENTO_ITEM ,
E_SEL.CD_MOTIVO_RECUSA ,
E_SEL.CD_LOGIN ,
E_SEL.CD_SEGMENTACAO_CLIENTE ,
E_SEL.DS_SEGMENTACAO_CLIENTE ,
E_SEL.DS_SEGMENTO_CLIENTE_SAP ,
E_SEL.CD_FORMA_PAGAMENTO ,
E_SEL.CD_TIPO_PAGAMENTO ,
E_SEL.DS_TIPO_PAGAMENTO ,
E_SEL.CD_AGRUPAMENTO ,
E_SEL.CD_BLOQUEIO_ENTREGA ,
E_SEL.NU_CNPJ ,
E_SEL.NU_CPF ,
E_SEL.NU_INSCRICAO_ESTADUAL ,
E_SEL.NU_INSCRICAO_MUNICIPAL ,
E_SEL.NU_CEP ,
E_SEL.DS_ENDERECO_RECEBEDOR DS_ENDERECO ,
E_SEL.CD_CLIENTE_RECEBEDOR ,
E_SEL.NO_CLIENTE_RECEBEDOR ,
E_SEL.CD_MOEDA ,
E_SEL.CD_SUPPLY_GROUP ,
E_SEL.DS_VENDA_COMPARTILHADA ,
E_SEL.CD_STATUS_LIBERACAO ,
NVL(E_SEL.CD_ITEM_PEDIDO ,0) CD_ITEM_PEDIDO,
E_SEL.CD_CLIENTE_PAGADOR ,
E_SEL.NO_CLIENTE_PAGADOR ,
E_SEL.IC_RELACIONAMENTO ,
E_SEL.CD_ELO_PRIORITY_OPTION CD_PRIORIDADE,
NVL(E_SEL.NU_ORDEM ,0) NU_ORDEM,
NVL(E_CT.QT_AGENDADA ,0) QT_AGENDADA,
NVL(E_CT.QT_AGENDADA_FABRICA ,0) QT_AGENDADA_FABRICA,
NVL(E_CT.QT_AGENDADA_SAP , 0 ) QT_AGENDADA_SAP,
NVL(E_SEL.CD_USUARIO_REFRESH , 0) CD_USUARIO_REFRESH,
NVL(E_SEL.DH_REFRESH , L_DT_FROM_NULL) DH_REFRESH,  
NVL(E_CT.QT_PROGRAMADA_REFRESH ,0) QT_PROGRAMADA_REFRESH,
NVL(E_CT.QT_ENTREGUE_REFRESH ,0) QT_ENTREGUE_REFRESH ,
NVL(E_CT.QT_SALDO_REFRESH ,0) QT_SALDO_REFRESH,
NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) QT_AGENDADA_CONFIRMADA,

NVL(E_SEL.CD_TIPO_AGENDAMENTO ,0) CD_TIPO_AGENDAMENTO,   --MAS CONHECIDO COMO PLAN E REPLAN
CASE 
WHEN NVL(E_ST_PL_RE.SG_STATUS, 'ORIGINAL')  IN ('ORIGINAL', 'INCLUSAO', 'PLAN') THEN 'PLAN'
WHEN E_ST_PL_RE.SG_STATUS = 'REPLAN' THEN 'REPLAN' ELSE 'PLAN' END DS_STATUS_TIPO_AGENDAMENTO,


NVL(E_SEL.CD_TIPO_REPLAN ,0 ) CD_TIPO_REPLAN,
E_SEL.CD_BLOQUEIO_REMESSA_R ,
E_SEL.CD_BLOQUEIO_FATURAMENTO_R ,
E_SEL.CD_BLOQUEIO_CREDITO_R ,
E_SEL.CD_BLOQUEIO_REMESSA_ITEM_R ,
E_SEL.CD_BLOQUEIO_FATURAMENTO_ITEM_R ,
'dtw=' || to_char(E_AG.DT_WEEK_START, 'YYYY-MM-DD HH:MM') || ';wy=' || to_char(E_AG.DT_WEEK_START, 'YYYYWW') || ';iw=' || to_char(E_AG.DT_WEEK_START, 'YYYYIW') 
|| ';qtct=' || TO_CHAR((SELECT COUNT(1) FROM CTE_CARTEIRA_FILTER CT WHERE CT.CD_ELO_CARTEIRA IS NOT NULL ))
|| ';qtag=' || TO_CHAR((SELECT COUNT(DISTINCT AGR.CD_ELO_AGENDAMENTO) FROM CTE_ELO_AGENDAMENTO AGR WHERE AGR.CD_ELO_AGENDAMENTO IS NOT NULL ))
|| (				
    SELECT 	
    ';stag=' ||I_ST_AGENC.SG_STATUS || ',tp_week=' ||
    CASE WHEN I_ST_AGENC.SG_STATUS = 'AGENC' THEN 'CLOSED'
    WHEN I_ST_AGENC.SG_STATUS IS NULL THEN 'READONLY' ELSE 'WRITABLE' END 
    FROM VND.ELO_STATUS I_ST_AGENC
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_AG
    ON I_ST_AGENC.CD_ELO_TIPO_STATUS = I_ST_TIPO_AG.CD_ELO_TIPO_STATUS
    AND I_ST_TIPO_AG.SG_TIPO_STATUS  = 'AGEND'				
    WHERE E_AG.CD_ELO_STATUS =  I_ST_AGENC.CD_ELO_STATUS
    AND ROWNUM = 1
    )  || ';agid=' || TO_CHAR(CTE_AG.CD_ELO_AGENDAMENTO) || '-' || TO_CHAR(E_FILTER.CD_ELO_AGENDAMENTO_ITEM)
    || ';agcc=' || (COALESCE((SELECT AGG.CD_CENTRO_EXPEDIDOR 
                        FROM VND.ELO_AGENDAMENTO_CENTRO_MACHINE AGG 
                        WHERE AGG.CD_ELO_AGENDAMENTO = E_AG.CD_ELO_AGENDAMENTO
                        AND AGG.CD_MACHINE = E_AG.CD_MACHINE AND ROWNUM =1), E_AG.CD_CENTRO_EXPEDIDOR, 'CCNF'))
    || ';sysdate=' ||    to_char(sysdate, 'YYYY-MM-DD HH:MM')                 

DS_OBSERVACAO_ADVEN ,

DECODE( E_SEL.IC_PERMITIR_CS, 'S', 'S', 'N') IC_PERMITIR_CS,

NVL(E_SEL.DH_LIBERACAO_TORRE_FRETES , L_DT_FROM_NULL) DH_LIBERACAO_TORRE_FRETES,
NVL(E_SEL.DH_MODIFICACAO_TORRE_FRETES , L_DT_FROM_NULL) DH_MODIFICACAO_TORRE_FRETES,
NVL(E_SEL.DH_CONTRATACAO_TORRE_FRETES , L_DT_FROM_NULL) DH_CONTRATACAO_TORRE_FRETES,
NVL(E_SEL.CD_ELO_FREIGHT_TOWER_REASON ,0) CD_ELO_FREIGHT_TOWER_REASON,

DECODE( E_SEL.IC_NAO_LIBERADA_SEM_PROTOCOLO, 'S', 'S', 'N') IC_NAO_LIBERADA_SEM_PROTOCOLO,
DECODE( E_SEL.IC_ENTREGA_CADENCIADA_CLIENTE, 'S', 'S', 'N') IC_ENTREGA_CADENCIADA_CLIENTE,
DECODE( E_SEL.IC_DIFICULDADE_CONTRATACAO, 'S', 'S', 'N') IC_DIFICULDADE_CONTRATACAO,
DECODE( E_SEL.IC_OUTROS, 'S', 'S', 'N') IC_OUTROS,


NVL(E_SEL.CD_STATUS_CUSTOMER_SERVICE ,0) CD_STATUS_CUSTOMER_SERVICE,

NVL((SELECT IST_CS.DS_STATUS 
FROM VND.ELO_STATUS IST_CS 
WHERE IST_CS.CD_ELO_STATUS = E_SEL.CD_STATUS_CUSTOMER_SERVICE 
AND ROWNUM=1) , 'Novo') DS_STATUS_CUSTOMER_SERVICE,
NVL((SELECT I_ST_CS.SG_STATUS 
FROM VND.ELO_STATUS I_ST_CS 
WHERE I_ST_CS.CD_ELO_STATUS = E_SEL.CD_STATUS_CUSTOMER_SERVICE 
AND  ROWNUM=1), 'Novo') SG_STATUS_CUSTOMER_SERVICE ,

NVL( E_SEL.CD_STATUS_TORRE_FRETES,0) CD_STATUS_TORRE_FRETES,
NVL((SELECT I_ST_CTF.DS_STATUS 
FROM VND.ELO_STATUS I_ST_CTF 
WHERE I_ST_CTF.CD_ELO_STATUS = E_SEL.CD_STATUS_TORRE_FRETES 
AND ROWNUM=1), 'Novo') DS_STATUS_TORRE_FRETES ,
NVL((SELECT I_ST_CTF.SG_STATUS 
FROM VND.ELO_STATUS I_ST_CTF 
WHERE I_ST_CTF.CD_ELO_STATUS = E_SEL.CD_STATUS_TORRE_FRETES 
AND ROWNUM=1), 'Novo') SG_STATUS_TORRE_FRETES,

NVL(E_SEL.CD_STATUS_CONTROLADORIA, 0) CD_STATUS_CONTROLADORIA,
NVL(E_ST_CONTR.DS_STATUS, 'Novo') SG_STATUS_CONTROLADORIA ,
E_SEL.IC_ATIVO ,
E_SEL.CD_GRUPO_EMBALAGEM || '-' || EMBL.DS_GRUPO_EMBALAGEM CD_GRUPO_EMBALAGEM,

E_SEL.DS_CREDIT_BLOCK_REASON ,
NVL(E_SEL.DH_CREDIT_BLOCK , L_DT_FROM_NULL) DH_CREDIT_BLOCK , 

E_SEL.SG_DESTINO_BACKLOG_CIF ,
0 CD_STATUS_BACKLOG_CIF,
'*' SG_STATUS_BACKLOG_CIF ,
NVL(E_CT.QT_AGENDADA_ANTERIOR ,0) QT_AGENDADA_ANTERIOR,
E_SEL.DH_BACKLOG_CIF ,
NVL(E_CT.QT_BACKLOG_CIF ,0) QT_BACKLOG_CIF,
NVL(E_SEL.CD_ELO_AGENDAMENTO ,0) CD_ELO_AGENDAMENTO,
NVL(E_CT.QT_AGENDADA_REFRESH ,0) QT_AGENDADA_REFRESH,
NVL(E_SEL.CD_USUARIO_FABRICA ,0) CD_USUARIO_FABRICA,
NVL(E_SEL.DH_FABRICA , L_DT_FROM_NULL) DH_FABRICA,
NVL(E_SEL.CD_USUARIO_CORTADO_FABRICA ,0) CD_USUARIO_CORTADO_FABRICA, 
NVL(E_SEL.DH_CORTADO_FABRICA ,L_DT_FROM_NULL) DH_CORTADO_FABRICA,
NVL(E_SEL.CD_USUARIO_AJUSTE_SAP , 0) CD_USUARIO_AJUSTE_SAP,
NVL(E_SEL.DH_AJUSTE_SAP , L_DT_FROM_NULL) DH_AJUSTE_SAP,
NVL(E_SEL.CD_ITEM_CONTRATO ,0) CD_ITEM_CONTRATO,
0 CD_STATUS_LOGISTICA,
'' SG_STATUS_LOGISTICA ,
E_SEL.IC_CORTADO_FABRICA ,
E_SEL.IC_COOPERATIVE ,
CASE 
WHEN E_SEL.IC_COOPERATIVE = 'S' THEN 'Revenda'
WHEN E_SEL.IC_COOPERATIVE = 'N' THEN 'Venda Direta'
END TIPO_PROCESSO_VENDAS,
E_SEL.IC_SPLIT ,

DECODE( E_SEL.IC_EMERGENCIAL, 'S', 'S', 'N') IC_EMERGENCIAL,
NVL(E_CT.QT_EMERGENCIAL , 0 ) QT_EMERGENCIAL,


E_SEL.DS_ROTEIRO_ENTREGA ,
NVL(E_SEL.CD_ELO_PRIORITY_OPTION ,0) CD_ELO_PRIORITY_OPTION,
NVL(E_CT.QT_AJUSTADA_FABRICA ,0) QT_AJUSTADA_FABRICA,
NVL(E_CT.QT_AJUSTADA_SAP ,0) QT_AJUSTADA_SAP,
E_SEL.IC_FA ,

NVL(E_SEL.NO_MUNICIPIO, '') || '-' || NVL(E_SEL.SG_ESTADO, '') DESTINO,

NVL(E_SEL.VL_FRETE_DISTRIBUICAO,0) VL_FRETE_DISTRIBUICAO,

-----------VND.ELO_CARTEIRA_TORRE_FRETES---------

NVL(GX_ELO_FREIGHTOWER.FX_GET_TF_TRANSPORTADORAS(E_SEL.CD_ELO_CARTEIRA  ),  '***') LIST_OF_NO_TRANSPORTADORA,

0 CD_ELO_CARTEIRA_TORRE_FRETES,
0 CD_TRANSPORTADORA,
'****' NO_TRANSPORTADORA,
0 NU_SEMANA,
0 NU_DIA_SEMANA,
0 NU_QUANTIDADE,
0 VL_FRETE_CONTRATADO,


NVL((
   SELECT 
    ROUND((SUM(NVL(E_CTFI.VL_FRETE_CONTRATADO,0) * NVL(E_CTFI.NU_QUANTIDADE,0)) / (SUM(E_CTFI.NU_QUANTIDADE))),4) VL_FRETE_CONTRATADO_CTF
    FROM CTE_CARTEIRA_FILTER EC_I
    INNER JOIN CTE_ELO_AGENDAMENTO EAG_I
    ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTFI
    ON EC_I.CD_ELO_CARTEIRA = E_CTFI.CD_ELO_CARTEIRA
    WHERE E_CTFI.VL_FRETE_CONTRATADO > 0
    AND E_CTFI.NU_QUANTIDADE > 0
    AND EC_I.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
    --AND E_CTF.CD_ELO_CARTEIRA_TORRE_FRETES = E_CTFI.CD_ELO_CARTEIRA_TORRE_FRETES
    GROUP BY EC_I.CD_ELO_CARTEIRA
    HAVING COUNT(E_CTFI.CD_TRANSPORTADORA) > 0

),0) VL_FRETE_CONTRATADO_CTF,

NVL((
   SELECT 
    ROUND(SUM(E_CTFI.NU_QUANTIDADE),4) NU_QUANTIDADE_TOTAL_CTF
    FROM CTE_CARTEIRA_FILTER EC_I
     INNER JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTFI
    ON EC_I.CD_ELO_CARTEIRA = E_CTFI.CD_ELO_CARTEIRA
    WHERE E_CTFI.VL_FRETE_CONTRATADO > 0
    AND EC_I.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
    GROUP BY EC_I.CD_ELO_CARTEIRA
    HAVING COUNT(E_CTFI.CD_TRANSPORTADORA) > 0

),0) NU_QUANTIDADE_TOTAL_CTF,
/*
CASE 
WHEN E_SEL.DS_OBSERVACAO_TORRE_FRETES IS NULL THEN 
(SELECT 'St Cell: ' || STERE.DS_STATUS 
FROM VND.ELO_STATUS STERE 
WHERE STERE.CD_ELO_STATUS = E_SEL.CD_STATUS_CEL_FINAL) || ' St Ag:' ||  E_ST_AG.DS_STATUS
ELSE E_SEL.DS_OBSERVACAO_TORRE_FRETES END DS_OBSERVACAO_TORRE_FRETES , 
*/
E_SEL.DS_OBSERVACAO_TORRE_FRETES,
'N'  CD_DIA_EXATO,

---------VND.ELO_FREIGHT_TOWER_REASON E_FTR--------------


E_FTR.DS_FREIGHT_TOWER_REASON,
E_FTR.DS_COLOR,
NVL(E_FTR.CD_DEPARTAMENTO, 0) CD_DEPARTAMENTO,


---------- CONTRATACAO TORRES FRETES DIA EXATO----------
'N'  CTF_SEG,
'N' CTF_TER,
'N' CTF_QUA,
'N' CTF_QUI,
'N' CTF_SEX,
'N' CTF_SAB,
'N'  CTF_DOM,
---------

0 CTF_NUQ_SEG,
0 CTF_NUQ_TER,
0 CTF_NUQ_QUA,
0 CTF_NUQ_QUI,
0 CTF_NUQ_SEX,
0 CTF_NUQ_SAB,
0 CTF_NUQ_DOM,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 1 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SEG,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 2 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_TER,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 3
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_QUA,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 4 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_QUI,    

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 5 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SEX,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 6 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SAB,    

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 7 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_DOM,       

--------VND.ELO_AGENDAMENTO E_AG----------

E_AG.NU_CARTEIRA_VERSION ,
NVL(E_AG.DH_LIMITE ,L_DT_FROM_NULL ) DH_LIMITE,
NVL(E_AG.QT_OVERBOOKING_SUPERVISORES ,0) QT_OVERBOOKING_SUPERVISORES,
NVL(E_AG.QT_LIMITE_EMERGENCIAL,0) QT_LIMITE_EMERGENCIAL,
E_AG.CD_ELO_STATUS AG_CD_ELO_STATUS ,
E_ST_AG.DS_STATUS,
E_ST_AG.SG_STATUS,

NVL(E_AG.NU_SEMANAS ,0) NU_SEMANAS,
E_AG.CD_WEEK,
E_AG.CD_POLO, 
NVL(E_AG.CD_CENTRO_EXPEDIDOR, E_CT.CD_CENTRO_EXPEDIDOR) CD_CENTRO_EXPEDIDOR,                     
E_AG.CD_MACHINE,                
------------DESC VND.ELO_AGENDAMENTO_ITEM E_AG_ITEM---

E_AG_ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR,       
E_AG_ITEM.CD_PRODUTO_SAP CD_PRODUTO_SAP_AG_ITEM,       

E_AG_ITEM.CD_COTA_COMPARTILHADA,   
E_AG_ITEM.IC_CORTADO_SEMANA_ANTERIOR , 

NVL( E_AG_ITEM.DS_OBSERVACAO_TORRE_FRETES, '...') || 
NVL((SELECT ' St Cell: ' || STERE.DS_STATUS 
FROM VND.ELO_STATUS STERE 
WHERE STERE.CD_ELO_STATUS = E_SEL.CD_STATUS_CEL_FINAL), 'St Cell: ***') || ' St Ag:' ||  E_ST_AG.DS_STATUS
DS_OBSERVACAO_PARA_TF , 

--E_AG_ITEM.DS_OBSERVACAO_TORRE_FRETES DS_OBSERVACAO_PARA_TF,


/* '...' || 
(SELECT ' St Cell: ' || STERE.DS_STATUS 
FROM VND.ELO_STATUS STERE 
WHERE STERE.CD_ELO_STATUS = E_SEL.CD_STATUS_CEL_FINAL) || ' St Ag:' ||  E_ST_AG.DS_STATUS
|| 'ID: ' ||
*/
(   SELECT 
    MAX(EAG_GRO_I.CD_AGRUPAMENTO_PROTOCOLO) CD_AGRUPAMENTO_PROTOCOLO 

    FROM CTE_CARTEIRA_FILTER EC_I

    INNER JOIN VND.ELO_AGENDAMENTO EAG_I
    ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
    ON 
    EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    AND EA_SUP_I.IC_ATIVO = 'S'
    INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
    ON 
    EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
    AND EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EC_I.CD_ELO_AGENDAMENTO_ITEM
    AND EAG_ITEM_I.IC_ATIVO = 'S'	
    INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
    ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
    INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
    ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
    --AND EAG_GRO_I.SG_TIPO_DOCUMENTO = 'P'

    WHERE 
    EC_I.CD_ELO_AGENDAMENTO = E_CT.CD_ELO_AGENDAMENTO
    AND EC_I.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
    AND EAG_GRO_I.CD_AGRUPAMENTO_PROTOCOLO IS NOT NULL
    GROUP BY EC_I.CD_ELO_AGENDAMENTO, EC_I.CD_ELO_AGENDAMENTO_ITEM
) CD_INDICADOR_COMPOSICAO_CARGA, 


NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0) QT_MARCACAO_CARREGADO_FAT,  --CHANGE BY PAULO 2018.01.18 BY ADRIANO QT_MARCACAO_EM_CARREGAMENTO

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0) QT_MARCACAO_EM_CARREGAMENTO, --CHANGE BY PAULO 2018.01.18 BY ADRIANO QT_MARCACAO_CARREGADO_FAT


NVL((SELECT REG_ATE.QT_REGRA_ANTECIPADO 
    FROM CTE_APPLY_ANTECIPADO REG_ATE
    WHERE 
    REG_ATE.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
    AND REG_ATE.IS_SHOW_ANTECIPADO = 1) ,0) QT_MARCACAO_ANTECIPADO,


NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CART
    ON
    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    E_CT.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG'
    GROUP BY E_CART.CD_ELO_CARTEIRA),0)  QT_AGENDAMENTO_SOMA,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO_VOL_REAL,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CART
    ON
    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    E_CT.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND E_MAR.DH_SAIDA IS NOT NULL
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG'
    GROUP BY E_CART.CD_ELO_CARTEIRA),0)   QT_MARCACAO_VOL_REAL_PLANO,

(NVL(E_CT.QT_AGENDADA_CONFIRMADA, 0)  -

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)
) QT_MARCACAO_VOL_REAL_MENOR,


(SELECT SOC.COTA_NUQ_SEG FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_SEG,
(SELECT SOC.COTA_NUQ_TER FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_TER,
(SELECT SOC.COTA_NUQ_QUA FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_QUA,
(SELECT SOC.COTA_NUQ_QUI FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_QUI,
(SELECT SOC.COTA_NUQ_SEX FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_SEX,
(SELECT SOC.COTA_NUQ_SAB FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_SAB,
(SELECT SOC.COTA_NUQ_DOM FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_DOM

FROM  VND.VW_ELO_CARTEIRA_ALL E_CT
INNER JOIN CTE_CARTEIRA_FILTER E_FILTER
ON E_CT.CD_ELO_CARTEIRA = E_FILTER.CD_ELO_CARTEIRA

--- TO ADD GROUP BY AND FILTER BY  CARTEIRA GROUP´S RANGE  
INNER JOIN VND.ELO_CARTEIRA_GROUPING WGRP    --HERE FILTER BY CARTEIRA GROUPING
ON E_CT.CD_ELO_CARTEIRA_GROUPING = WGRP.CD_ELO_CARTEIRA_GROUPING
INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_SEL  -- HERE CHOOSE CARTEIRA 
ON WGRP.CD_ELO_CARTEIRA = E_SEL.CD_ELO_CARTEIRA
--- TO ADD GROUP BY AND FILTER BY  CARTEIRA GROUP´S RANGE

LEFT JOIN VND.ELO_FREIGHT_TOWER_REASON E_FTR
ON
E_CT.CD_ELO_FREIGHT_TOWER_REASON = E_FTR.CD_ELO_FREIGHT_TOWER_REASON
INNER JOIN VND.ELO_AGENDAMENTO E_AG
ON 
E_CT.CD_ELO_AGENDAMENTO = E_AG.CD_ELO_AGENDAMENTO

INNER JOIN CTE_ELO_AGENDAMENTO CTE_AG
ON
E_AG.CD_ELO_AGENDAMENTO = CTE_AG.CD_ELO_AGENDAMENTO


INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR E_A_SUP  --INSERIR LINHAS
ON
E_A_SUP.CD_ELO_AGENDAMENTO = E_AG.CD_ELO_AGENDAMENTO
AND E_A_SUP.IC_ATIVO = 'S'

INNER JOIN VND.ELO_AGENDAMENTO_ITEM E_AG_ITEM
ON
E_AG_ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = E_A_SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
AND E_AG_ITEM.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
AND E_AG_ITEM.IC_ATIVO = 'S'
--WHERE E_CT.CD_ELO_CARTEIRA = 100000000
LEFT JOIN VND.ELO_STATUS E_ST_AG
ON 
E_AG.CD_ELO_STATUS = E_ST_AG.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_ECT_LOG
ON 
E_CT.CD_STATUS_LOGISTICA = E_ST_ECT_LOG.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_BLC
ON 
E_CT.CD_STATUS_BACKLOG_CIF = E_ST_BLC.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_CONTR
ON
E_CT.CD_STATUS_CONTROLADORIA =  E_ST_CONTR.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_CTF
ON
E_CT.CD_STATUS_TORRE_FRETES =  E_ST_CTF.CD_ELO_STATUS
 

AND E_ST_CTF.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')  -- STATUS CARTEIRA TORRE FRETES 
INNER JOIN VND.ELO_STATUS E_ST_CS
ON
E_CT.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS 

LEFT JOIN VND.ELO_STATUS E_ST_PL_RE
ON
E_CT.CD_TIPO_AGENDAMENTO =  E_ST_PL_RE.CD_ELO_STATUS
--AND E_ST_PL_RE.SG_STATUS IN ('PLAN', 'REPLAN')

LEFT JOIN VND.GRUPO_EMBALAGEM EMBL
ON 
E_CT.CD_GRUPO_EMBALAGEM = EMBL.CD_GRUPO_EMBALAGEM
AND EMBL.IC_ATIVO = 'S'

WHERE 
1=1
AND E_CT.IC_ATIVO = 'S'
AND E_CT.CD_INCOTERMS = 'CIF'
AND E_AG_ITEM.CD_INCOTERMS = 'CIF'
AND E_AG.IC_ATIVO = 'S'
--AND E_CT.CD_ELO_CARTEIRA = 100000000
AND E_CT.IC_COOPERATIVE IN ('S', 'N')
AND (E_ST_CS.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN') )  -- STATUS CARTEIRA CUSTOMER SERVICE

) GRSAP
GROUP BY 

GRSAP.CD_ELO_CARTEIRA  , 
GRSAP.CD_ELO_AGENDAMENTO_ITEM  , 
GRSAP.DH_CARTEIRA  , 
GRSAP.CD_SALES_ORG  , 
GRSAP.NU_CONTRATO_SAP  , 
GRSAP.CD_TIPO_CONTRATO  , 
GRSAP.NU_CONTRATO_SUBSTITUI  , 
GRSAP.DT_PAGO  , 
GRSAP.NU_CONTRATO  , 
GRSAP.NU_ORDEM_VENDA  , 
GRSAP.IC_SEM_ORDEM_VENDA  , 
GRSAP.DS_STATUS_CONTRATO_SAP  , 
GRSAP.CD_CLIENTE  , 
GRSAP.NO_CLIENTE  , 
GRSAP.COOPERADO  , 
GRSAP.CD_INCOTERMS  , 
GRSAP.CD_SALES_DISTRICT  , 
GRSAP.CD_SALES_OFFICE  , 
GRSAP.NO_SALES_OFFICE  , 
GRSAP.CD_SALES_GROUP  , 
GRSAP.NO_SALES_GROUP  , 
GRSAP.CD_AGENTE_VENDA  , 
GRSAP.NO_AGENTE  , 
GRSAP.DH_VENCIMENTO_PEDIDO  , 
GRSAP.DT_CREDITO  , 
GRSAP.DT_INICIO  , 
GRSAP.DT_FIM  , 
GRSAP.DH_INCLUSAO  , 
GRSAP.DH_ENTREGA  , 
GRSAP.SG_ESTADO  , 
GRSAP.NO_MUNICIPIO  , 
GRSAP.DS_BAIRRO  , 
GRSAP.CD_PRODUTO_SAP  , 
GRSAP.NO_PRODUTO_SAP  , 
GRSAP.LIST_OF_NR_PROTOCOLO  , 
GRSAP.PC_COMISSAO ,
GRSAP.CD_SACARIA ,
GRSAP.DS_SACARIA ,
GRSAP.CD_CULTURA_SAP ,
GRSAP.DS_CULTURA_SAP ,
GRSAP.CD_BLOQUEIO_REMESSA ,
GRSAP.CD_BLOQUEIO_FATURAMENTO ,
GRSAP.CD_BLOQUEIO_CREDITO , 
GRSAP.CD_BLOQUEIO_REMESSA_ITEM ,
GRSAP.CD_BLOQUEIO_FATURAMENTO_ITEM ,
GRSAP.CD_MOTIVO_RECUSA ,
GRSAP.CD_LOGIN ,
GRSAP.CD_SEGMENTACAO_CLIENTE ,
GRSAP.DS_SEGMENTACAO_CLIENTE ,
GRSAP.DS_SEGMENTO_CLIENTE_SAP ,
GRSAP.CD_FORMA_PAGAMENTO ,
GRSAP.CD_TIPO_PAGAMENTO , 
GRSAP.DS_TIPO_PAGAMENTO ,
GRSAP.CD_AGRUPAMENTO ,
GRSAP.CD_BLOQUEIO_ENTREGA ,
GRSAP.NU_CNPJ ,
GRSAP.NU_CPF ,
GRSAP.NU_INSCRICAO_ESTADUAL ,
GRSAP.NU_INSCRICAO_MUNICIPAL ,
GRSAP.NU_CEP ,
GRSAP.DS_ENDERECO , 
GRSAP.CD_CLIENTE_RECEBEDOR ,
GRSAP.NO_CLIENTE_RECEBEDOR ,
GRSAP.CD_MOEDA ,
GRSAP.CD_SUPPLY_GROUP ,
GRSAP.DS_VENDA_COMPARTILHADA ,
GRSAP.CD_STATUS_LIBERACAO ,
GRSAP.CD_ITEM_PEDIDO ,
GRSAP.CD_CLIENTE_PAGADOR ,
GRSAP.NO_CLIENTE_PAGADOR,
GRSAP.IC_RELACIONAMENTO,
GRSAP.CD_PRIORIDADE,
GRSAP.NU_ORDEM,
GRSAP.CD_USUARIO_REFRESH,
GRSAP.DH_REFRESH,
GRSAP.CD_TIPO_AGENDAMENTO,
GRSAP.DS_STATUS_TIPO_AGENDAMENTO,
GRSAP.CD_TIPO_REPLAN,
GRSAP.CD_BLOQUEIO_REMESSA_R,
GRSAP.CD_BLOQUEIO_FATURAMENTO_R,
GRSAP.CD_BLOQUEIO_CREDITO_R,
GRSAP.CD_BLOQUEIO_REMESSA_ITEM_R,
GRSAP.CD_BLOQUEIO_FATURAMENTO_ITEM_R,
GRSAP.DS_OBSERVACAO_ADVEN,
GRSAP.IC_PERMITIR_CS,
GRSAP.DH_LIBERACAO_TORRE_FRETES,
GRSAP.DH_MODIFICACAO_TORRE_FRETES,
GRSAP.DH_CONTRATACAO_TORRE_FRETES,
GRSAP.CD_ELO_FREIGHT_TOWER_REASON,
GRSAP.IC_NAO_LIBERADA_SEM_PROTOCOLO,
GRSAP.IC_ENTREGA_CADENCIADA_CLIENTE,
GRSAP.IC_DIFICULDADE_CONTRATACAO,
GRSAP.IC_OUTROS,
GRSAP.CD_STATUS_CUSTOMER_SERVICE,
GRSAP.DS_STATUS_CUSTOMER_SERVICE,
GRSAP.SG_STATUS_CUSTOMER_SERVICE,
GRSAP.CD_STATUS_TORRE_FRETES,
GRSAP.DS_STATUS_TORRE_FRETES,
GRSAP.SG_STATUS_TORRE_FRETES,
GRSAP.CD_STATUS_CONTROLADORIA,
GRSAP.SG_STATUS_CONTROLADORIA,
GRSAP.IC_ATIVO,
GRSAP.CD_GRUPO_EMBALAGEM,
GRSAP.DS_CREDIT_BLOCK_REASON,
GRSAP.DH_CREDIT_BLOCK, 
GRSAP.SG_DESTINO_BACKLOG_CIF,
GRSAP.CD_STATUS_BACKLOG_CIF,
GRSAP.SG_STATUS_BACKLOG_CIF,
GRSAP.DH_BACKLOG_CIF,
GRSAP.CD_ELO_AGENDAMENTO,
GRSAP.CD_USUARIO_FABRICA,
GRSAP.DH_FABRICA,
GRSAP.CD_USUARIO_CORTADO_FABRICA, 
GRSAP.DH_CORTADO_FABRICA,
GRSAP.CD_USUARIO_AJUSTE_SAP,
GRSAP.DH_AJUSTE_SAP,
GRSAP.CD_ITEM_CONTRATO,
GRSAP.CD_STATUS_LOGISTICA,
GRSAP.SG_STATUS_LOGISTICA,
GRSAP.IC_CORTADO_FABRICA,
GRSAP.IC_COOPERATIVE,
GRSAP.TIPO_PROCESSO_VENDAS,
GRSAP.IC_SPLIT,
GRSAP.IC_EMERGENCIAL,
GRSAP.DS_ROTEIRO_ENTREGA,
GRSAP.CD_ELO_PRIORITY_OPTION,
GRSAP.IC_FA,
GRSAP.DESTINO,
GRSAP.VL_FRETE_DISTRIBUICAO,
GRSAP.LIST_OF_NO_TRANSPORTADORA,
GRSAP.CD_ELO_CARTEIRA_TORRE_FRETES,
GRSAP.CD_TRANSPORTADORA,
GRSAP.NO_TRANSPORTADORA,
GRSAP.NU_SEMANA,
GRSAP.NU_DIA_SEMANA,
GRSAP.VL_FRETE_CONTRATADO ,
GRSAP.DS_OBSERVACAO_TORRE_FRETES , 
GRSAP.CD_DIA_EXATO,
GRSAP.DS_FREIGHT_TOWER_REASON,
GRSAP.DS_COLOR,
GRSAP.CD_DEPARTAMENTO,
GRSAP.CTF_SEG ,
GRSAP.CTF_TER ,
GRSAP.CTF_QUA ,
GRSAP.CTF_QUI ,
GRSAP.CTF_SEX ,
GRSAP.CTF_SAB ,
GRSAP.CTF_DOM ,
GRSAP.NU_CARTEIRA_VERSION,
GRSAP.DH_LIMITE,
GRSAP.AG_CD_ELO_STATUS,
GRSAP.DS_STATUS,
GRSAP.SG_STATUS,
GRSAP.CD_WEEK,
GRSAP.CD_POLO, 
GRSAP.CD_CENTRO_EXPEDIDOR,                     
GRSAP.CD_MACHINE,                
GRSAP.CD_ELO_AGENDAMENTO_SUPERVISOR,       
GRSAP.CD_PRODUTO_SAP_AG_ITEM,       
GRSAP.CD_COTA_COMPARTILHADA,   
GRSAP.IC_CORTADO_SEMANA_ANTERIOR, 
GRSAP.DS_OBSERVACAO_PARA_TF,
GRSAP.CD_INDICADOR_COMPOSICAO_CARGA, 
GRSAP.COTA_NUQ_SEG,
GRSAP.COTA_NUQ_TER,
GRSAP.COTA_NUQ_QUA,
GRSAP.COTA_NUQ_QUI,
GRSAP.COTA_NUQ_SEX,
GRSAP.COTA_NUQ_SAB,
GRSAP.COTA_NUQ_DOM

ORDER BY GRSAP.NU_ORDEM

;

    END PX_GET_TORRE_FRETES;


--------------------------------------------------------------------------------------------------


    PROCEDURE PX_GET_TORRE_FRETES_EXCEL (
        P_CD_POLO               IN VARCHAR2,
        P_CD_CENTRO_EXPEDIDOR   IN VARCHAR2,
        P_MACHINE               IN VARCHAR2,
        P_DT_WEEK_FROM          IN VARCHAR2,
        P_DT_WEEK_TO            IN VARCHAR2,
        P_RETURN                OUT T_CURSOR
    )

    IS

        L_CD_POLO                VARCHAR2(4000);
        L_CD_CENTRO_EXPEDIDOR    VARCHAR2(4000);
        L_MACHINE                VARCHAR2(4000);
        L_DT_WEEK_FROM           VARCHAR2(20);
        L_DT_WEEK_TO             VARCHAR2(20); 
        L_DT_FROM_NULL           DATE;
BEGIN

        SELECT   
        DECODE(P_CD_POLO,  '0', '9999', P_CD_POLO),
         DECODE(P_CD_CENTRO_EXPEDIDOR, '0', '9999', P_CD_CENTRO_EXPEDIDOR),
         DECODE(P_MACHINE,  '0', '9999', P_MACHINE),
        DECODE(P_DT_WEEK_FROM, NULL, TO_CHAR(SYSDATE, 'YYYY-MM-DD'),  P_DT_WEEK_FROM),
         DECODE(P_DT_WEEK_TO, NULL, TO_CHAR(SYSDATE, 'YYYY-MM-DD'),  P_DT_WEEK_TO)
         INTO
        L_CD_POLO, 
        L_CD_CENTRO_EXPEDIDOR,
        L_MACHINE,
        L_DT_WEEK_FROM,
        L_DT_WEEK_TO
        FROM DUAL;

--        IF TO_DATE( L_DT_WEEK_TO, 'YYYY-MM-DD') - TO_DATE(L_DT_WEEK_FROM, 'YYYY-MM-DD') > 366 THEN
--          L_DT_WEEK_FROM:=   TO_CHAR(TRUNC(TO_DATE( L_DT_WEEK_TO, 'YYYY-MM-DD') - 31, 'MM'), 'YYYY-MM-DD');
--          END IF;

        L_DT_FROM_NULL:= null;--TO_DATE('1900-01-01', 'YYYY-MM-DD');

        --ALTERE AQUI E O COPIE PARA O EXCEL 2017-11-27
        OPEN P_RETURN FOR

WITH CTE_ELO_AGENDAMENTO AS 
(
----------------INCLUDE FILTER BY DATE AND DATE+2WEEK AND REPLAN
SELECT FILAG.CD_ELO_AGENDAMENTO FROM 

(
 
SELECT DISTINCT 
CAG.CD_ELO_AGENDAMENTO--, 
--CAG.DT_WEEK_START, 
----CAG.CD_CENTRO_EXPEDIDOR, --CAG.CD_POLO, --CAG.CD_MACHINE, 
--CAG.CD_WEEK ,
--
--E_AGCMAC.CD_CENTRO_EXPEDIDOR , 
--E_AGCMAC.CD_MACHINE , 
--E_AGPC.CD_POLO  
 
FROM VND.VW_ELO_AGENDAMENTO_ALL CAG
WHERE
CAG.IC_ATIVO = 'S'
AND
((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
(L_CD_POLO = '9999' OR (CAG.CD_POLO IN (  select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null))))
 
AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
(L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
 
AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
(L_MACHINE = '9999' OR ((CAG.CD_MACHINE) IN (  L_MACHINE))))
 
AND 
    (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
     AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD'),'YYYYWW'))
UNION 
 
SELECT DISTINCT 
CAG.CD_ELO_AGENDAMENTO--, 

FROM VND.VW_ELO_AGENDAMENTO_ALL  CAG

WHERE
CAG.IC_ATIVO = 'S'
AND
((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
(L_CD_POLO = '9999' OR (CAG.CD_POLO IN  ( select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null ))))
    
AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
(L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN(   select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
 
AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
(L_MACHINE = '9999' OR ((CAG.CD_MACHINE)  IN ( L_MACHINE))))
 
AND 
        --HERE NEED CHANGE DT_WEEK_START TO DT_WEEK_REPLAN
    (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
     AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD') ,'YYYYWW'))
AND 
EXISTS (
    SELECT 1 FROM VND.VW_ELO_CARTEIRA_ALL CCT
    INNER JOIN VND.ELO_STATUS EST_REPLAN
    ON
    CCT.CD_TIPO_AGENDAMENTO = EST_REPLAN.CD_ELO_STATUS
    AND EST_REPLAN.SG_STATUS = 'REPLAN'
    
    WHERE 
    CCT.CD_ELO_AGENDAMENTO = CAG.CD_ELO_AGENDAMENTO
    AND CCT.IC_ATIVO = 'S'
    AND CCT.CD_INCOTERMS = 'CIF'
    AND CCT.IC_COOPERATIVE IN ('S', 'N')
    )         
-----------------------------------------------------------------------------------------------------------
UNION
 
SELECT CAG.CD_ELO_AGENDAMENTO FROM VND.ELO_AGENDAMENTO CAG
WHERE 
     CAG.IC_ATIVO = 'S'
    AND
    ((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
    (L_CD_POLO = '9999' OR (CAG.CD_POLO IN (  select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null))))
    
    AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
    (L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
    
    AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
    (L_MACHINE = '9999' OR ((CAG.CD_MACHINE) IN (  L_MACHINE))))
  
    AND 
        (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
         AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD'),'YYYYWW'))
UNION 
SELECT CAG.CD_ELO_AGENDAMENTO FROM VND.ELO_AGENDAMENTO CAG
 
WHERE 
     CAG.IC_ATIVO = 'S'
    AND
    ((L_CD_POLO IS NULL AND CAG.CD_POLO IS NULL ) OR 
    (L_CD_POLO = '9999' OR (CAG.CD_POLO IN  ( select regexp_substr(L_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_POLO, '[^,]+', 1, level) is not null))))
    
    AND ((L_CD_CENTRO_EXPEDIDOR IS NULL AND CAG.CD_CENTRO_EXPEDIDOR IS NULL ) OR 
    (L_CD_CENTRO_EXPEDIDOR = '9999' OR (CAG.CD_CENTRO_EXPEDIDOR IN(   select regexp_substr(L_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(L_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
    
    AND ((L_MACHINE IS NULL AND CAG.CD_MACHINE IS NULL ) OR 
    (L_MACHINE = '9999' OR ((CAG.CD_MACHINE)  IN ( L_MACHINE))))
 
    AND 
            --HERE NEED CHANGE DT_WEEK_START TO DT_WEEK_REPLAN
        (TO_CHAR(CAG.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
         AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD') ,'YYYYWW'))
    AND 
    EXISTS (
        SELECT 1 FROM VND.VW_ELO_CARTEIRA_ALL CCT
        INNER JOIN VND.ELO_STATUS EST_REPLAN
        ON
        CCT.CD_TIPO_AGENDAMENTO = EST_REPLAN.CD_ELO_STATUS
        AND EST_REPLAN.SG_STATUS = 'REPLAN'
        
        WHERE 
        CCT.CD_ELO_AGENDAMENTO = CAG.CD_ELO_AGENDAMENTO
        AND CCT.IC_ATIVO = 'S'
        AND CCT.CD_INCOTERMS = 'CIF'
        AND CCT.IC_COOPERATIVE IN ('S', 'N')
    )         


) FILAG
WHERE 
EXISTS (
        SELECT 1 FROM VND.VW_ELO_CARTEIRA_ALL CCTE
        INNER JOIN VND.ELO_STATUS E_ST_CS
        ON
        CCTE.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS

        INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR SUP  --INSERIR LINHAS
        ON
        SUP.CD_ELO_AGENDAMENTO = CCTE.CD_ELO_AGENDAMENTO
        AND SUP.IC_ATIVO = 'S'

        INNER JOIN VND.ELO_AGENDAMENTO_ITEM ITEM
        ON
        ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
        AND ITEM.CD_ELO_AGENDAMENTO_ITEM = CCTE.CD_ELO_AGENDAMENTO_ITEM
        AND ITEM.IC_ATIVO = 'S'
        AND ITEM.CD_INCOTERMS = 'CIF'

        WHERE 
        CCTE.CD_ELO_AGENDAMENTO = FILAG.CD_ELO_AGENDAMENTO
        AND CCTE.IC_ATIVO = 'S'
        AND CCTE.CD_INCOTERMS = 'CIF'
        AND CCTE.IC_COOPERATIVE IN ('S', 'N')
        AND E_ST_CS.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')
            )



), 
CTE_CARTEIRA_FILTER AS 
(
SELECT DISTINCT T.CD_ELO_CARTEIRA, T.CD_ELO_AGENDAMENTO, T.CD_ELO_AGENDAMENTO_ITEM 
FROM VND.VW_ELO_CARTEIRA_ALL T
INNER JOIN  CTE_ELO_AGENDAMENTO CTAG 
ON CTAG.CD_ELO_AGENDAMENTO = T.CD_ELO_AGENDAMENTO
--INNER JOIN VND.ELO_STATUS E_ST_CS
--ON
--T.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS
WHERE 
T.IC_ATIVO = 'S'
AND T.CD_INCOTERMS = 'CIF'
AND T.IC_COOPERATIVE IN ('S', 'N')
--AND E_ST_CS.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')
AND T.CD_STATUS_CUSTOMER_SERVICE IS NOT NULL
AND EXISTS (
        SELECT 1 FROM VND.ELO_AGENDAMENTO_SUPERVISOR SUP  --INSERIR LINHAS
        INNER JOIN VND.ELO_AGENDAMENTO_ITEM ITEM
        ON
        ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
        WHERE
        SUP.CD_ELO_AGENDAMENTO = T.CD_ELO_AGENDAMENTO
        AND ITEM.CD_ELO_AGENDAMENTO_ITEM = T.CD_ELO_AGENDAMENTO_ITEM
        AND SUP.IC_ATIVO = 'S'
        AND ITEM.IC_ATIVO = 'S'
        AND ITEM.CD_INCOTERMS = 'CIF'   
        )
--and T.CD_ELO_CARTEIRA IN (100000271, 100000272, 100000273, 100000274, 100000275, 100000276, 100000277) 	
), 

CTE_APPLY_ANTECIPADO AS 
(
    SELECT 
    CHECKATEN.CD_ELO_CARTEIRA, 
    CHECKATEN.QT_REGRA_ANTECIPADO, 
    CHECKATEN.MIN_SEMANA_SAIDA,
    CHECKATEN.IS_SEMANA_EXECUCAO,
    CASE
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 1 AND CHECKATEN.QT_REGRA_ANTECIPADO > 0 THEN 1
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 1 AND CHECKATEN.QT_REGRA_ANTECIPADO = 0 THEN 0
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 0 AND CHECKATEN.QT_REGRA_ANTECIPADO = 0 THEN 0
    WHEN CHECKATEN.IS_SEMANA_EXECUCAO = 0 AND CHECKATEN.QT_REGRA_ANTECIPADO > 0 THEN 0
    ELSE 0

    END IS_SHOW_ANTECIPADO

    FROM
    (
    SELECT CART_FIL.CD_ELO_CARTEIRA, 
    NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CART
    ON    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_AGENDAMENTO E_AGEND
    ON    E_AGEND.CD_ELO_AGENDAMENTO = E_CART.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON     I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS
    WHERE     CART_FIL.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND E_MAR.DH_SAIDA IS NOT NULL
    AND E_MAR.IC_ATIVO = 'S'
    AND NOT(TO_CHAR(E_AGEND.DT_WEEK_START,'YYYYWW') = TO_CHAR(E_MAR.DH_SAIDA,'YYYYWW'))
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG' 
    GROUP BY E_CART.CD_ELO_CARTEIRA),0) + 

    NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CART
    ON    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_AGENDAMENTO E_AGEND
    ON    E_AGEND.CD_ELO_AGENDAMENTO = E_CART.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON     I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS
    WHERE     CART_FIL.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'REPLAN'
    AND E_MAR.DH_SAIDA IS NOT NULL
    AND E_MAR.IC_ATIVO = 'S'
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG' 
    GROUP BY E_CART.CD_ELO_CARTEIRA),0) QT_REGRA_ANTECIPADO,

    (SELECT  TO_CHAR(MIN(O_MAR.DH_SAIDA) ,'YYYYWW') MIN_SEMANA_SAIDA 
    FROM VND.ELO_MARCACAO O_MAR
    WHERE 
    O_MAR.DH_SAIDA IS NOT NULL
    AND O_MAR.IC_ATIVO = 'S'
    AND CART_FIL.CD_ELO_CARTEIRA = O_MAR.CD_ELO_CARTEIRA
    GROUP BY O_MAR.CD_ELO_CARTEIRA) MIN_SEMANA_SAIDA, 


    NVL((SELECT 1 
    FROM VND.VW_ELO_CARTEIRA_ALL E_CART
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    CART_FIL.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS  IN('PLAN', 'AGCTR')  --EM EXECUCAO
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'AGEND'
    AND ROWNUM =1 )
    ,0) IS_SEMANA_EXECUCAO,
    0 IS_SHOW_ANTECIPADO

    FROM CTE_CARTEIRA_FILTER CART_FIL
    ) CHECKATEN


),

CTE_SUM_OF_COTA AS 

(
SELECT 

ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 1 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_SEG,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 2 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END)  ,2) COTA_NUQ_TER,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 3 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_QUA,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 4 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_QUI,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 5 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_SEX,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 6 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_SAB,
ROUND(SUM(CASE 
WHEN IE_AGDAY.NU_DIA_SEMANA = 7 THEN IE_AGDAY.NU_QUANTIDADE 
ELSE 0 END) ,2) COTA_NUQ_DOM

FROM CTE_ELO_AGENDAMENTO ICTE_AG
INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR IE_A_SUP  --INSERIR LINHAS
ON
IE_A_SUP.CD_ELO_AGENDAMENTO = ICTE_AG.CD_ELO_AGENDAMENTO
AND IE_A_SUP.IC_ATIVO = 'S'

INNER JOIN VND.ELO_AGENDAMENTO_ITEM IE_AG_ITEM
ON
IE_AG_ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = IE_A_SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
AND IE_AG_ITEM.IC_ATIVO = 'S'

--INNER JOIN CTE_CARTEIRA_FILTER CCC
--ON
--CCC.CD_ELO_AGENDAMENTO = ICTE_AG.CD_ELO_AGENDAMENTO
--AND CCC.CD_ELO_AGENDAMENTO_ITEM = IE_AG_ITEM.CD_ELO_AGENDAMENTO_ITEM

INNER JOIN VND.ELO_AGENDAMENTO_WEEK IEAG_WE_I
ON IE_AG_ITEM.CD_ELO_AGENDAMENTO_ITEM = IEAG_WE_I.CD_ELO_AGENDAMENTO_ITEM

INNER JOIN ELO_AGENDAMENTO_DAY IE_AGDAY
ON 
IE_AGDAY.CD_ELO_AGENDAMENTO_WEEK = IEAG_WE_I.CD_ELO_AGENDAMENTO_WEEK

WHERE 
 IE_AG_ITEM.CD_INCOTERMS = 'CIF'
GROUP BY 1 

) 


SELECT 
------------VND.ELO_CARTEIRA-------------

E_CT.CD_ELO_CARTEIRA ,
E_CT.CD_ELO_AGENDAMENTO_ITEM ,
E_CT.DH_CARTEIRA ,
E_CT.CD_SALES_ORG ,
E_CT.NU_CONTRATO_SAP ,
E_CT.CD_TIPO_CONTRATO ,
E_CT.NU_CONTRATO_SUBSTITUI ,
NVL(E_CT.DT_PAGO , L_DT_FROM_NULL) DT_PAGO,
NVL(E_CT.NU_CONTRATO, 0) NU_CONTRATO ,
E_CT.NU_ORDEM_VENDA ,
E_CT.IC_SEM_ORDEM_VENDA ,
E_CT.DS_STATUS_CONTRATO_SAP ,
CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN E_CT.CD_CLIENTE_RECEBEDOR--'Revenda'
WHEN E_CT.IC_COOPERATIVE = 'N' THEN E_CT.CD_CLIENTE--'Venda Direta'
END CD_CLIENTE,

CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN E_CT.NO_CLIENTE_RECEBEDOR--'Revenda'
WHEN E_CT.IC_COOPERATIVE = 'N' THEN E_CT.NO_CLIENTE--'Venda Direta'
END NO_CLIENTE,

CASE
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
    FX_GET_PROTOCOLO_TORRE_DATA(NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO), 'COOPERADO') ELSE '***' END COOPERADO, 

E_CT.CD_INCOTERMS ,
E_CT.CD_SALES_DISTRICT ,
E_CT.CD_SALES_OFFICE ,
NVL(E_CT.CD_SALES_OFFICE, '-') || '-' || NVL(E_CT.NO_SALES_OFFICE, '-') NO_SALES_OFFICE,
E_CT.CD_SALES_GROUP ,
NVL(E_CT.CD_SALES_GROUP, '-') ||'-' || NVL(E_CT.NO_SALES_GROUP, '-') NO_SALES_GROUP,
E_CT.CD_AGENTE_VENDA ,
E_CT.NO_AGENTE ,
NVL(E_CT.DH_VENCIMENTO_PEDIDO , L_DT_FROM_NULL) DH_VENCIMENTO_PEDIDO,
NVL(E_CT.DT_CREDITO , L_DT_FROM_NULL ) DT_CREDITO,
NVL(E_CT.DT_INICIO , L_DT_FROM_NULL) DT_INICIO,
NVL(E_CT.DT_FIM ,L_DT_FROM_NULL) DT_FIM,
NVL(E_CT.DH_INCLUSAO ,L_DT_FROM_NULL) DH_INCLUSAO,
NVL(E_CT.DH_ENTREGA ,L_DT_FROM_NULL) DH_ENTREGA,
E_CT.SG_ESTADO ,
E_CT.NO_MUNICIPIO ,
E_CT.DS_BAIRRO ,
E_CT.CD_PRODUTO_SAP ,
E_CT.NO_PRODUTO_SAP ,
--NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) QT_PROGRAMADA,  ADJUSTE ABNER 2018.04.03

CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
(
SELECT 

ROUND(SUM(VBPROT.QT_AGENDADA_PROTOCOLO), 0) QT_AGENDADA_PROTOCOLO

FROM VND.ELO_VBAK_PROTOCOLO VBPROTJ
WHERE 
VBPROTJ.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA

AND NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO) = VBPROTJ.NU_PROTOCOLO
AND VBPROTJ.IC_ATIVO = 'S'
GROUP BY 1
)

ELSE 
NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 )
END QT_PROGRAMADA,

NVL(E_CT.QT_ENTREGUE ,0) QT_ENTREGUE,
COALESCE( E_CT.QT_SALDO_REFRESH,E_CT.QT_SALDO, 0)  QT_SALDO,

NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) - 
NVL(( SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_SALDO_PROGRAMADA,

CASE
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO)

    --E_CT.NU_PROTOCOLO
    
  --  (SELECT (VBPROT.NU_PROTOCOLO ) 
   --        FROM VND.ELO_VBAK_PROTOCOLO VBPROT
   --        WHERE VBPROT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA AND ROWNUM=1)
    
    --FX_GET_NR_PROTOCOLO(E_CT.CD_ELO_AGENDAMENTO ,
    --E_CT.CD_ELO_AGENDAMENTO_ITEM ) 
    ELSE '***' END LIST_OF_NR_PROTOCOLO, 

CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN --'Revenda'

TO_NUMBER(FX_GET_PROTOCOLO_TORRE_DATA(NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO), 'SALDO'))

--E_CT.QT_AGENDADA_PROTOCOLO
--NVL((SELECT SUM(VBPROT.QT_AGENDADA_PROTOCOLO ) SOMM
--           FROM VND.ELO_VBAK_PROTOCOLO VBPROT
--           WHERE VBPROT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA),0)
--        NVL((SELECT 
--        SUM(NVL(CPT_ENT.QT_QUANTIDADE,0) - NVL(CPT_ENT.QT_FORNECIDO,0)) SALDO
--        FROM CTE_CARTEIRA_FILTER EC_I
--        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
--        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--
--        INNER JOIN CTE_ELO_AGENDAMENTO CTE_AGE  --FILTER INCLUSIVE REPLAN
--        ON 
--        CTE_AGE.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO        
--
--		INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
--        ON 
--        EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--        AND EA_SUP_I.IC_ATIVO = 'S'
--
--		INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
--
--        ON 
--		EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
--        AND EAG_ITEM_I.IC_ATIVO = 'S'	
--
--		INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
--        ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
--
--		INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
--        ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
--        AND EAG_GRO_I.SG_TIPO_DOCUMENTO = 'P'
--
--		INNER JOIN CPT.ENTREGA CPT_ENT
--        ON CPT_ENT.NU_PROTOCOLO_ENTREGA = EAG_GRO_I.NU_DOCUMENTO
--
--		INNER JOIN CPT.AUTORIZACAO_ENTREGA CPT_AUT_ENT 
--        ON CPT_AUT_ENT.CD_AUTORIZACAO_ENTREGA = CPT_ENT.CD_AUTORIZACAO_ENTREGA
--
--		WHERE 
--        EC_I.CD_ELO_AGENDAMENTO = E_CT.CD_ELO_AGENDAMENTO
--        AND EC_I.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
--        GROUP BY EC_I.CD_ELO_AGENDAMENTO),0)
WHEN E_CT.IC_COOPERATIVE = 'N' THEN COALESCE( E_CT.QT_SALDO_REFRESH,E_CT.QT_SALDO, 0)
ELSE 0 
END SALDO_ORDEM_VENDA_PROTOCOLO, 

NVL(E_CT.VL_UNITARIO,0) VL_UNITARIO ,
NVL(E_CT.VL_BRL ,0) VL_BRL,
NVL(E_CT.VL_TAXA_DOLAR ,0) VL_TAXA_DOLAR,
NVL(E_CT.VL_USD ,0) VL_USD,
NVL(E_CT.PC_COMISSAO ,0) PC_COMISSAO,
E_CT.CD_SACARIA ,
E_CT.DS_SACARIA ,
E_CT.CD_CULTURA_SAP ,
E_CT.DS_CULTURA_SAP ,
E_CT.CD_BLOQUEIO_REMESSA ,
E_CT.CD_BLOQUEIO_FATURAMENTO ,
E_CT.CD_BLOQUEIO_CREDITO ,
E_CT.CD_BLOQUEIO_REMESSA_ITEM ,
E_CT.CD_BLOQUEIO_FATURAMENTO_ITEM ,
E_CT.CD_MOTIVO_RECUSA ,
E_CT.CD_LOGIN ,
E_CT.CD_SEGMENTACAO_CLIENTE ,
E_CT.DS_SEGMENTACAO_CLIENTE ,
E_CT.DS_SEGMENTO_CLIENTE_SAP ,
E_CT.CD_FORMA_PAGAMENTO ,
E_CT.CD_TIPO_PAGAMENTO ,
E_CT.DS_TIPO_PAGAMENTO ,
E_CT.CD_AGRUPAMENTO ,
E_CT.CD_BLOQUEIO_ENTREGA ,
E_CT.NU_CNPJ ,
E_CT.NU_CPF ,
E_CT.NU_INSCRICAO_ESTADUAL ,
E_CT.NU_INSCRICAO_MUNICIPAL ,
E_CT.NU_CEP ,
E_CT.DS_ENDERECO_RECEBEDOR DS_ENDERECO ,
E_CT.CD_CLIENTE_RECEBEDOR ,
E_CT.NO_CLIENTE_RECEBEDOR ,
E_CT.CD_MOEDA ,
E_CT.CD_SUPPLY_GROUP ,
E_CT.DS_VENDA_COMPARTILHADA ,
E_CT.CD_STATUS_LIBERACAO ,
NVL(E_CT.CD_ITEM_PEDIDO ,0) CD_ITEM_PEDIDO,
E_CT.CD_CLIENTE_PAGADOR ,
E_CT.NO_CLIENTE_PAGADOR ,
E_CT.IC_RELACIONAMENTO ,
E_CT.CD_ELO_PRIORITY_OPTION CD_PRIORIDADE,
NVL(E_CT.NU_ORDEM ,0) NU_ORDEM,
NVL(E_CT.QT_AGENDADA ,0) QT_AGENDADA,
NVL(E_CT.QT_AGENDADA_FABRICA ,0) QT_AGENDADA_FABRICA,
NVL(E_CT.QT_AGENDADA_SAP , 0 ) QT_AGENDADA_SAP,
NVL(E_CT.CD_USUARIO_REFRESH , 0) CD_USUARIO_REFRESH,
NVL(E_CT.DH_REFRESH , L_DT_FROM_NULL) DH_REFRESH,  
NVL(E_CT.QT_PROGRAMADA_REFRESH ,0) QT_PROGRAMADA_REFRESH,
NVL(E_CT.QT_ENTREGUE_REFRESH ,0) QT_ENTREGUE_REFRESH ,
NVL(E_CT.QT_SALDO_REFRESH ,0) QT_SALDO_REFRESH,
NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) QT_AGENDADA_CONFIRMADA,

NVL(E_CT.CD_TIPO_AGENDAMENTO ,0) CD_TIPO_AGENDAMENTO,   --MAS CONHECIDO COMO PLAN E REPLAN
CASE 
WHEN NVL(E_ST_PL_RE.SG_STATUS, 'ORIGINAL')  IN ('ORIGINAL', 'INCLUSAO', 'PLAN') THEN 'PLAN'
WHEN E_ST_PL_RE.SG_STATUS = 'REPLAN' THEN 'REPLAN' ELSE 'PLAN' END DS_STATUS_TIPO_AGENDAMENTO,


NVL(E_CT.CD_TIPO_REPLAN ,0 ) CD_TIPO_REPLAN,
E_CT.CD_BLOQUEIO_REMESSA_R ,
E_CT.CD_BLOQUEIO_FATURAMENTO_R ,
E_CT.CD_BLOQUEIO_CREDITO_R ,
E_CT.CD_BLOQUEIO_REMESSA_ITEM_R ,
E_CT.CD_BLOQUEIO_FATURAMENTO_ITEM_R ,
E_CT.DS_OBSERVACAO_ADVEN ,

DECODE( E_CT.IC_PERMITIR_CS, 'S', 'S', 'N') IC_PERMITIR_CS,

NVL(E_CT.DH_LIBERACAO_TORRE_FRETES , L_DT_FROM_NULL) DH_LIBERACAO_TORRE_FRETES,
NVL(E_CT.DH_MODIFICACAO_TORRE_FRETES , L_DT_FROM_NULL) DH_MODIFICACAO_TORRE_FRETES,
NVL(E_CT.DH_CONTRATACAO_TORRE_FRETES , L_DT_FROM_NULL) DH_CONTRATACAO_TORRE_FRETES,
NVL(E_CT.CD_ELO_FREIGHT_TOWER_REASON ,0) CD_ELO_FREIGHT_TOWER_REASON,

DECODE( E_CT.IC_NAO_LIBERADA_SEM_PROTOCOLO, 'S', 'S', 'N') IC_NAO_LIBERADA_SEM_PROTOCOLO,
DECODE( E_CT.IC_ENTREGA_CADENCIADA_CLIENTE, 'S', 'S', 'N') IC_ENTREGA_CADENCIADA_CLIENTE,
DECODE( E_CT.IC_DIFICULDADE_CONTRATACAO, 'S', 'S', 'N') IC_DIFICULDADE_CONTRATACAO,
DECODE( E_CT.IC_OUTROS, 'S', 'S', 'N') IC_OUTROS,

NVL(E_CT.CD_STATUS_CUSTOMER_SERVICE ,0) CD_STATUS_CUSTOMER_SERVICE,

E_ST_CS.DS_STATUS DS_STATUS_CUSTOMER_SERVICE ,
E_ST_CS.SG_STATUS SG_STATUS_CUSTOMER_SERVICE ,

NVL(E_CT.CD_STATUS_TORRE_FRETES,0) CD_STATUS_TORRE_FRETES,
E_ST_CTF.DS_STATUS DS_STATUS_TORRE_FRETES ,
E_ST_CTF.SG_STATUS SG_STATUS_TORRE_FRETES,

NVL(E_CT.CD_STATUS_CONTROLADORIA, 0) CD_STATUS_CONTROLADORIA,
E_ST_CONTR.DS_STATUS SG_STATUS_CONTROLADORIA ,
E_CT.IC_ATIVO ,
CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
FX_GET_PROTOCOLO_TORRE_DATA(NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO), 'CD_GRUPO_EMBALAGEM')
ELSE 
E_CT.CD_GRUPO_EMBALAGEM || '-' || EMBL.DS_GRUPO_EMBALAGEM 
END CD_GRUPO_EMBALAGEM,

E_CT.DS_CREDIT_BLOCK_REASON ,
NVL(E_CT.DH_CREDIT_BLOCK , L_DT_FROM_NULL) DH_CREDIT_BLOCK , 

E_CT.SG_DESTINO_BACKLOG_CIF ,
NVL(E_CT.CD_STATUS_BACKLOG_CIF,0) CD_STATUS_BACKLOG_CIF,
E_ST_BLC.DS_STATUS SG_STATUS_BACKLOG_CIF ,
NVL(E_CT.QT_AGENDADA_ANTERIOR ,0) QT_AGENDADA_ANTERIOR,
E_CT.DH_BACKLOG_CIF ,
NVL(E_CT.QT_BACKLOG_CIF ,0) QT_BACKLOG_CIF,
NVL(E_CT.CD_ELO_AGENDAMENTO ,0) CD_ELO_AGENDAMENTO,
NVL(E_CT.QT_AGENDADA_REFRESH ,0) QT_AGENDADA_REFRESH,
NVL(E_CT.CD_USUARIO_FABRICA ,0) CD_USUARIO_FABRICA,
NVL(E_CT.DH_FABRICA , L_DT_FROM_NULL) DH_FABRICA,
NVL(E_CT.CD_USUARIO_CORTADO_FABRICA ,0) CD_USUARIO_CORTADO_FABRICA, 
NVL(E_CT.DH_CORTADO_FABRICA ,L_DT_FROM_NULL) DH_CORTADO_FABRICA,
NVL(E_CT.CD_USUARIO_AJUSTE_SAP , 0) CD_USUARIO_AJUSTE_SAP,
NVL(E_CT.DH_AJUSTE_SAP , L_DT_FROM_NULL) DH_AJUSTE_SAP,
NVL(E_CT.CD_ITEM_CONTRATO ,0) CD_ITEM_CONTRATO,
NVL(E_CT.CD_STATUS_LOGISTICA,0) CD_STATUS_LOGISTICA,
E_ST_ECT_LOG.DS_STATUS SG_STATUS_LOGISTICA ,
E_CT.IC_CORTADO_FABRICA ,
E_CT.IC_COOPERATIVE ,
CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 'Revenda'
WHEN E_CT.IC_COOPERATIVE = 'N' THEN 'Venda Direta'
END TIPO_PROCESSO_VENDAS,
E_CT.IC_SPLIT ,
DECODE( E_CT.IC_EMERGENCIAL, 'S', 'S', 'N') IC_EMERGENCIAL,
E_CT.QT_EMERGENCIAL,
CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
FX_GET_PROTOCOLO_TORRE_DATA(NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO), 'ROTEIRO')
ELSE E_CT.DS_ROTEIRO_ENTREGA END  DS_ROTEIRO_ENTREGA,
NVL(E_CT.CD_ELO_PRIORITY_OPTION ,0) CD_ELO_PRIORITY_OPTION,
NVL(E_CT.QT_AJUSTADA_FABRICA ,0) QT_AJUSTADA_FABRICA,
NVL(E_CT.QT_AJUSTADA_SAP ,0) QT_AJUSTADA_SAP,
E_CT.IC_FA ,
CASE 
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
FX_GET_PROTOCOLO_TORRE_DATA(NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO), 'DESTINO')
ELSE 
NVL(E_CT.NO_MUNICIPIO, '') || '-' || NVL(E_CT.SG_ESTADO, '') END DESTINO,

NVL(E_CT.VL_FRETE_DISTRIBUICAO,0) VL_FRETE_DISTRIBUICAO,

-----------VND.ELO_CARTEIRA_TORRE_FRETES---------

NVL(FX_GET_TF_TRANSPORTADORAS(E_CT.CD_ELO_CARTEIRA  ),  '***') LIST_OF_NO_TRANSPORTADORA,

NVL(E_CTF.CD_ELO_CARTEIRA_TORRE_FRETES, 0) CD_ELO_CARTEIRA_TORRE_FRETES,
E_CTF.CD_TRANSPORTADORA,
V_TRA.NO_TRANSPORTADORA,
NVL(E_CTF.NU_SEMANA, 0) NU_SEMANA,
NVL(E_CTF.NU_DIA_SEMANA,0) NU_DIA_SEMANA,
NVL(E_CTF.NU_QUANTIDADE , 0) NU_QUANTIDADE,

NVL(E_CTF.VL_FRETE_CONTRATADO ,0) VL_FRETE_CONTRATADO,




NVL((
   SELECT 
    ROUND((SUM(NVL(E_CTFI.VL_FRETE_CONTRATADO,0) * NVL(E_CTFI.NU_QUANTIDADE,0)) / (SUM(E_CTFI.NU_QUANTIDADE))),4) VL_FRETE_CONTRATADO_CTF
    FROM CTE_CARTEIRA_FILTER EC_I
    INNER JOIN CTE_ELO_AGENDAMENTO EAG_I
    ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTFI
    ON EC_I.CD_ELO_CARTEIRA = E_CTFI.CD_ELO_CARTEIRA
    WHERE E_CTFI.VL_FRETE_CONTRATADO > 0
    AND E_CTFI.NU_QUANTIDADE > 0
    AND EC_I.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
    --AND E_CTF.CD_ELO_CARTEIRA_TORRE_FRETES = E_CTFI.CD_ELO_CARTEIRA_TORRE_FRETES
    GROUP BY EC_I.CD_ELO_CARTEIRA
    HAVING COUNT(E_CTFI.CD_TRANSPORTADORA) > 0

),0) VL_FRETE_CONTRATADO_CTF,


NVL((
   SELECT 
    ROUND(SUM(E_CTFI.NU_QUANTIDADE),4) NU_QUANTIDADE_TOTAL_CTF
    FROM CTE_CARTEIRA_FILTER EC_I
     INNER JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTFI
    ON EC_I.CD_ELO_CARTEIRA = E_CTFI.CD_ELO_CARTEIRA
    WHERE E_CTFI.VL_FRETE_CONTRATADO > 0
    AND EC_I.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
    GROUP BY EC_I.CD_ELO_CARTEIRA
    HAVING COUNT(E_CTFI.CD_TRANSPORTADORA) > 0

),0) NU_QUANTIDADE_TOTAL_CTF,


E_CT.DS_OBSERVACAO_TORRE_FRETES , 
NVL(E_CTF.CD_DIA_EXATO, 'N')  CD_DIA_EXATO,

---------VND.ELO_FREIGHT_TOWER_REASON E_FTR--------------

E_FTR.DS_FREIGHT_TOWER_REASON,
E_FTR.DS_COLOR,
NVL(E_FTR.CD_DEPARTAMENTO, 0) CD_DEPARTAMENTO,


---------- CONTRATACAO TORRES FRETES DIA EXATO----------
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S' AND E_CTF.NU_DIA_SEMANA = 1 THEN E_CTF.CD_DIA_EXATO
ELSE 'N' END CTF_SEG,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S' AND E_CTF.NU_DIA_SEMANA = 2 THEN E_CTF.CD_DIA_EXATO
ELSE 'N' END CTF_TER,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S' AND E_CTF.NU_DIA_SEMANA = 3 THEN E_CTF.CD_DIA_EXATO
ELSE 'N' END CTF_QUA,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S' AND E_CTF.NU_DIA_SEMANA = 4 THEN E_CTF.CD_DIA_EXATO
ELSE 'N' END CTF_QUI,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S' AND E_CTF.NU_DIA_SEMANA = 5 THEN E_CTF.CD_DIA_EXATO
ELSE 'N' END CTF_SEX,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S' AND E_CTF.NU_DIA_SEMANA = 6 THEN E_CTF.CD_DIA_EXATO
ELSE 'N' END CTF_SAB,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S' AND E_CTF.NU_DIA_SEMANA = 7 THEN E_CTF.CD_DIA_EXATO
ELSE 'N' END CTF_DOM,
---------

CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S'  AND E_CTF.NU_DIA_SEMANA = 1 THEN E_CTF.NU_QUANTIDADE 
ELSE 0 END CTF_NUQ_SEG,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S'  AND E_CTF.NU_DIA_SEMANA = 2 THEN E_CTF.NU_QUANTIDADE 
ELSE 0 END CTF_NUQ_TER,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S'  AND E_CTF.NU_DIA_SEMANA = 3 THEN E_CTF.NU_QUANTIDADE 
ELSE 0 END CTF_NUQ_QUA,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S'  AND E_CTF.NU_DIA_SEMANA = 4 THEN E_CTF.NU_QUANTIDADE 
ELSE 0 END CTF_NUQ_QUI,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S'  AND E_CTF.NU_DIA_SEMANA = 5 THEN E_CTF.NU_QUANTIDADE 
ELSE 0 END CTF_NUQ_SEX,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S'  AND E_CTF.NU_DIA_SEMANA = 6 THEN E_CTF.NU_QUANTIDADE 
ELSE 0 END CTF_NUQ_SAB,
CASE 
WHEN E_CTF.CD_DIA_EXATO = 'S'  AND E_CTF.NU_DIA_SEMANA = 7 THEN E_CTF.NU_QUANTIDADE 
ELSE 0 END CTF_NUQ_DOM,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 1 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SEG,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 2 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_TER,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 3
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_QUA,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 4 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_QUI,    

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 5 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SEX,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 6 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SAB,    

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 7 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
        AND EXISTS (SELECT 1 
                FROM CTE_APPLY_ANTECIPADO AT 
                WHERE 
                AT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
                AND AT.IS_SHOW_ANTECIPADO = 0)
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_DOM,       

--------VND.ELO_AGENDAMENTO E_AG----------

E_AG.NU_CARTEIRA_VERSION ,
NVL(E_AG.DH_LIMITE ,L_DT_FROM_NULL ) DH_LIMITE,
NVL(E_AG.QT_OVERBOOKING_SUPERVISORES ,0) QT_OVERBOOKING_SUPERVISORES,
NVL(E_AG.QT_LIMITE_EMERGENCIAL,0) QT_LIMITE_EMERGENCIAL,
E_AG.CD_ELO_STATUS AG_CD_ELO_STATUS ,
E_ST_AG.DS_STATUS,
E_ST_AG.SG_STATUS,

NVL(E_AG.NU_SEMANAS ,0) NU_SEMANAS,
E_AG.CD_WEEK,
E_AG.CD_POLO, 
NVL(E_AG.CD_CENTRO_EXPEDIDOR, E_CT.CD_CENTRO_EXPEDIDOR) CD_CENTRO_EXPEDIDOR,                         
E_AG.CD_MACHINE,                
------------DESC VND.ELO_AGENDAMENTO_ITEM E_AG_ITEM---

E_AG_ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR,       
E_AG_ITEM.CD_PRODUTO_SAP CD_PRODUTO_SAP_AG_ITEM,       

E_AG_ITEM.CD_COTA_COMPARTILHADA,   
E_AG_ITEM.IC_CORTADO_SEMANA_ANTERIOR , 
E_AG_ITEM.DS_OBSERVACAO_TORRE_FRETES DS_OBSERVACAO_PARA_TF,


(   SELECT 
    MAX(EAG_GRO_I.CD_AGRUPAMENTO_PROTOCOLO) CD_AGRUPAMENTO_PROTOCOLO 

    FROM CTE_CARTEIRA_FILTER EC_I

    INNER JOIN VND.ELO_AGENDAMENTO EAG_I
    ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
    ON 
    EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    AND EA_SUP_I.IC_ATIVO = 'S'
    INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
    ON 
    EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
    AND EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EC_I.CD_ELO_AGENDAMENTO_ITEM
    AND EAG_ITEM_I.IC_ATIVO = 'S'	
    INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
    ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
    INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
    ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
    --AND EAG_GRO_I.SG_TIPO_DOCUMENTO = 'P'

    WHERE 
    EC_I.CD_ELO_AGENDAMENTO = E_CT.CD_ELO_AGENDAMENTO
    AND EC_I.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
    AND EAG_GRO_I.CD_AGRUPAMENTO_PROTOCOLO IS NOT NULL
    GROUP BY EC_I.CD_ELO_AGENDAMENTO, EC_I.CD_ELO_AGENDAMENTO_ITEM
) CD_INDICADOR_COMPOSICAO_CARGA, 


NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO_CARREGADO_FAT,  --CHANGE BY PAULO 2018.01.18 BY ADRIANO QT_MARCACAO_EM_CARREGAMENTO

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO_EM_CARREGAMENTO,  --CHANGE BY PAULO 2018.01.18 BY ADRIANO QT_MARCACAO_CARREGADO_FAT


NVL((SELECT REG_ATE.QT_REGRA_ANTECIPADO 
    FROM CTE_APPLY_ANTECIPADO REG_ATE
    WHERE 
    REG_ATE.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
    AND REG_ATE.IS_SHOW_ANTECIPADO = 1) ,0) QT_MARCACAO_ANTECIPADO,


NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.ELO_CARTEIRA E_CART
    ON
    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    E_CT.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG'
    GROUP BY E_CART.CD_ELO_CARTEIRA),0)  QT_AGENDAMENTO_SOMA,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO_VOL_REAL,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.ELO_CARTEIRA E_CART
    ON
    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    E_CT.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND E_MAR.DH_SAIDA IS NOT NULL
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG'
    GROUP BY E_CART.CD_ELO_CARTEIRA),0)   QT_MARCACAO_VOL_REAL_PLANO,

(NVL(E_CT.QT_AGENDADA_CONFIRMADA, 0)  -

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)
) QT_MARCACAO_VOL_REAL_MENOR,

CASE 
WHEN E_CT.IC_COOPERATIVE  = 'S' THEN 
    CASE 
        WHEN E_CTF.NU_PROTOCOLO IS NOT NULL  THEN 'S'
        ELSE 'N' 
    END
        
ELSE
'N' END IC_PROTOCOLO_VOLUME_TRANSP,
VBPROT.CD_ELO_VBAK_PROTOCOLO, 

(SELECT SOC.COTA_NUQ_SEG FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_SEG,
(SELECT SOC.COTA_NUQ_TER FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_TER,
(SELECT SOC.COTA_NUQ_QUA FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_QUA,
(SELECT SOC.COTA_NUQ_QUI FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_QUI,
(SELECT SOC.COTA_NUQ_SEX FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_SEX,
(SELECT SOC.COTA_NUQ_SAB FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_SAB,
(SELECT SOC.COTA_NUQ_DOM FROM CTE_SUM_OF_COTA SOC WHERE ROWNUM = 1 ) COTA_NUQ_DOM

FROM  VND.VW_ELO_CARTEIRA_ALL E_CT
INNER JOIN CTE_CARTEIRA_FILTER E_FILTER
ON E_CT.CD_ELO_CARTEIRA = E_FILTER.CD_ELO_CARTEIRA
LEFT JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTF
ON
E_CT.CD_ELO_CARTEIRA = E_CTF.CD_ELO_CARTEIRA 
--AND E_CTF.CD_ELO_CARTEIRA_TORRE_FRETES IN ( 3373, 3374) 

LEFT JOIN VND.ELO_VBAK_PROTOCOLO VBPROT
ON VBPROT.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA 
AND VBPROT.NU_PROTOCOLO = NVL(E_CTF.NU_PROTOCOLO, VBPROT.NU_PROTOCOLO)
AND VBPROT.IC_ATIVO = 'S'
AND VBPROT.QT_AGENDADA_PROTOCOLO > 0 

LEFT JOIN VND.ELO_FREIGHT_TOWER_REASON E_FTR
ON
E_CT.CD_ELO_FREIGHT_TOWER_REASON = E_FTR.CD_ELO_FREIGHT_TOWER_REASON
INNER JOIN VND.ELO_AGENDAMENTO E_AG
ON 
E_CT.CD_ELO_AGENDAMENTO = E_AG.CD_ELO_AGENDAMENTO

INNER JOIN CTE_ELO_AGENDAMENTO CTE_AG
ON
E_AG.CD_ELO_AGENDAMENTO = CTE_AG.CD_ELO_AGENDAMENTO


INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR E_A_SUP  --INSERIR LINHAS
ON
E_A_SUP.CD_ELO_AGENDAMENTO = E_AG.CD_ELO_AGENDAMENTO
AND E_A_SUP.IC_ATIVO = 'S'

INNER JOIN VND.ELO_AGENDAMENTO_ITEM E_AG_ITEM
ON
E_AG_ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = E_A_SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
AND E_AG_ITEM.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
AND E_AG_ITEM.IC_ATIVO = 'S'
--WHERE E_CT.CD_ELO_CARTEIRA = 100000000
LEFT JOIN VND.ELO_STATUS E_ST_AG
ON 
E_AG.CD_ELO_STATUS = E_ST_AG.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_ECT_LOG
ON 
E_CT.CD_STATUS_LOGISTICA = E_ST_ECT_LOG.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_BLC
ON 
E_CT.CD_STATUS_BACKLOG_CIF = E_ST_BLC.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_CONTR
ON
E_CT.CD_STATUS_CONTROLADORIA =  E_ST_CONTR.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_CTF
ON
E_CT.CD_STATUS_TORRE_FRETES =  E_ST_CTF.CD_ELO_STATUS
AND E_ST_CTF.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')  -- STATUS CARTEIRA TORRE FRETES 
INNER JOIN VND.ELO_STATUS E_ST_CS
ON
E_CT.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS

LEFT JOIN VND.ELO_STATUS E_ST_PL_RE
ON
E_CT.CD_TIPO_AGENDAMENTO =  E_ST_PL_RE.CD_ELO_STATUS
--AND E_ST_PL_RE.SG_STATUS IN ('PLAN', 'REPLAN')

LEFT JOIN  VND.TRANSPORTADORA V_TRA
ON V_TRA.CD_TRANSPORTADORA =  E_CTF.CD_TRANSPORTADORA

LEFT JOIN VND.GRUPO_EMBALAGEM EMBL
ON 
E_CT.CD_GRUPO_EMBALAGEM = EMBL.CD_GRUPO_EMBALAGEM
AND EMBL.IC_ATIVO = 'S'

WHERE 
1=1
AND E_CT.IC_ATIVO = 'S'
AND E_CT.CD_INCOTERMS = 'CIF'
AND E_AG_ITEM.CD_INCOTERMS = 'CIF'
/*
AND NVL(E_AG.CD_POLO, '9999') = NVL(L_CD_POLO, NVL(E_AG.CD_POLO, '9999'))
AND NVL(E_AG.CD_CENTRO_EXPEDIDOR, '9999') = NVL(L_CD_CENTRO_EXPEDIDOR, NVL(E_AG.CD_CENTRO_EXPEDIDOR, '9999')) -- 6001
AND NVL(E_AG.CD_MACHINE, 9999) = NVL(L_MACHINE, NVL(E_AG.CD_MACHINE, 9999)) -- 6001

AND (    TO_CHAR(E_AG.DT_WEEK_START,'WW')  BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'),'WW')
         AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD'),'WW'))
AND (    TO_CHAR(E_AG.DT_WEEK_START, 'YYYY') BETWEEN TO_CHAR(to_date(L_DT_WEEK_FROM,'YYYY-MM-DD'), 'YYYY')
         AND TO_CHAR(to_date(L_DT_WEEK_TO,'YYYY-MM-DD'), 'YYYY'))
*/
AND E_AG.IC_ATIVO = 'S'
--AND E_CT.CD_ELO_CARTEIRA = 100000000
AND E_CT.IC_COOPERATIVE IN ('S', 'N')
AND E_ST_CS.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')  -- STATUS CARTEIRA CUSTOMER SERVICE

--AND ROWNUM < =2
/*
) FILTER
ON
FILTER.CD_ELO_CARTEIRA = PAR1.CD_ELO_CARTEIRA 
AND FILTER.CD_ELO_AGENDAMENTO_ITEM = PAR1.CD_ELO_AGENDAMENTO_ITEM
WHERE FILTER.CD_ELO_CARTEIRA IS NULL
*/
--SELECT  * FROM VND.ELO_CARTEIRA WHERE CD_ELO_CARTEIRA = 100000020

;

    END PX_GET_TORRE_FRETES_EXCEL;


    PROCEDURE PX_GET_TF_TRANSPSUMMARY (
        P_CD_ELO_CARTEIRA   IN VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE,
        P_RETURN                OUT T_CURSOR
    )

    IS

        L_CD_ELO_CARTEIRA   VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE;

BEGIN


OPEN P_RETURN FOR

WITH CTE_WHO_GRP AS 
(
SELECT WCT.CD_ELO_CARTEIRA, WCT.CD_ELO_CARTEIRA_GROUPING 
FROM VND.ELO_CARTEIRA_GROUPING WCT
INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CT
ON 
E_CT.CD_ELO_CARTEIRA_GROUPING = WCT.CD_ELO_CARTEIRA_GROUPING
WHERE 
E_CT.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA
GROUP BY WCT.CD_ELO_CARTEIRA, 
WCT.CD_ELO_CARTEIRA_GROUPING

)


SELECT 
GRSAP.CD_ELO_CARTEIRA,
GRSAP.CD_ELO_AGENDAMENTO_ITEM,
GRSAP.CD_WEEK,
GRSAP.CD_POLO,
GRSAP.CD_CENTRO_EXPEDIDOR,
GRSAP.CD_MACHINE,
GRSAP.NU_ORDEM_VENDA,
GRSAP.LIST_OF_NR_PROTOCOLO,
GRSAP.CD_COTA_COMPARTILHADA,
GRSAP.CD_CLIENTE,
GRSAP.NO_CLIENTE,
GRSAP.COOPERADO,
GRSAP.DESTINO,
GRSAP.CD_PRODUTO_SAP,
GRSAP.NO_PRODUTO_SAP,
GRSAP.CD_GRUPO_EMBALAGEM,
SUM(GRSAP.QT_PROGRAMADA) QT_PROGRAMADA,
SUM(GRSAP.QT_ENTREGUE)  QT_ENTREGUE,
SUM(GRSAP.QT_SALDO) QT_SALDO,
GRSAP.IC_EMERGENCIAL,
SUM(GRSAP.QT_EMERGENCIAL) QT_EMERGENCIAL,
GRSAP.DS_ROTEIRO_ENTREGA,
GRSAP.VL_FRETE_DISTRIBUICAO,
GRSAP.CD_INDICADOR_COMPOSICAO_CARGA,
SUM(GRSAP.NUQ_SEG) NUQ_SEG,
SUM(GRSAP.NUQ_TER) NUQ_TER,
SUM(GRSAP.NUQ_QUA) NUQ_QUA,
SUM(GRSAP.NUQ_QUI) NUQ_QUI,
SUM(GRSAP.NUQ_SEX) NUQ_SEX,
SUM(GRSAP.NUQ_SAB) NUQ_SAB,
SUM(GRSAP.NUQ_DOM) NUQ_DOM,
GRSAP.DS_STATUS_TIPO_AGENDAMENTO,
SUM(GRSAP.QT_MARCACAO_CARREGADO_FAT) QT_MARCACAO_CARREGADO_FAT,
SUM(GRSAP.QT_MARCACAO_EM_CARREGAMENTO) QT_MARCACAO_EM_CARREGAMENTO,
SUM(GRSAP.QT_MARCACAO_ANTECIPADO) QT_MARCACAO_ANTECIPADO,
SUM(GRSAP.QT_AGENDAMENTO_SOMA) QT_AGENDAMENTO_SOMA,
SUM(GRSAP.QT_MARCACAO_VOL_REAL) QT_MARCACAO_VOL_REAL,
SUM(GRSAP.QT_MARCACAO_VOL_REAL_PLANO) QT_MARCACAO_VOL_REAL_PLANO,
SUM(GRSAP.QT_MARCACAO_VOL_REAL_MENOR) QT_MARCACAO_VOL_REAL_MENOR,
SUM(GRSAP.QT_SALDO_PROGRAMADA) QT_SALDO_PROGRAMADA

FROM 
(

SELECT --DISTINCT

E_SEL.CD_ELO_CARTEIRA ,
E_SEL.CD_ELO_AGENDAMENTO_ITEM ,

E_AG.CD_WEEK,
E_AG.CD_POLO, 
NVL(E_AG.CD_CENTRO_EXPEDIDOR, E_SEL.CD_CENTRO_EXPEDIDOR ) CD_CENTRO_EXPEDIDOR,                    
NVL(E_AG.CD_MACHINE,  0) CD_MACHINE,  
E_SEL.NU_ORDEM_VENDA ,  --OV

CASE
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
    FX_GET_NR_PROTOCOLO(E_CT.CD_ELO_CARTEIRA_GROUPING)
    ELSE '***' END LIST_OF_NR_PROTOCOLO, 

E_AG_ITEM.CD_COTA_COMPARTILHADA,   
E_SEL.CD_CLIENTE ,
E_SEL.NO_CLIENTE ,

CASE
WHEN E_CT.IC_COOPERATIVE = 'S' THEN 
    FX_GET_COOPERADO(E_CT.CD_ELO_CARTEIRA_GROUPING ) ELSE '***' END COOPERADO, 

NVL(E_SEL.NO_MUNICIPIO, '') || '-' || NVL(E_SEL.SG_ESTADO, '') DESTINO,
E_SEL.CD_PRODUTO_SAP ,
E_SEL.NO_PRODUTO_SAP ,
E_SEL.CD_GRUPO_EMBALAGEM || '-' || EMBL.DS_GRUPO_EMBALAGEM CD_GRUPO_EMBALAGEM,


NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) QT_PROGRAMADA,
NVL(E_CT.QT_ENTREGUE ,0) QT_ENTREGUE,
COALESCE( E_CT.QT_SALDO_REFRESH,E_CT.QT_SALDO, 0) QT_SALDO,

DECODE( E_SEL.IC_EMERGENCIAL, 'S', 'S', 'N') IC_EMERGENCIAL,
E_CT.QT_EMERGENCIAL,
E_SEL.DS_ROTEIRO_ENTREGA ,
NVL(E_SEL.VL_FRETE_DISTRIBUICAO, 0) VL_FRETE_DISTRIBUICAO, 

(   SELECT 
    MAX(EAG_GRO_I.CD_AGRUPAMENTO_PROTOCOLO) CD_AGRUPAMENTO_PROTOCOLO 

    FROM VND.VW_ELO_CARTEIRA_ALL EC_I

    INNER JOIN VND.ELO_AGENDAMENTO EAG_I
    ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
    ON 
    EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
    AND EA_SUP_I.IC_ATIVO = 'S'
    INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
    ON 
    EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
    AND EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EC_I.CD_ELO_AGENDAMENTO_ITEM
    AND EAG_ITEM_I.IC_ATIVO = 'S'	
    INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
    ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
    INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
    ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
    --AND EAG_GRO_I.SG_TIPO_DOCUMENTO = 'P'

    WHERE 
    EC_I.CD_ELO_AGENDAMENTO = E_CT.CD_ELO_AGENDAMENTO
    AND EC_I.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
    AND EC_I.IC_ATIVO = 'S'
    AND EC_I.CD_INCOTERMS = 'CIF'
    AND EC_I.IC_COOPERATIVE IN ('S')
    AND EAG_GRO_I.CD_AGRUPAMENTO_PROTOCOLO IS NOT NULL
    GROUP BY EC_I.CD_ELO_AGENDAMENTO, EC_I.CD_ELO_AGENDAMENTO_ITEM
) CD_INDICADOR_COMPOSICAO_CARGA,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 1 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SEG,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 2 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_TER,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 3
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_QUA,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 4 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_QUI,    

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 5 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SEX,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 6 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_SAB,    

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND (1 + TRUNC (E_MAR.dh_saida) - TRUNC (E_MAR.dh_saida, 'IW')) = 7 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  NUQ_DOM,       


NVL(E_SEL.CD_TIPO_AGENDAMENTO ,0) CD_TIPO_AGENDAMENTO,   --MAS CONHECIDO COMO PLAN E REPLAN
CASE 
WHEN NVL(E_ST_PL_RE.SG_STATUS, 'ORIGINAL')  IN ('ORIGINAL', 'INCLUSAO', 'PLAN') THEN 'PLAN'
WHEN E_ST_PL_RE.SG_STATUS = 'REPLAN' THEN 'REPLAN' ELSE 'PLAN' END DS_STATUS_TIPO_AGENDAMENTO,


NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO_CARREGADO_FAT,  --CHANGE BY PAULO 2018.01.18 BY ADRIANO QT_MARCACAO_EM_CARREGAMENTO

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO_EM_CARREGAMENTO,  --CHANGE BY PAULO 2018.01.18 BY ADRIANO QT_MARCACAO_CARREGADO_FAT


0 QT_MARCACAO_ANTECIPADO,


NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.VW_ELO_CARTEIRA_ALL E_CART
    ON
    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    E_CT.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG'
    GROUP BY E_CART.CD_ELO_CARTEIRA),0)  QT_AGENDAMENTO_SOMA,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NOT NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO_VOL_REAL,

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    INNER JOIN VND.ELO_CARTEIRA E_CART
    ON
    E_CART.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    E_CT.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND I_ST_PL_RE.SG_STATUS = 'PLAN'
    AND E_MAR.DH_SAIDA IS NOT NULL
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'TIPAG'
    GROUP BY E_CART.CD_ELO_CARTEIRA),0)   QT_MARCACAO_VOL_REAL_PLANO,

(NVL(E_CT.QT_AGENDADA_CONFIRMADA, 0)  -

NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR 
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_MAR.DH_SAIDA IS NULL 
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)
) QT_MARCACAO_VOL_REAL_MENOR,

NVL(E_CT.QT_AGENDADA_CONFIRMADA , 0 ) - 
NVL(( SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
    FROM VND.ELO_MARCACAO E_MAR
    WHERE 
    E_MAR.IC_ATIVO = 'S'
    AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
    GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_SALDO_PROGRAMADA


FROM  VND.VW_ELO_CARTEIRA_ALL E_CT
--- TO ADD GROUP BY AND FILTER BY  CARTEIRA GROUP´S RANGE  
INNER JOIN CTE_WHO_GRP WGRP    --HERE FILTER BY CARTEIRA GROUPING
ON E_CT.CD_ELO_CARTEIRA_GROUPING = WGRP.CD_ELO_CARTEIRA_GROUPING
INNER JOIN VND.ELO_CARTEIRA E_SEL  -- HERE CHOOSE CARTEIRA 
ON WGRP.CD_ELO_CARTEIRA = E_SEL.CD_ELO_CARTEIRA
--- TO ADD GROUP BY AND FILTER BY  CARTEIRA GROUP´S RANGE

INNER JOIN VND.ELO_AGENDAMENTO E_AG
ON 
E_CT.CD_ELO_AGENDAMENTO = E_AG.CD_ELO_AGENDAMENTO
INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR E_A_SUP  
ON
E_A_SUP.CD_ELO_AGENDAMENTO = E_AG.CD_ELO_AGENDAMENTO
AND E_A_SUP.IC_ATIVO = 'S'

INNER JOIN VND.ELO_AGENDAMENTO_ITEM E_AG_ITEM
ON
E_AG_ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = E_A_SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
AND E_AG_ITEM.CD_ELO_AGENDAMENTO_ITEM = E_CT.CD_ELO_AGENDAMENTO_ITEM
AND E_AG_ITEM.IC_ATIVO = 'S'

LEFT JOIN VND.ELO_STATUS E_ST_AG
ON 
E_AG.CD_ELO_STATUS = E_ST_AG.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_ECT_LOG
ON 
E_CT.CD_STATUS_LOGISTICA = E_ST_ECT_LOG.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_BLC
ON 
E_CT.CD_STATUS_BACKLOG_CIF = E_ST_BLC.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_CONTR
ON
E_CT.CD_STATUS_CONTROLADORIA =  E_ST_CONTR.CD_ELO_STATUS
LEFT JOIN VND.ELO_STATUS E_ST_CTF
ON
E_CT.CD_STATUS_TORRE_FRETES =  E_ST_CTF.CD_ELO_STATUS
AND E_ST_CTF.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')  -- STATUS CARTEIRA TORRE FRETES 
INNER JOIN VND.ELO_STATUS E_ST_CS
ON
E_CT.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS

LEFT JOIN VND.ELO_STATUS E_ST_PL_RE
ON
E_CT.CD_TIPO_AGENDAMENTO =  E_ST_PL_RE.CD_ELO_STATUS

LEFT JOIN VND.GRUPO_EMBALAGEM EMBL
ON 
E_CT.CD_GRUPO_EMBALAGEM = EMBL.CD_GRUPO_EMBALAGEM
AND EMBL.IC_ATIVO = 'S' 

WHERE 

E_CT.IC_ATIVO = 'S'
AND E_CT.CD_INCOTERMS = 'CIF'
AND E_AG_ITEM.CD_INCOTERMS = 'CIF'

AND E_AG.IC_ATIVO = 'S'
--AND E_CT.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA

AND E_CT.IC_COOPERATIVE IN ('S', 'N')
AND E_ST_CS.SG_STATUS IN ('CANEW', 'CAPRO', 'CAFIN')  -- STATUS CARTEIRA CUSTOMER SERVICE

) GRSAP



GROUP BY 
GRSAP.CD_ELO_CARTEIRA,
GRSAP.CD_ELO_AGENDAMENTO_ITEM,
GRSAP.CD_WEEK,
GRSAP.CD_POLO,
GRSAP.CD_CENTRO_EXPEDIDOR,
GRSAP.CD_MACHINE,
GRSAP.NU_ORDEM_VENDA,
GRSAP.LIST_OF_NR_PROTOCOLO,
GRSAP.CD_COTA_COMPARTILHADA,
GRSAP.CD_CLIENTE,
GRSAP.NO_CLIENTE,
GRSAP.COOPERADO,
GRSAP.DESTINO,
GRSAP.CD_PRODUTO_SAP,
GRSAP.NO_PRODUTO_SAP,
GRSAP.CD_GRUPO_EMBALAGEM,
GRSAP.IC_EMERGENCIAL,
GRSAP.DS_ROTEIRO_ENTREGA,
GRSAP.VL_FRETE_DISTRIBUICAO,
GRSAP.CD_INDICADOR_COMPOSICAO_CARGA,
GRSAP.DS_STATUS_TIPO_AGENDAMENTO;



END PX_GET_TF_TRANSPSUMMARY;




    PROCEDURE PX_GET_TORRE_FRETES_NOVATRANSP (
        P_CD_ELO_CARTEIRA       IN VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE,
        P_RETURN                OUT T_CURSOR
    )

    IS

BEGIN


        OPEN P_RETURN FOR

SELECT 

TF.CD_ELO_CARTEIRA_TORRE_FRETES ,
TF.CD_TRANSPORTADORA  ,        
TF.NU_SEMANA  ,    
TF.NU_DIA_SEMANA  ,    
TF.NU_QUANTIDADE   ,
TF.VL_FRETE_CONTRATADO  ,
TF.DS_OBSERVACAO_TORRE_FRETES  ,
TF.CD_ELO_CARTEIRA   ,    
TF.CD_DIA_EXATO   ,      
TF.CD_PERMITIR_ALTERACAO_CS  , 

---------- CONTRATACAO TORRES FRETES DIA EXATO----------
CASE 
WHEN TF.CD_DIA_EXATO = 'S' AND TF.NU_DIA_SEMANA = 1 THEN TF.CD_DIA_EXATO
ELSE 'N' END CTF_SEG,
CASE 
WHEN TF.CD_DIA_EXATO = 'S' AND TF.NU_DIA_SEMANA = 2 THEN TF.CD_DIA_EXATO
ELSE 'N' END CTF_TER,
CASE 
WHEN TF.CD_DIA_EXATO = 'S' AND TF.NU_DIA_SEMANA = 3 THEN TF.CD_DIA_EXATO
ELSE 'N' END CTF_QUA,
CASE 
WHEN TF.CD_DIA_EXATO = 'S' AND TF.NU_DIA_SEMANA = 4 THEN TF.CD_DIA_EXATO
ELSE 'N' END CTF_QUI,
CASE 
WHEN TF.CD_DIA_EXATO = 'S' AND TF.NU_DIA_SEMANA = 5 THEN TF.CD_DIA_EXATO
ELSE 'N' END CTF_SEX,
CASE 
WHEN TF.CD_DIA_EXATO = 'S' AND TF.NU_DIA_SEMANA = 6 THEN TF.CD_DIA_EXATO
ELSE 'N' END CTF_SAB,
CASE 
WHEN TF.CD_DIA_EXATO = 'S' AND TF.NU_DIA_SEMANA = 7 THEN TF.CD_DIA_EXATO
ELSE 'N' END CTF_DOM,
TF.NU_PROTOCOLO

---------



FROM  VND.ELO_CARTEIRA_TORRE_FRETES TF
WHERE 
TF.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA;


    END PX_GET_TORRE_FRETES_NOVATRANSP;



   FUNCTION FX_GET_NR_PROTOCOLO(
           P_CD_ELO_AGENDAMENTO VND.ELO_CARTEIRA.CD_ELO_AGENDAMENTO%TYPE,
           P_CD_ELO_AGENDAMENTO_ITEM VND.ELO_CARTEIRA.CD_ELO_AGENDAMENTO_ITEM%TYPE 
   )
    RETURN VARCHAR2 IS

    P_RETORNO         VARCHAR2(1000);

    JOINPROTOCOLO VARCHAR2(10000):=' ';


        CURSOR C_PROTOCOLO IS
        SELECT DISTINCT VBAKPROT.NU_PROTOCOLO

        FROM VND.ELO_CARTEIRA EC_I
        LEFT JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTF
        ON
        EC_I.CD_ELO_CARTEIRA = E_CTF.CD_ELO_CARTEIRA         

--        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
--        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--
--		INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
--        ON 
--        EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--        AND EA_SUP_I.IC_ATIVO = 'S'
--
--		INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
--
--        ON 
--		EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
--        AND EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EC_I.CD_ELO_AGENDAMENTO_ITEM
--        AND EAG_ITEM_I.IC_ATIVO = 'S'	
--
--		INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
--        ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
--
--		INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
--        ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
--        AND EAG_GRO_I.SG_TIPO_DOCUMENTO = 'P'
--
--		INNER JOIN CPT.ENTREGA CPT_ENT
--        ON CPT_ENT.NU_PROTOCOLO_ENTREGA = EAG_GRO_I.NU_DOCUMENTO
--        INNER JOIN CPT.ENTREGA CPT_ENT
--        ON 
--        CPT_ENT.NU_PROTOCOLO_ENTREGA = EC_I.NU_PROTOCOLO

        INNER JOIN VND.ELO_VBAK_PROTOCOLO VBAKPROT
        ON 
        VBAKPROT.CD_ELO_CARTEIRA = EC_I.CD_ELO_CARTEIRA

--		INNER JOIN CPT.AUTORIZACAO_ENTREGA CPT_AUT_ENT 
--        ON CPT_AUT_ENT.CD_AUTORIZACAO_ENTREGA = CPT_ENT.CD_AUTORIZACAO_ENTREGA

		WHERE 
        EC_I.CD_ELO_AGENDAMENTO = P_CD_ELO_AGENDAMENTO
        AND EC_I.CD_ELO_AGENDAMENTO_ITEM = P_CD_ELO_AGENDAMENTO_ITEM
        AND EC_I.IC_ATIVO = 'S'
        AND VBAKPROT.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND VBAKPROT.QT_AGENDADA_PROTOCOLO > 0
        AND EC_I.IC_COOPERATIVE IN ('S');

BEGIN 


    FOR CA IN C_PROTOCOLO
    LOOP

        JOINPROTOCOLO:= JOINPROTOCOLO || '|' || NVL(CA.NU_PROTOCOLO, ' ' );
        EXIT WHEN LENGTH(TRIM(JOINPROTOCOLO)) >= 1002;


    END LOOP;
    IF C_PROTOCOLO%ISOPEN THEN
      CLOSE C_PROTOCOLO;
    END IF;

        JOINPROTOCOLO:=SUBSTR(JOINPROTOCOLO, 3, 1000);
        P_RETORNO := JOINPROTOCOLO ;


    RETURN P_RETORNO;

  END FX_GET_NR_PROTOCOLO;   


   FUNCTION FX_GET_NR_PROTOCOLO(
     P_CD_ELO_CARTEIRA_GROUPING VND.ELO_CARTEIRA.CD_ELO_CARTEIRA_GROUPING%TYPE
   
   )
    RETURN VARCHAR2 IS

    P_RETORNO         VARCHAR2(1000);

    JOINPROTOCOLO VARCHAR2(10000):=' ';


        CURSOR C_PROTOCOLO IS
        SELECT VBAKPROT.NU_PROTOCOLO || ':' || TO_CHAR(round(MAX(VBAKPROT.QT_AGENDADA_PROTOCOLO),0)) NU_PROTOCOLO 

        FROM VND.ELO_CARTEIRA EC_I
        LEFT JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTF
        ON
        EC_I.CD_ELO_CARTEIRA = E_CTF.CD_ELO_CARTEIRA         

--        INNER JOIN CPT.ENTREGA CPT_ENT
--        ON 
--        CPT_ENT.NU_PROTOCOLO_ENTREGA = EC_I.NU_PROTOCOLO
--
--		INNER JOIN CPT.AUTORIZACAO_ENTREGA CPT_AUT_ENT 
--        ON CPT_AUT_ENT.CD_AUTORIZACAO_ENTREGA = CPT_ENT.CD_AUTORIZACAO_ENTREGA

        INNER JOIN VND.ELO_VBAK_PROTOCOLO VBAKPROT
        ON 
        VBAKPROT.CD_ELO_CARTEIRA = EC_I.CD_ELO_CARTEIRA

		WHERE 
        EC_I.CD_ELO_CARTEIRA_GROUPING = P_CD_ELO_CARTEIRA_GROUPING
        AND EC_I.IC_ATIVO = 'S'
        AND VBAKPROT.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND VBAKPROT.QT_AGENDADA_PROTOCOLO > 0
        AND EC_I.IC_COOPERATIVE IN ('S')
        GROUP BY VBAKPROT.NU_PROTOCOLO;

BEGIN 


    FOR CA IN C_PROTOCOLO
    LOOP

        JOINPROTOCOLO:= JOINPROTOCOLO || '|' || NVL(CA.NU_PROTOCOLO, ' ' );
        EXIT WHEN LENGTH(TRIM(JOINPROTOCOLO)) >= 1002;


    END LOOP;
    IF C_PROTOCOLO%ISOPEN THEN
      CLOSE C_PROTOCOLO;
    END IF;

        JOINPROTOCOLO:=SUBSTR(JOINPROTOCOLO, 3, 1000);
        P_RETORNO := JOINPROTOCOLO ;


    RETURN P_RETORNO;

  END FX_GET_NR_PROTOCOLO;   


   FUNCTION FX_GET_COOPERADO(
           P_CD_ELO_AGENDAMENTO VND.ELO_CARTEIRA.CD_ELO_AGENDAMENTO%TYPE,
           P_CD_ELO_AGENDAMENTO_ITEM VND.ELO_CARTEIRA.CD_ELO_AGENDAMENTO_ITEM%TYPE 
   )
    RETURN VARCHAR2 IS

    P_RETORNO         VARCHAR2(1000);

    JOINPROTOCOLO VARCHAR2(10000):=' ';


        CURSOR C_PROTOCOLO IS
        SELECT 
        DISTINCT 
        --CPT_COOPERADO.CD_COOPERADO , CPT_COOPERADO.NO_COOPERADO
        
        NVL(PROP_COOP.CD_CLIENTE, COOP_FILIAL.CD_CLIENTE) CD_COOPERADO,
        NVL(CLI_PROP.NO_CLIENTE, CLI_FILIAL.NO_CLIENTE) NO_COOPERADO

        FROM VND.ELO_CARTEIRA EC_I
        LEFT JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTF
        ON
        EC_I.CD_ELO_CARTEIRA = E_CTF.CD_ELO_CARTEIRA         

--        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
--        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--
--		INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
--        ON 
--        EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
--        AND EA_SUP_I.IC_ATIVO = 'S'
--
--		INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
--
--        ON 
--		EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
--        AND EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EC_I.CD_ELO_AGENDAMENTO_ITEM
--        AND EAG_ITEM_I.IC_ATIVO = 'S'	
--
--		INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
--        ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
--
--		INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
--        ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
--        AND EAG_GRO_I.SG_TIPO_DOCUMENTO = 'P'
--
--		INNER JOIN CPT.ENTREGA CPT_ENT
--        ON CPT_ENT.NU_PROTOCOLO_ENTREGA = EAG_GRO_I.NU_DOCUMENTO

        INNER JOIN VND.ELO_VBAK_PROTOCOLO VBAKPROT
        ON 
        VBAKPROT.CD_ELO_CARTEIRA = EC_I.CD_ELO_CARTEIRA

        INNER JOIN CPT.ENTREGA CPT_ENT
        ON
        CPT_ENT.NU_PROTOCOLO_ENTREGA = VBAKPROT.NU_PROTOCOLO

		INNER JOIN CPT.AUTORIZACAO_ENTREGA CPT_AUT_ENT 
        ON CPT_AUT_ENT.CD_AUTORIZACAO_ENTREGA = CPT_ENT.CD_AUTORIZACAO_ENTREGA

        INNER JOIN CPT.COOPERADO CPT_COOPERADO
        ON 
        CPT_AUT_ENT.CD_COOPERADO = CPT_COOPERADO.CD_COOPERADO
        
        LEFT JOIN CPT.PROPRIEDADE_COOPERADO PROP_COOP
        ON PROP_COOP.CD_PROPRIEDADE =  CPT_AUT_ENT.CD_PROPRIEDADE 
        LEFT JOIN CPT.COOPERATIVA_FILIAL COOP_FILIAL
        ON COOP_FILIAL.CD_COOPERATIVA_FILIAL = CPT_AUT_ENT.CD_COOPERATIVA_FILIAL
        
        LEFT JOIN CTF.CLIENTE CLI_PROP
        ON CLI_PROP.CD_CLIENTE = PROP_COOP.CD_CLIENTE

        LEFT JOIN CTF.CLIENTE CLI_FILIAL
        ON CLI_FILIAL.CD_CLIENTE = COOP_FILIAL.CD_CLIENTE       

		WHERE 
        EC_I.CD_ELO_AGENDAMENTO = P_CD_ELO_AGENDAMENTO
        AND EC_I.CD_ELO_AGENDAMENTO_ITEM = P_CD_ELO_AGENDAMENTO_ITEM
        AND EC_I.IC_ATIVO = 'S'
        AND VBAKPROT.IC_ATIVO = 'S'
        AND VBAKPROT.QT_AGENDADA_PROTOCOLO > 0
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND EC_I.IC_COOPERATIVE IN ('S')
--        GROUP BY 
--         CPT_COOPERADO.CD_COOPERADO , CPT_COOPERADO.NO_COOPERADO;
        ;

BEGIN 


    FOR CA IN C_PROTOCOLO
    LOOP

        JOINPROTOCOLO:= JOINPROTOCOLO || '|' || NVL(CA.NO_COOPERADO, ' ' );
        EXIT WHEN LENGTH(TRIM(JOINPROTOCOLO)) >= 1002;

    END LOOP;
    IF C_PROTOCOLO%ISOPEN THEN
      CLOSE C_PROTOCOLO;
    END IF;

        JOINPROTOCOLO:=SUBSTR(JOINPROTOCOLO, 3, 1000);
        P_RETORNO := JOINPROTOCOLO ;


    RETURN P_RETORNO;

  END FX_GET_COOPERADO;   


   FUNCTION FX_GET_COOPERADO(
           P_CD_ELO_CARTEIRA_GROUPING VND.ELO_CARTEIRA.CD_ELO_CARTEIRA_GROUPING%TYPE
   )
    RETURN VARCHAR2 IS

    P_RETORNO         VARCHAR2(1000);

    JOINPROTOCOLO VARCHAR2(10000):=' ';


        CURSOR C_PROTOCOLO IS
        SELECT 
        DISTINCT 
        --CPT_COOPERADO.CD_COOPERADO , CPT_COOPERADO.NO_COOPERADO
        
        NVL(PROP_COOP.CD_CLIENTE, COOP_FILIAL.CD_CLIENTE) CD_COOPERADO,
        NVL(CLI_PROP.NO_CLIENTE, CLI_FILIAL.NO_CLIENTE) NO_COOPERADO

        FROM VND.ELO_CARTEIRA EC_I
        LEFT JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTF
        ON
        EC_I.CD_ELO_CARTEIRA = E_CTF.CD_ELO_CARTEIRA  
        INNER JOIN VND.ELO_VBAK_PROTOCOLO VBAKPROT
        ON 
        VBAKPROT.CD_ELO_CARTEIRA = EC_I.CD_ELO_CARTEIRA

        INNER JOIN CPT.ENTREGA CPT_ENT
        ON
        CPT_ENT.NU_PROTOCOLO_ENTREGA = VBAKPROT.NU_PROTOCOLO

		INNER JOIN CPT.AUTORIZACAO_ENTREGA CPT_AUT_ENT 
        ON CPT_AUT_ENT.CD_AUTORIZACAO_ENTREGA = CPT_ENT.CD_AUTORIZACAO_ENTREGA

        LEFT JOIN CPT.COOPERADO CPT_COOPERADO
        ON 
        CPT_AUT_ENT.CD_COOPERADO = CPT_COOPERADO.CD_COOPERADO
        
        LEFT JOIN CPT.PROPRIEDADE_COOPERADO PROP_COOP
        ON PROP_COOP.CD_PROPRIEDADE =  CPT_AUT_ENT.CD_PROPRIEDADE 
        LEFT JOIN CPT.COOPERATIVA_FILIAL COOP_FILIAL
        ON COOP_FILIAL.CD_COOPERATIVA_FILIAL = CPT_AUT_ENT.CD_COOPERATIVA_FILIAL
        
        LEFT JOIN CTF.CLIENTE CLI_PROP
        ON CLI_PROP.CD_CLIENTE = PROP_COOP.CD_CLIENTE

        LEFT JOIN CTF.CLIENTE CLI_FILIAL
        ON CLI_FILIAL.CD_CLIENTE = COOP_FILIAL.CD_CLIENTE       

		WHERE 
        EC_I.CD_ELO_CARTEIRA_GROUPING = P_CD_ELO_CARTEIRA_GROUPING
        AND EC_I.IC_ATIVO = 'S'
        AND VBAKPROT.IC_ATIVO = 'S'
        AND VBAKPROT.QT_AGENDADA_PROTOCOLO > 0
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND EC_I.IC_COOPERATIVE IN ('S')
        ;

BEGIN 


    FOR CA IN C_PROTOCOLO
    LOOP

        JOINPROTOCOLO:= JOINPROTOCOLO || '|' || NVL(CA.NO_COOPERADO, ' ' );
        EXIT WHEN LENGTH(TRIM(JOINPROTOCOLO)) >= 1002;

    END LOOP;
    IF C_PROTOCOLO%ISOPEN THEN
      CLOSE C_PROTOCOLO;
    END IF;

        JOINPROTOCOLO:=SUBSTR(JOINPROTOCOLO, 3, 1000);
        P_RETORNO := JOINPROTOCOLO ;


    RETURN P_RETORNO;

  END FX_GET_COOPERADO;   


   FUNCTION FX_GET_TF_TRANSPORTADORAS(
           P_CD_ELO_CARTEIRA VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE

   )
    RETURN VARCHAR2 IS

    P_RETORNO         VARCHAR2(1000);

    JOINPROTOCOLO VARCHAR2(10000):=' ';


        CURSOR C_PROTOCOLO IS
        SELECT V_TRA.CD_TRANSPORTADORA , V_TRA.NO_TRANSPORTADORA

        FROM VND.ELO_CARTEIRA EC_I
        INNER JOIN VND.ELO_CARTEIRA_TORRE_FRETES E_CTF
        ON
        EC_I.CD_ELO_CARTEIRA = E_CTF.CD_ELO_CARTEIRA         

        INNER JOIN  VND.TRANSPORTADORA V_TRA
        ON V_TRA.CD_TRANSPORTADORA =  E_CTF.CD_TRANSPORTADORA



		WHERE 
        EC_I.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA

        AND EC_I.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        --AND EC_I.IC_COOPERATIVE IN ('S')
        GROUP BY 
         V_TRA.CD_TRANSPORTADORA , V_TRA.NO_TRANSPORTADORA;

BEGIN 


    FOR CA IN C_PROTOCOLO
    LOOP

        JOINPROTOCOLO:= JOINPROTOCOLO || '|' || NVL(CA.NO_TRANSPORTADORA, ' ' );
        EXIT WHEN LENGTH(TRIM(JOINPROTOCOLO)) >= 1002;

    END LOOP;
    IF C_PROTOCOLO%ISOPEN THEN
      CLOSE C_PROTOCOLO;
    END IF;

        JOINPROTOCOLO:=SUBSTR(JOINPROTOCOLO, 3, 1000);
        P_RETORNO := JOINPROTOCOLO ;


    RETURN P_RETORNO;

  END FX_GET_TF_TRANSPORTADORAS;   



PROCEDURE PX_ALLOW_TF_BACKLOG_CIF (
	P_CD_ELO_CARTEIRA       IN VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE,
	P_CD_ELO_AGENDAMENTO   IN VND.ELO_AGENDAMENTO.CD_ELO_AGENDAMENTO%TYPE,
	P_RETURN                OUT T_CURSOR
)

IS


BEGIN
OPEN P_RETURN FOR

SELECT 

    E_CT.CD_ELO_CARTEIRA, 
    E_CT.CD_ELO_AGENDAMENTO,

    NVL((SELECT 1 
    FROM VND.ELO_CARTEIRA E_CART
    INNER JOIN VND.ELO_STATUS I_ST_PL_RE
    ON
    E_CART.CD_TIPO_AGENDAMENTO =  I_ST_PL_RE.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_RE
    ON 
    I_ST_PL_RE.CD_ELO_TIPO_STATUS = I_ST_TIPO_RE.CD_ELO_TIPO_STATUS

    WHERE 
    E_CT.CD_ELO_CARTEIRA = E_CART.CD_ELO_CARTEIRA
    AND NOT(I_ST_PL_RE.SG_STATUS  IN('PLAN', 'AGCTR', 'AGENC'))  --EM EXECUCAO
    AND I_ST_TIPO_RE.SG_TIPO_STATUS  = 'AGEND'
    AND ROWNUM =1 )
    ,0) SEMANA_IS_PLAN,

	NVL((SELECT 1 FROM VND.ELO_CARTEIRA_TORRE_FRETES TF
	WHERE 
	TF.CD_ELO_CARTEIRA = E_CT.CD_ELO_CARTEIRA
	AND NVL(TF.NU_QUANTIDADE, 0) > 0 AND TF.VL_FRETE_CONTRATADO > 0  
	AND ROWNUM = 1 
	), 0) TEM_TRANSPORTE_TF,


NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_MARCACAO E_MAR 
				WHERE 
				E_MAR.IC_ATIVO = 'S'
				--AND E_MAR.DH_SAIDA IS NOT NULL 
                AND E_MAR.CD_MOTIVO_STATUS  IS NULL 
                AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
				GROUP BY E_MAR.CD_ELO_CARTEIRA),0)  QT_MARCACAO,

	CASE 
	WHEN ((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_MARCACAO E_MAR 
				WHERE 
				E_MAR.IC_ATIVO = 'S'
				--AND E_MAR.DH_SAIDA IS NOT NULL 
                AND E_MAR.CD_MOTIVO_STATUS  IS NULL 
                AND E_CT.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
				GROUP BY E_MAR.CD_ELO_CARTEIRA)) - 
        ((SELECT SUM(TF.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_CARTEIRA_TORRE_FRETES TF 
				WHERE 
                E_CT.CD_ELO_CARTEIRA = TF.CD_ELO_CARTEIRA
				GROUP BY E_CT.CD_ELO_CARTEIRA)) = 0 THEN 1

	ELSE 0  


	END 	TODA_QT_AGENDADA_CONFIRMADA,
    NVL(E_CT.QT_AGENDADA_CONFIRMADA, 0) QT_AGENDADA_CONFIRMADA


	FROM VND.ELO_CARTEIRA E_CT
	WHERE E_CT.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA
	AND E_CT.CD_ELO_AGENDAMENTO = DECODE(NVL(P_CD_ELO_AGENDAMENTO, 0 ), 0, E_CT.CD_ELO_AGENDAMENTO ,P_CD_ELO_AGENDAMENTO) ;


END PX_ALLOW_TF_BACKLOG_CIF;

   PROCEDURE PX_GET_SELECT (P_RETURN OUT T_CURSOR) 
   IS
   BEGIN
   /*WHO IS CHANGE MY PACK FOR ME IS VERY CONFUSE PLS CALL MR PAULO IN BRASIL TO CONFIRM OR CREATED ANOTHER ONE LIKE ELO_FREIGFH_TOWER_REASON
        OPEN P_RETURN FOR
        SELECT * FROM ELO_FREIGHT_TOWER_REASON;
        */
                OPEN P_RETURN FOR
        SELECT * FROM VND.ELO_CARTEIRA_TORRE_FRETES;

   END PX_GET_SELECT;

      FUNCTION FX_ALLOW_CHANGE_PERMITIR_CS(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_ELO_CARTEIRA              IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA%TYPE        
    ) RETURN CHAR IS
        V_CD_ELO_CARTEIRA                  VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA%TYPE;
        V_SG_STATUS                         VND.ELO_STATUS.SG_STATUS%TYPE;
        V_TRAVA_STATUS                      BOOLEAN:=TRUE;
        V_RETORNO                            CHAR(1);
    BEGIN

        IF NVL(P_CD_ELO_CARTEIRA, 0) = 0 THEN 
            SELECT CD_ELO_CARTEIRA INTO V_CD_ELO_CARTEIRA FROM VND.ELO_CARTEIRA_TORRE_FRETES
            WHERE 
            CD_ELO_CARTEIRA_TORRE_FRETES = P_CD_ELO_CARTEIRA_TORRE_FRETES;
        ELSE 
            V_CD_ELO_CARTEIRA:= P_CD_ELO_CARTEIRA;
        END IF;



        SELECT ST.SG_STATUS INTO V_SG_STATUS FROM VND.ELO_AGENDAMENTO AG 
        INNER JOIN VND.ELO_CARTEIRA CT
        ON 
        AG.CD_ELO_AGENDAMENTO = CT.CD_ELO_AGENDAMENTO
        INNER JOIN VND.ELO_STATUS ST
        ON
        ST.CD_ELO_STATUS = AG.CD_ELO_STATUS
        WHERE 
        CT.CD_ELO_CARTEIRA = V_CD_ELO_CARTEIRA
--        AND EXISTS (SELECT 1 FROM VND.ELO_CARTEIRA_TORRE_FRETES TF
--                    WHERE 
--                    --TF.CD_ELO_CARTEIRA_TORRE_FRETES = P_CD_ELO_CARTEIRA_TORRE_FRETES
--                    --AND
--                    TF.CD_ELO_CARTEIRA = CT.CD_ELO_CARTEIRA
--                    )
        AND ROWNUM = 1;

        --IF NECESSARY INCLUDE MORE CONDITION OR STATUS TO BLOCK THE IC_PERMITIR_CS TO CHANGE 
        --FREIGHT TOWER 
        --IF SG STATUS IS NULL THEN TAKE AGENC TO NO ALLOW CHANGES
        IF NVL(V_SG_STATUS, 'AGENC') = 'AGENC' THEN 
            V_TRAVA_STATUS:= TRUE;
            ELSE
            V_TRAVA_STATUS:= FALSE;
        END IF;   



        IF NOT V_TRAVA_STATUS THEN 
            V_RETORNO:='S';
        ELSE
            V_RETORNO:='N';

        END IF;

    RETURN V_RETORNO;


    END FX_ALLOW_CHANGE_PERMITIR_CS;  

         PROCEDURE PI_INSERIR_CARTEIRA_FREIGH(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_TRANSPORTADORA            IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_TRANSPORTADORA%TYPE,          
        P_NU_SEMANA                    IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_SEMANA%TYPE,      
        P_NU_DIA_SEMANA                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_DIA_SEMANA%TYPE, 
        P_NU_QUANTIDADE                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_QUANTIDADE%TYPE,     
        P_VL_FRETE_CONTRATADO          IN      VND.ELO_CARTEIRA_TORRE_FRETES.VL_FRETE_CONTRATADO%TYPE,   
        P_DS_OBSERVACAO_TORRE_FRETES   IN      VND.ELO_CARTEIRA_TORRE_FRETES.DS_OBSERVACAO_TORRE_FRETES%TYPE,    
        P_CD_ELO_CARTEIRA              IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA%TYPE,        
        P_CD_DIA_EXATO                 IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_DIA_EXATO%TYPE,           
        P_RETORNO                       OUT T_CURSOR
    ) IS
        V_CD_ELO_CARTEIRA_TORRE_FRETES  VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE;

    BEGIN

        V_CD_ELO_CARTEIRA_TORRE_FRETES:=P_CD_ELO_CARTEIRA_TORRE_FRETES;

        IF P_CD_ELO_CARTEIRA_TORRE_FRETES IS NULL OR P_CD_ELO_CARTEIRA_TORRE_FRETES = 0 THEN 

            SELECT VND.SEQ_ELO_CARTEIRA_TORRE_FRETES.NEXTVAL
            INTO V_CD_ELO_CARTEIRA_TORRE_FRETES FROM DUAL;

        END IF;

        INSERT INTO VND.ELO_CARTEIRA_TORRE_FRETES    

        (        
        CD_ELO_CARTEIRA_TORRE_FRETES,      
        CD_TRANSPORTADORA ,    
        NU_SEMANA ,   
        NU_DIA_SEMANA,       
        NU_QUANTIDADE ,   
        VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES, 
        CD_ELO_CARTEIRA,      
        CD_DIA_EXATO      
        )
        VALUES (
        V_CD_ELO_CARTEIRA_TORRE_FRETES,      
        P_CD_TRANSPORTADORA ,    
        P_NU_SEMANA ,   
        P_NU_DIA_SEMANA,       
        P_NU_QUANTIDADE ,   
        P_VL_FRETE_CONTRATADO,    
        P_DS_OBSERVACAO_TORRE_FRETES, 
        P_CD_ELO_CARTEIRA,      
        P_CD_DIA_EXATO        
        );  
        COMMIT;

        OPEN P_RETORNO FOR
        SELECT 
        CD_ELO_CARTEIRA_TORRE_FRETES,      
        CD_TRANSPORTADORA ,    
        NU_SEMANA ,   
        NU_DIA_SEMANA,       
        NU_QUANTIDADE ,   
        VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES, 
        CD_ELO_CARTEIRA,      
        CD_DIA_EXATO,         
        'N' CD_PERMITIR_ALTERACAO_CS ,
        NU_PROTOCOLO
        FROM VND.ELO_CARTEIRA_TORRE_FRETES 
        WHERE CD_ELO_CARTEIRA_TORRE_FRETES  = V_CD_ELO_CARTEIRA_TORRE_FRETES; 



    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PI_INSERIR_CARTEIRA_FREIGH;


         PROCEDURE PI_INSERIR_CARTEIRA_FREIGH(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_TRANSPORTADORA            IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_TRANSPORTADORA%TYPE,          
        P_NU_SEMANA                    IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_SEMANA%TYPE,      
        P_NU_DIA_SEMANA                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_DIA_SEMANA%TYPE, 
        P_NU_QUANTIDADE                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_QUANTIDADE%TYPE,     
        P_VL_FRETE_CONTRATADO          IN      VND.ELO_CARTEIRA_TORRE_FRETES.VL_FRETE_CONTRATADO%TYPE,   
        P_DS_OBSERVACAO_TORRE_FRETES   IN      VND.ELO_CARTEIRA_TORRE_FRETES.DS_OBSERVACAO_TORRE_FRETES%TYPE,    
        P_CD_ELO_CARTEIRA              IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA%TYPE,        
        P_CD_DIA_EXATO                 IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_DIA_EXATO%TYPE, 
        P_NU_PROTOCOLO                  IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_PROTOCOLO%TYPE,
        P_RETORNO                       OUT T_CURSOR
    ) IS
        V_CD_ELO_CARTEIRA_TORRE_FRETES  VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE;

    BEGIN

        V_CD_ELO_CARTEIRA_TORRE_FRETES:=P_CD_ELO_CARTEIRA_TORRE_FRETES;

        --IF P_CD_ELO_CARTEIRA_TORRE_FRETES IS NULL OR P_CD_ELO_CARTEIRA_TORRE_FRETES = 0 THEN 

            SELECT VND.SEQ_ELO_CARTEIRA_TORRE_FRETES.NEXTVAL
            INTO V_CD_ELO_CARTEIRA_TORRE_FRETES FROM DUAL;

        --END IF;

        INSERT INTO VND.ELO_CARTEIRA_TORRE_FRETES    

        (        
        CD_ELO_CARTEIRA_TORRE_FRETES,      
        CD_TRANSPORTADORA ,    
        NU_SEMANA ,   
        NU_DIA_SEMANA,       
        NU_QUANTIDADE ,   
        VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES, 
        CD_ELO_CARTEIRA,      
        CD_DIA_EXATO  ,
        NU_PROTOCOLO
        )
        VALUES (
        V_CD_ELO_CARTEIRA_TORRE_FRETES,      
        P_CD_TRANSPORTADORA ,    
        P_NU_SEMANA ,   
        P_NU_DIA_SEMANA,       
        P_NU_QUANTIDADE ,   
        P_VL_FRETE_CONTRATADO,    
        P_DS_OBSERVACAO_TORRE_FRETES, 
        P_CD_ELO_CARTEIRA,      
        P_CD_DIA_EXATO  ,
        P_NU_PROTOCOLO
        );  
        COMMIT;

        OPEN P_RETORNO FOR
        SELECT 
        CD_ELO_CARTEIRA_TORRE_FRETES,      
        CD_TRANSPORTADORA ,    
        NU_SEMANA ,   
        NU_DIA_SEMANA,       
        NU_QUANTIDADE ,   
        VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES, 
        CD_ELO_CARTEIRA,      
        CD_DIA_EXATO,         
        'N' CD_PERMITIR_ALTERACAO_CS ,
        NU_PROTOCOLO
        FROM VND.ELO_CARTEIRA_TORRE_FRETES 
        WHERE CD_ELO_CARTEIRA_TORRE_FRETES  = V_CD_ELO_CARTEIRA_TORRE_FRETES; 



    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PI_INSERIR_CARTEIRA_FREIGH;





        PROCEDURE PU_ATUALIZAR_CARTEIRA_FREIGH(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_TRANSPORTADORA            IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_TRANSPORTADORA%TYPE,          
        P_NU_SEMANA                    IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_SEMANA%TYPE,      
        P_NU_DIA_SEMANA                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_DIA_SEMANA%TYPE, 
        P_NU_QUANTIDADE                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_QUANTIDADE%TYPE,     
        P_VL_FRETE_CONTRATADO          IN      VND.ELO_CARTEIRA_TORRE_FRETES.VL_FRETE_CONTRATADO%TYPE,   
        P_DS_OBSERVACAO_TORRE_FRETES   IN      VND.ELO_CARTEIRA_TORRE_FRETES.DS_OBSERVACAO_TORRE_FRETES%TYPE,    
        P_CD_DIA_EXATO                 IN      BOOLEAN,          
        P_RETORNO                       OUT T_CURSOR
    ) IS
    V_CD_DIA_EXATO CHAR(1);
    BEGIN

    IF  P_CD_DIA_EXATO  THEN 
        V_CD_DIA_EXATO:='S';
    ELSE 
        V_CD_DIA_EXATO:='N';
    END IF;

    PU_ATUALIZAR_CARTEIRA_FREIGH(
        P_CD_ELO_CARTEIRA_TORRE_FRETES ,
        P_CD_TRANSPORTADORA            ,          
        P_NU_SEMANA                    ,   
        P_NU_DIA_SEMANA            , 
        P_NU_QUANTIDADE            ,       
        P_VL_FRETE_CONTRATADO   ,         
        P_DS_OBSERVACAO_TORRE_FRETES,      
        V_CD_DIA_EXATO,                       
        P_RETORNO                      

    );

    END PU_ATUALIZAR_CARTEIRA_FREIGH;


      PROCEDURE PU_ATUALIZAR_CARTEIRA_FREIGH(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_TRANSPORTADORA            IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_TRANSPORTADORA%TYPE,          
        P_NU_SEMANA                    IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_SEMANA%TYPE,      
        P_NU_DIA_SEMANA                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_DIA_SEMANA%TYPE, 
        P_NU_QUANTIDADE                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_QUANTIDADE%TYPE,     
        P_VL_FRETE_CONTRATADO          IN      VND.ELO_CARTEIRA_TORRE_FRETES.VL_FRETE_CONTRATADO%TYPE,   
        P_DS_OBSERVACAO_TORRE_FRETES   IN      VND.ELO_CARTEIRA_TORRE_FRETES.DS_OBSERVACAO_TORRE_FRETES%TYPE,    
        P_CD_DIA_EXATO                 IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_DIA_EXATO%TYPE,  
        P_NU_PROTOCOLO                 IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_PROTOCOLO%TYPE,
        P_RETORNO                       OUT T_CURSOR
    ) IS

    V_CD_ELO_CARTEIRA_TORRE_FRETES       VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE;

    BEGIN

        V_CD_ELO_CARTEIRA_TORRE_FRETES:=P_CD_ELO_CARTEIRA_TORRE_FRETES;

        BEGIN
        UPDATE VND.ELO_CARTEIRA_TORRE_FRETES    
        SET      

        CD_TRANSPORTADORA = P_CD_TRANSPORTADORA ,    
        NU_SEMANA = P_NU_SEMANA ,   
        NU_DIA_SEMANA = P_NU_DIA_SEMANA,       
        NU_QUANTIDADE = P_NU_QUANTIDADE ,    
        VL_FRETE_CONTRATADO =  P_VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES = P_DS_OBSERVACAO_TORRE_FRETES, 
        CD_DIA_EXATO = P_CD_DIA_EXATO ,
        NU_PROTOCOLO = P_NU_PROTOCOLO

        WHERE 
        CD_ELO_CARTEIRA_TORRE_FRETES = P_CD_ELO_CARTEIRA_TORRE_FRETES;
        COMMIT;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN 
            V_CD_ELO_CARTEIRA_TORRE_FRETES:=0;

            WHEN OTHERS THEN
                BEGIN
                    V_CD_ELO_CARTEIRA_TORRE_FRETES:=0;
                    RAISE_APPLICATION_ERROR(
                        -20001,
                        'ERRO ENCONTRADO - '
                         || SQLCODE
                         || ' -ERROR- '
                         || SQLERRM
                    );
                    ROLLBACK;
                END;
        END;

        OPEN P_RETORNO FOR
        SELECT 
        CD_ELO_CARTEIRA_TORRE_FRETES,      
        CD_TRANSPORTADORA ,    
        NU_SEMANA ,   
        NU_DIA_SEMANA,       
        NU_QUANTIDADE ,   
        VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES, 
        CD_ELO_CARTEIRA,      
        CD_DIA_EXATO,         
        CD_PERMITIR_ALTERACAO_CS ,
        NU_PROTOCOLO
        FROM VND.ELO_CARTEIRA_TORRE_FRETES 
        WHERE CD_ELO_CARTEIRA_TORRE_FRETES  = V_CD_ELO_CARTEIRA_TORRE_FRETES; 

    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PU_ATUALIZAR_CARTEIRA_FREIGH;


      PROCEDURE PU_ATUALIZAR_CARTEIRA_FREIGH(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_TRANSPORTADORA            IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_TRANSPORTADORA%TYPE,          
        P_NU_SEMANA                    IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_SEMANA%TYPE,      
        P_NU_DIA_SEMANA                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_DIA_SEMANA%TYPE, 
        P_NU_QUANTIDADE                IN      VND.ELO_CARTEIRA_TORRE_FRETES.NU_QUANTIDADE%TYPE,     
        P_VL_FRETE_CONTRATADO          IN      VND.ELO_CARTEIRA_TORRE_FRETES.VL_FRETE_CONTRATADO%TYPE,   
        P_DS_OBSERVACAO_TORRE_FRETES   IN      VND.ELO_CARTEIRA_TORRE_FRETES.DS_OBSERVACAO_TORRE_FRETES%TYPE,    
        P_CD_DIA_EXATO                 IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_DIA_EXATO%TYPE,           
        P_RETORNO                       OUT T_CURSOR
    ) IS

    V_CD_ELO_CARTEIRA_TORRE_FRETES       VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE;

    BEGIN

        V_CD_ELO_CARTEIRA_TORRE_FRETES:=P_CD_ELO_CARTEIRA_TORRE_FRETES;

        BEGIN
        UPDATE VND.ELO_CARTEIRA_TORRE_FRETES    
        SET      

        CD_TRANSPORTADORA = P_CD_TRANSPORTADORA ,    
        NU_SEMANA = P_NU_SEMANA ,   
        NU_DIA_SEMANA = P_NU_DIA_SEMANA,       
        NU_QUANTIDADE = P_NU_QUANTIDADE ,    
        VL_FRETE_CONTRATADO =  P_VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES = P_DS_OBSERVACAO_TORRE_FRETES, 
        CD_DIA_EXATO = P_CD_DIA_EXATO         

        WHERE 
        CD_ELO_CARTEIRA_TORRE_FRETES = P_CD_ELO_CARTEIRA_TORRE_FRETES;
        COMMIT;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN 
            V_CD_ELO_CARTEIRA_TORRE_FRETES:=0;

            WHEN OTHERS THEN
                BEGIN
                    V_CD_ELO_CARTEIRA_TORRE_FRETES:=0;
                    RAISE_APPLICATION_ERROR(
                        -20001,
                        'ERRO ENCONTRADO - '
                         || SQLCODE
                         || ' -ERROR- '
                         || SQLERRM
                    );
                    ROLLBACK;
                END;
        END;

        OPEN P_RETORNO FOR
        SELECT 
        CD_ELO_CARTEIRA_TORRE_FRETES,      
        CD_TRANSPORTADORA ,    
        NU_SEMANA ,   
        NU_DIA_SEMANA,       
        NU_QUANTIDADE ,   
        VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES, 
        CD_ELO_CARTEIRA,      
        CD_DIA_EXATO,         
        CD_PERMITIR_ALTERACAO_CS,
        NU_PROTOCOLO
        FROM VND.ELO_CARTEIRA_TORRE_FRETES 
        WHERE CD_ELO_CARTEIRA_TORRE_FRETES  = V_CD_ELO_CARTEIRA_TORRE_FRETES; 

    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PU_ATUALIZAR_CARTEIRA_FREIGH;




      PROCEDURE PU_ATUALIZAR_CARTEIRA_TOWER(
        P_CD_ELO_CARTEIRA              IN      VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE, 
        P_DS_OBSERVACAO_TORRE_FRETES   IN      VND.ELO_CARTEIRA.DS_OBSERVACAO_TORRE_FRETES%TYPE,    
        P_IC_PERMITIR_CS               IN      VND.ELO_CARTEIRA.IC_PERMITIR_CS%TYPE, 
        P_IC_NAO_LIBERADA_SEM_PROT      IN    VND.ELO_CARTEIRA.IC_NAO_LIBERADA_SEM_PROTOCOLO%TYPE,
        P_IC_ENTREGA_CADENCIADA_CLI     IN    VND.ELO_CARTEIRA.IC_ENTREGA_CADENCIADA_CLIENTE%TYPE,
        P_IC_DIFICULDADE_CONTRATACA     IN     VND.ELO_CARTEIRA.IC_DIFICULDADE_CONTRATACAO%TYPE,
        P_IC_OUTROS                     IN     VND.ELO_CARTEIRA.IC_OUTROS%TYPE,
        P_SG_DESTINO_BACKLOG_CIF         IN      VND.ELO_CARTEIRA.SG_DESTINO_BACKLOG_CIF%TYPE,
        P_CD_INDICADOR_COMPOSICAO_CAR  IN      VND.ELO_AGENDAMENTO_GROUPING.CD_AGRUPAMENTO_PROTOCOLO%TYPE,
        P_CD_ELO_FREIGHT_TOWER_REASON  IN      VND.ELO_CARTEIRA.CD_ELO_FREIGHT_TOWER_REASON%TYPE,


        P_RETORNO                       OUT T_CURSOR
    ) IS
        V_CD_ELO_CARTEIRA                  VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE;
        V_CD_ELO_AGENDAMENTO_WEEK           VND.ELO_AGENDAMENTO_WEEK.CD_ELO_AGENDAMENTO_WEEK%TYPE;
        V_TRAVA_STATUS                      CHAR(1):='N';
        V_ANY_CHANGE                        VARCHAR(1);
        
        
        CURSOR C_PROTOCOLO IS

        WITH CTE_WHO_GRP AS 
        (
        SELECT WCT.CD_ELO_CARTEIRA, WCT.CD_ELO_CARTEIRA_GROUPING 
        FROM VND.ELO_CARTEIRA_GROUPING WCT
        INNER JOIN VND.ELO_CARTEIRA E_CT
        ON 
        E_CT.CD_ELO_CARTEIRA_GROUPING = WCT.CD_ELO_CARTEIRA_GROUPING
        WHERE 
        E_CT.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA
        GROUP BY WCT.CD_ELO_CARTEIRA, 
        WCT.CD_ELO_CARTEIRA_GROUPING
        
        )
        SELECT E_CT.CD_ELO_CARTEIRA, E_CT.CD_ELO_CARTEIRA_GROUPING
        
        FROM  VND.ELO_CARTEIRA E_CT
        --- TO ADD GROUP BY AND FILTER BY  CARTEIRA GROUP´S RANGE  
        INNER JOIN CTE_WHO_GRP WGRP    --HERE FILTER BY CARTEIRA GROUPING
        ON E_CT.CD_ELO_CARTEIRA_GROUPING = WGRP.CD_ELO_CARTEIRA_GROUPING;

    BEGIN

        V_CD_ELO_CARTEIRA:=P_CD_ELO_CARTEIRA;
        
        SAVEPOINT UPDATETF;
        FOR CA IN C_PROTOCOLO
        LOOP

            IF V_TRAVA_STATUS = 'N' THEN 
                BEGIN
                UPDATE VND.ELO_CARTEIRA
                SET 
                IC_PERMITIR_CS = NVL(P_IC_PERMITIR_CS,'N'),
                IC_NAO_LIBERADA_SEM_PROTOCOLO= NVL(P_IC_NAO_LIBERADA_SEM_PROT,'N'),
                IC_ENTREGA_CADENCIADA_CLIENTE = NVL(P_IC_ENTREGA_CADENCIADA_CLI, 'N'),
                IC_DIFICULDADE_CONTRATACAO = NVL(P_IC_DIFICULDADE_CONTRATACA, 'N'),
                IC_OUTROS = NVL(P_IC_OUTROS, 'N')   ,
                SG_DESTINO_BACKLOG_CIF = P_SG_DESTINO_BACKLOG_CIF, 
                DS_OBSERVACAO_TORRE_FRETES = P_DS_OBSERVACAO_TORRE_FRETES,
                CD_ELO_FREIGHT_TOWER_REASON = P_CD_ELO_FREIGHT_TOWER_REASON
                
                WHERE 
                CD_ELO_CARTEIRA = CA.CD_ELO_CARTEIRA;
                --COMMIT;
                
                EXCEPTION
                WHEN OTHERS THEN
                    BEGIN
                    V_TRAVA_STATUS:='S';
                        RAISE_APPLICATION_ERROR(
                            -20001,
                            'ERRO ENCONTRADO - '
                             || SQLCODE
                             || ' -ERROR- '
                             || SQLERRM
                        );
                        ROLLBACK;
                    END;   
                END;
            END IF;

        
            IF  V_TRAVA_STATUS = 'N' THEN 
            BEGIN
            SELECT  
            MAX(EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK) INTO V_CD_ELO_AGENDAMENTO_WEEK
        
            FROM VND.ELO_CARTEIRA EC_I
        
            INNER JOIN VND.ELO_AGENDAMENTO EAG_I
            ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
            INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR EA_SUP_I  --INSERIR LINHAS
            ON 
            EA_SUP_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
            AND EA_SUP_I.IC_ATIVO = 'S'
            INNER JOIN VND.ELO_AGENDAMENTO_ITEM EAG_ITEM_I
            ON 
            EAG_ITEM_I.CD_ELO_AGENDAMENTO_SUPERVISOR = EA_SUP_I.CD_ELO_AGENDAMENTO_SUPERVISOR
            AND EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EC_I.CD_ELO_AGENDAMENTO_ITEM
            AND EAG_ITEM_I.IC_ATIVO = 'S'	
            INNER JOIN VND.ELO_AGENDAMENTO_WEEK EAG_WE_I
            ON EAG_ITEM_I.CD_ELO_AGENDAMENTO_ITEM = EAG_WE_I.CD_ELO_AGENDAMENTO_ITEM
            INNER JOIN VND.ELO_AGENDAMENTO_GROUPING EAG_GRO_I
            ON EAG_GRO_I.CD_ELO_AGENDAMENTO_WEEK = EAG_WE_I.CD_ELO_AGENDAMENTO_WEEK
        
            WHERE 
            EC_I.CD_ELO_CARTEIRA = CA.CD_ELO_CARTEIRA;
            
            EXCEPTION
            WHEN OTHERS THEN
                BEGIN
                    V_TRAVA_STATUS:= 'S';
                    RAISE_APPLICATION_ERROR(
                        -20001,
                        'ERRO ENCONTRADO - '
                         || SQLCODE
                         || ' -ERROR- '
                         || SQLERRM
                    );
                   
                END;
            END;
            END IF;
    
    
            IF  V_TRAVA_STATUS ='N' THEN 
                BEGIN
                --V_ANY_CHANGE:='N';
                BEGIN 
                SELECT 'N' INTO V_ANY_CHANGE FROM VND.ELO_AGENDAMENTO_GROUPING 
                
                WHERE 
                CD_ELO_AGENDAMENTO_WEEK = V_CD_ELO_AGENDAMENTO_WEEK
                AND LENGTH(CD_AGRUPAMENTO_PROTOCOLO) > 7 AND CD_AGRUPAMENTO_PROTOCOLO LIKE '%' || P_CD_INDICADOR_COMPOSICAO_CAR || '%' ;
                EXCEPTION 
                WHEN NO_DATA_FOUND THEN 
                V_ANY_CHANGE:='S';
                WHEN OTHERS THEN 
                V_ANY_CHANGE:='S';
                END;
                
                V_ANY_CHANGE:=NVL(V_ANY_CHANGE, 'S');
                
                IF V_ANY_CHANGE = 'S' THEN 
                BEGIN
                
                UPDATE VND.ELO_AGENDAMENTO_GROUPING
                SET CD_AGRUPAMENTO_PROTOCOLO = P_CD_INDICADOR_COMPOSICAO_CAR
                WHERE 
                CD_ELO_AGENDAMENTO_WEEK = V_CD_ELO_AGENDAMENTO_WEEK;
                --COMMIT;
                
                EXCEPTION
                WHEN OTHERS THEN
                    BEGIN
                        V_TRAVA_STATUS:= 'S';
                        RAISE_APPLICATION_ERROR(
                            -20001,
                            'ERRO ENCONTRADO - '
                             || SQLCODE
                             || ' -ERROR- '
                             || SQLERRM
                        );
                        ROLLBACK;
                    END;
                END;
                END IF;
                
                END;
            END IF;
        
        
        END LOOP;
        
        IF V_TRAVA_STATUS = 'N' THEN 
            COMMIT;
        ELSE 
            ROLLBACK TO UPDATETF;
        END IF;
        
        IF C_PROTOCOLO%ISOPEN THEN
        CLOSE C_PROTOCOLO;
        END IF;


        OPEN P_RETORNO FOR

        SELECT CASE WHEN V_TRAVA_STATUS = 'S' THEN 1 ELSE 0 END  AS P_SUCESSO
        FROM DUAL;


    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PU_ATUALIZAR_CARTEIRA_TOWER;

      PROCEDURE PU_ATUALIZAR_PERMITIR_CS(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_ELO_CARTEIRA              IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA%TYPE, 
        P_IC_PERMITIR_CS               IN      BOOLEAN, 

        P_RETORNO                       OUT T_CURSOR
    ) IS
        V_IC_PERMITIR_CS  CHAR(1);
    BEGIN

    IF  P_IC_PERMITIR_CS  THEN 
        V_IC_PERMITIR_CS:='S';
    ELSE 
        V_IC_PERMITIR_CS:='N';
    END IF;

    PU_ATUALIZAR_PERMITIR_CS(P_CD_ELO_CARTEIRA_TORRE_FRETES,P_CD_ELO_CARTEIRA, V_IC_PERMITIR_CS, P_RETORNO);


    END PU_ATUALIZAR_PERMITIR_CS;



      PROCEDURE PU_ATUALIZAR_PERMITIR_CS(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_CD_ELO_CARTEIRA              IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA%TYPE, 
        P_IC_PERMITIR_CS               IN      VND.ELO_CARTEIRA.IC_PERMITIR_CS%TYPE, 

        P_RETORNO                       OUT T_CURSOR
    ) IS
        V_CD_ELO_CARTEIRA                  VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA%TYPE;
        V_SG_STATUS                         VND.ELO_STATUS.SG_STATUS%TYPE;
        V_TRAVA_STATUS                      CHAR(1):='N';
    BEGIN

        IF NVL(P_CD_ELO_CARTEIRA, 0) = 0 THEN 
            SELECT CD_ELO_CARTEIRA INTO V_CD_ELO_CARTEIRA FROM VND.ELO_CARTEIRA_TORRE_FRETES
            WHERE 
            CD_ELO_CARTEIRA_TORRE_FRETES = P_CD_ELO_CARTEIRA_TORRE_FRETES;
        ELSE 
            V_CD_ELO_CARTEIRA:= P_CD_ELO_CARTEIRA;
        END IF;


        V_TRAVA_STATUS:= FX_ALLOW_CHANGE_PERMITIR_CS(P_CD_ELO_CARTEIRA_TORRE_FRETES, V_CD_ELO_CARTEIRA);

        IF  V_TRAVA_STATUS = 'S' THEN 

            BEGIN
            UPDATE VND.ELO_CARTEIRA
            SET 
            IC_PERMITIR_CS = NVL(P_IC_PERMITIR_CS,'N')


            WHERE 
            CD_ELO_CARTEIRA = V_CD_ELO_CARTEIRA;
              COMMIT;
             EXCEPTION
            WHEN OTHERS THEN
                BEGIN
                    RAISE_APPLICATION_ERROR(
                        -20001,
                        'ERRO ENCONTRADO - '
                         || SQLCODE
                         || ' -ERROR- '
                         || SQLERRM
                    );
                    ROLLBACK;
                END;   
            END;

        END IF;


        OPEN P_RETORNO FOR
        SELECT 
        CD_ELO_CARTEIRA_TORRE_FRETES,      
        CD_TRANSPORTADORA ,    
        NU_SEMANA ,   
        NU_DIA_SEMANA,       
        NU_QUANTIDADE ,   
        VL_FRETE_CONTRATADO,    
        DS_OBSERVACAO_TORRE_FRETES, 
        CD_ELO_CARTEIRA,      
        CD_DIA_EXATO,         
        CD_PERMITIR_ALTERACAO_CS ,
        NU_PROTOCOLO
        FROM VND.ELO_CARTEIRA_TORRE_FRETES 
        WHERE CD_ELO_CARTEIRA_TORRE_FRETES  = P_CD_ELO_CARTEIRA_TORRE_FRETES; 

    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PU_ATUALIZAR_PERMITIR_CS;

      PROCEDURE PU_ATUALIZAR_BACKLOG_CIF(
        P_DT_WEEK_START                IN	VARCHAR2,
		P_DH_BACKLOG_CIF			   IN	VARCHAR2
        )
        IS 
        BEGIN
        NULL;
    
     END PU_ATUALIZAR_BACKLOG_CIF;   



      PROCEDURE PU_ATUALIZAR_BACKLOG_CIF(
        P_CD_ELO_CARTEIRA               IN	VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE,      
        P_RETORNO                       OUT T_CURSOR
        

    ) IS

        V_TRAVA_STATUS                      CHAR(1):='N';
        V_NU_QUANTIDADE                     VND.ELO_CARTEIRA_TORRE_FRETES.NU_QUANTIDADE%TYPE;
        V_QT_BACKLOG_CIF                    VND.ELO_CARTEIRA.QT_BACKLOG_CIF%TYPE;


        CURSOR C_PROTOCOLO IS
        SELECT DISTINCT 
        EC_I.CD_ELO_CARTEIRA, 
        EC_I.CD_ELO_AGENDAMENTO,
        EC_I.SG_DESTINO_BACKLOG_CIF,

        (NVL(EC_I.QT_AGENDADA_CONFIRMADA,0) - (SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_MARCACAO E_MAR 
				WHERE 
				E_MAR.IC_ATIVO = 'S'
				--AND E_MAR.DH_SAIDA IS NOT NULL 
                --AND E_MAR.CD_MOTIVO_STATUS  IS NULL 
                AND EC_I.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
				GROUP BY E_MAR.CD_ELO_CARTEIRA)) 
--        ((SELECT SUM(TF.NU_QUANTIDADE) NU_QUANTIDADE
--				FROM VND.ELO_CARTEIRA_TORRE_FRETES TF 
--				WHERE 
--                EC_I.CD_ELO_CARTEIRA = TF.CD_ELO_CARTEIRA
--				GROUP BY EC_I.CD_ELO_CARTEIRA)) 
            QT_SALDO_MARCADO_TF

        FROM VND.ELO_CARTEIRA EC_I
        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO

        WHERE 
        EC_I.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND EC_I.IC_COOPERATIVE IN ('S', 'N')
        AND EC_I.SG_DESTINO_BACKLOG_CIF IN ('CSERV', 'CSHIP')
        AND EC_I.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA;
       -- AND TO_CHAR(EAG_I.DT_WEEK_START,'YYYYWW') = TO_CHAR(to_date(P_DT_WEEK_START,'YYYY-MM-DD'),'YYYYWW');        

        BEGIN

    FOR CA IN C_PROTOCOLO
    LOOP

        IF  V_TRAVA_STATUS = 'N' THEN 

            BEGIN
            UPDATE VND.ELO_CARTEIRA
            SET 
			   DH_BACKLOG_CIF  = CURRENT_DATE, --TO_DATE(P_DH_BACKLOG_CIF, 'YYYY-MM-DD HH:MI:SS'),
			   QT_BACKLOG_CIF = NVL(CA.QT_SALDO_MARCADO_TF,0)

            WHERE 
            CD_ELO_CARTEIRA = CA.CD_ELO_CARTEIRA;
              COMMIT;
             EXCEPTION
            WHEN OTHERS THEN
                BEGIN
                    RAISE_APPLICATION_ERROR(
                        -20001,
                        'ERRO ENCONTRADO - '
                         || SQLCODE
                         || ' -ERROR- '
                         || SQLERRM
                    );
                    V_TRAVA_STATUS:='S';
                    ROLLBACK;
                END;   
            END;
            
        OPEN P_RETORNO FOR
        SELECT CASE WHEN V_TRAVA_STATUS = 'N' THEN 1 ELSE 0 END  AS P_SUCESSO
        FROM DUAL;
        
        ELSE 
            OPEN P_RETORNO FOR
            SELECT 0 AS P_SUCESSO
            FROM DUAL;

        END IF;


    END LOOP;
    IF C_PROTOCOLO%ISOPEN THEN
      CLOSE C_PROTOCOLO;
    END IF;



    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PU_ATUALIZAR_BACKLOG_CIF;


      PROCEDURE PU_FINALIZAR_SEMANA(
        P_DT_WEEK_START                IN	VARCHAR2,
		P_CD_POLO          			   IN	VARCHAR2,
		P_CD_CENTRO_EXPEDIDOR   	   IN	VARCHAR2,
        P_RETORNO                       OUT T_CURSOR

    ) IS

        V_TRAVA_STATUS                      CHAR(1):='N';
        V_NU_QUANTIDADE                     VND.ELO_CARTEIRA_TORRE_FRETES.NU_QUANTIDADE%TYPE;
        V_STATUS_CADFIN                     VND.ELO_STATUS.CD_ELO_STATUS%TYPE;



        CURSOR C_PROTOCOLO IS

        WITH CTE_CARTEIRA AS 
        (
        SELECT  
        EC_I.CD_ELO_CARTEIRA, 
        EC_I.CD_ELO_AGENDAMENTO,
        EC_I.SG_DESTINO_BACKLOG_CIF,


                NVL((SELECT SUM(TF.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_CARTEIRA_TORRE_FRETES TF 
				WHERE 
                EC_I.CD_ELO_CARTEIRA = TF.CD_ELO_CARTEIRA
				GROUP BY EC_I.CD_ELO_CARTEIRA),0)-
        NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_MARCACAO E_MAR 
				WHERE 
				E_MAR.IC_ATIVO = 'S'
				--AND E_MAR.DH_SAIDA IS NOT NULL 
                AND E_MAR.CD_MOTIVO_STATUS  IS NULL 
                AND EC_I.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
				GROUP BY E_MAR.CD_ELO_CARTEIRA),0) 
             QT_SALDO_MARCADO_TF,


        NVL(EC_I.IC_NAO_LIBERADA_SEM_PROTOCOLO,'N') IC_NAO_LIBERADA_SEM_PROTOCOLO,
        NVL(EC_I.IC_ENTREGA_CADENCIADA_CLIENTE,'N') IC_ENTREGA_CADENCIADA_CLIENTE,
        NVL(EC_I.IC_DIFICULDADE_CONTRATACAO,'N') IC_DIFICULDADE_CONTRATACAO,
        NVL(EC_I.IC_OUTROS, 'N') IC_OUTROS,
        EC_I.CD_STATUS_TORRE_FRETES, 
        I_ST_NEW_PRO.SG_STATUS SG_STATUS_TORRE_FRETES,
        EAG_I.DT_WEEK_START,
        EAG_I.CD_POLO,
        EAG_I.CD_CENTRO_EXPEDIDOR

        FROM VND.ELO_CARTEIRA EC_I
        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO

        INNER JOIN VND.ELO_STATUS I_ST_NEW_PRO
        ON
        EC_I.CD_STATUS_TORRE_FRETES =  I_ST_NEW_PRO.CD_ELO_STATUS
        INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
        ON 
        I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS

        WHERE 
        EC_I.IC_ATIVO = 'S'
        AND EAG_I.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND EC_I.IC_COOPERATIVE IN ('S', 'N')
        AND I_ST_NEW_PRO.SG_STATUS  IN('CANEW', 'CAPRO')  --TORRE FRETE
        AND I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'   
        --AND EC_I.SG_DESTINO_BACKLOG_CIF IN ('CSERV', 'CSHIP')
        AND TO_CHAR(EAG_I.DT_WEEK_START,'YYYYWW') = TO_CHAR(to_date(P_DT_WEEK_START,'YYYY-MM-DD'),'YYYYWW')
        AND 

        (
            (        
                (NVL(P_CD_POLO, '9999') = '9999' OR (EAG_I.CD_POLO IN  ( select regexp_substr(P_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null)))
                AND (NVL(P_CD_CENTRO_EXPEDIDOR, '9999') = '9999' OR (EAG_I.CD_CENTRO_EXPEDIDOR IN( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null)))
            )
            OR
            EXISTS 
                (SELECT 1
                FROM VND.ELO_AGENDAMENTO CAG
                INNER JOIN VND.ELO_AGENDAMENTO_POLO_CENTRO E_AGPC
                ON CAG.CD_ELO_AGENDAMENTO = E_AGPC.CD_ELO_AGENDAMENTO 
                INNER JOIN VND.ELO_AGENDAMENTO_CENTRO_MACHINE E_AGCMAC
                ON E_AGPC.CD_ELO_AGENDAMENTO = E_AGCMAC.CD_ELO_AGENDAMENTO 
                WHERE
                CAG.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
                AND NVL(CAG.CD_POLO, E_AGPC.CD_POLO) = E_AGPC.CD_POLO 
                AND NVL(CAG.CD_CENTRO_EXPEDIDOR, E_AGCMAC.CD_CENTRO_EXPEDIDOR) = E_AGCMAC.CD_CENTRO_EXPEDIDOR
                AND NVL(CAG.CD_MACHINE, E_AGCMAC.CD_MACHINE) = E_AGCMAC.CD_MACHINE
                AND CAG.IC_ATIVO = 'S'
                AND
                ( 
                (P_CD_POLO = '9999' OR (E_AGPC.CD_POLO IN (  select regexp_substr(P_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null))))

                AND ( 
                (P_CD_CENTRO_EXPEDIDOR = '9999' OR (E_AGCMAC.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
                )
        )


        ) 

        SELECT 
        CT_CART.CD_ELO_CARTEIRA,
        CT_CART.CD_ELO_AGENDAMENTO,
        CT_CART.SG_DESTINO_BACKLOG_CIF,
        CT_CART.QT_SALDO_MARCADO_TF,

        CT_CART.IC_NAO_LIBERADA_SEM_PROTOCOLO,
        CT_CART.IC_ENTREGA_CADENCIADA_CLIENTE,
        CT_CART.IC_DIFICULDADE_CONTRATACAO,
        CT_CART.IC_OUTROS, 
        CT_CART.CD_STATUS_TORRE_FRETES, 
        CT_CART.SG_STATUS_TORRE_FRETES


        FROM CTE_CARTEIRA CT_CART

        WHERE 
        NOT EXISTS (SELECT 1 
                FROM CTE_CARTEIRA NOEXCAR
                WHERE 
                (
                (NOEXCAR.IC_NAO_LIBERADA_SEM_PROTOCOLO = 'N'
                AND NOEXCAR.IC_ENTREGA_CADENCIADA_CLIENTE = 'N'
                AND NOEXCAR.IC_DIFICULDADE_CONTRATACAO = 'N'
                AND NOEXCAR.IC_OUTROS = 'N' )
                AND NOEXCAR.QT_SALDO_MARCADO_TF <> 0
                AND NVL(NOEXCAR.SG_DESTINO_BACKLOG_CIF, '') = '')
                OR (NOEXCAR.QT_SALDO_MARCADO_TF <> 0
                    AND NOT(NVL(NOEXCAR.SG_DESTINO_BACKLOG_CIF, 'WRONG') IN ('CSERV', 'CSHIP')))
                ) ;


        BEGIN

    BEGIN 
    SELECT 
    I_ST_NEW_PRO.CD_ELO_STATUS INTO V_STATUS_CADFIN
    FROM VND.ELO_STATUS I_ST_NEW_PRO
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
    ON 
    I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
    WHERE 
    I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'
    AND I_ST_NEW_PRO.SG_STATUS  ='CAFIN';

    EXCEPTION

        WHEN OTHERS THEN
        BEGIN
        V_STATUS_CADFIN:= 0;
        RAISE_APPLICATION_ERROR(
        -20001,
        'ERRO ENCONTRADO - '
        || SQLCODE
        || ' -ERROR- '
        || SQLERRM
        );
        ROLLBACK;
        END;   
    END;



    FOR CA IN C_PROTOCOLO
    LOOP

    BEGIN

        V_TRAVA_STATUS:= 'N';

        IF ( CA.IC_NAO_LIBERADA_SEM_PROTOCOLO = 'S' OR 
            CA.IC_ENTREGA_CADENCIADA_CLIENTE = 'S' OR 
            CA.IC_DIFICULDADE_CONTRATACAO = 'S' OR 
            CA.IC_OUTROS = 'S') THEN

            V_TRAVA_STATUS:= 'S';
       ELSE

            IF CA.SG_DESTINO_BACKLOG_CIF = 'CSERV' OR CA.SG_DESTINO_BACKLOG_CIF = 'CSHIP' THEN
                V_TRAVA_STATUS:= 'S';
                ELSE
                IF CA.QT_SALDO_MARCADO_TF = 0 THEN 
                    V_TRAVA_STATUS:= 'S';
                END IF;

            END IF;

       END IF;



        IF  V_TRAVA_STATUS = 'S' THEN 
        BEGIN
            UPDATE VND.ELO_CARTEIRA
            SET 
            CD_STATUS_TORRE_FRETES  = V_STATUS_CADFIN --'CAFIN'


            WHERE 
            CD_ELO_CARTEIRA = CA.CD_ELO_CARTEIRA;
              COMMIT;
             EXCEPTION
            WHEN OTHERS THEN
                BEGIN
                    RAISE_APPLICATION_ERROR(
                        -20001,
                        'ERRO ENCONTRADO - '
                         || SQLCODE
                         || ' -ERROR- '
                         || SQLERRM
                    );
                    ROLLBACK;
                END;   
            END;

        END IF;

    END;


    END LOOP;
    IF C_PROTOCOLO%ISOPEN THEN
      CLOSE C_PROTOCOLO;
    END IF;

    OPEN P_RETORNO FOR
    SELECT CASE WHEN V_TRAVA_STATUS = 'S' THEN 1 ELSE 0 END  AS P_SUCESSO
    FROM DUAL;

    EXCEPTION
        WHEN OTHERS THEN
            BEGIN

                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PU_FINALIZAR_SEMANA;



      PROCEDURE PX_ALLOW_CLOSE_WEEK(
        P_DT_WEEK_START                IN	VARCHAR2,
		P_CD_POLO          			   IN	VARCHAR2,
		P_CD_CENTRO_EXPEDIDOR   	   IN	VARCHAR2,
        P_RETURN                        OUT T_CURSOR

    ) IS


       BEGIN

        OPEN P_RETURN FOR

        WITH CTE_CARTEIRA AS 
        (
        SELECT  
        EC_I.CD_ELO_CARTEIRA, 
        EC_I.CD_ELO_AGENDAMENTO,
        EC_I.SG_DESTINO_BACKLOG_CIF,


                NVL((SELECT SUM(TF.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_CARTEIRA_TORRE_FRETES TF 
				WHERE 
                EC_I.CD_ELO_CARTEIRA = TF.CD_ELO_CARTEIRA
				GROUP BY EC_I.CD_ELO_CARTEIRA),0)-
        NVL((SELECT SUM(E_MAR.NU_QUANTIDADE) NU_QUANTIDADE
				FROM VND.ELO_MARCACAO E_MAR 
				WHERE 
				E_MAR.IC_ATIVO = 'S'
				--AND E_MAR.DH_SAIDA IS NOT NULL 
                AND E_MAR.CD_MOTIVO_STATUS  IS NULL 
                AND EC_I.CD_ELO_CARTEIRA = E_MAR.CD_ELO_CARTEIRA
				GROUP BY E_MAR.CD_ELO_CARTEIRA),0) 
             QT_SALDO_MARCADO_TF,


        NVL(EC_I.IC_NAO_LIBERADA_SEM_PROTOCOLO, 'N') IC_NAO_LIBERADA_SEM_PROTOCOLO,
        NVL(EC_I.IC_ENTREGA_CADENCIADA_CLIENTE, 'N') IC_ENTREGA_CADENCIADA_CLIENTE,
        NVL(EC_I.IC_DIFICULDADE_CONTRATACAO, 'N') IC_DIFICULDADE_CONTRATACAO,
        NVL(EC_I.IC_OUTROS,  'N') IC_OUTROS,
        EC_I.CD_STATUS_TORRE_FRETES, 
        I_ST_NEW_PRO.SG_STATUS SG_STATUS_TORRE_FRETES,
        EAG_I.DT_WEEK_START,
        EAG_I.CD_POLO,
        EAG_I.CD_CENTRO_EXPEDIDOR

        FROM VND.ELO_CARTEIRA EC_I
        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO

        INNER JOIN VND.ELO_STATUS I_ST_NEW_PRO
        ON
        EC_I.CD_STATUS_TORRE_FRETES =  I_ST_NEW_PRO.CD_ELO_STATUS
        INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
        ON 
        I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS

        WHERE 
        EC_I.IC_ATIVO = 'S'
        AND EAG_I.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND EC_I.IC_COOPERATIVE IN ('S', 'N')
        AND I_ST_NEW_PRO.SG_STATUS  IN('CANEW', 'CAPRO')  --TORRE FRETE
        AND I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'   
        --AND EC_I.SG_DESTINO_BACKLOG_CIF IN ('CSERV', 'CSHIP')
        AND TO_CHAR(EAG_I.DT_WEEK_START,'YYYYWW') = TO_CHAR(to_date(P_DT_WEEK_START,'YYYY-MM-DD'),'YYYYWW')
        AND 
        (
           ( (NVL(P_CD_POLO, '9999') = '9999' OR (EAG_I.CD_POLO IN  ( select regexp_substr(P_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null)))
            AND (NVL(P_CD_CENTRO_EXPEDIDOR, '9999') = '9999' OR (EAG_I.CD_CENTRO_EXPEDIDOR IN( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))

            OR 
            EXISTS 
                (SELECT 1
                FROM VND.ELO_AGENDAMENTO CAG
                INNER JOIN VND.ELO_AGENDAMENTO_POLO_CENTRO E_AGPC
                ON CAG.CD_ELO_AGENDAMENTO = E_AGPC.CD_ELO_AGENDAMENTO 
                INNER JOIN VND.ELO_AGENDAMENTO_CENTRO_MACHINE E_AGCMAC
                ON E_AGPC.CD_ELO_AGENDAMENTO = E_AGCMAC.CD_ELO_AGENDAMENTO 
                WHERE
                CAG.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
                AND NVL(CAG.CD_POLO, E_AGPC.CD_POLO) = E_AGPC.CD_POLO 
                AND NVL(CAG.CD_CENTRO_EXPEDIDOR, E_AGCMAC.CD_CENTRO_EXPEDIDOR) = E_AGCMAC.CD_CENTRO_EXPEDIDOR
                AND NVL(CAG.CD_MACHINE, E_AGCMAC.CD_MACHINE) = E_AGCMAC.CD_MACHINE
                AND CAG.IC_ATIVO = 'S'
                AND
                ( 
                (P_CD_POLO = '9999' OR (E_AGPC.CD_POLO IN (  select regexp_substr(P_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null))))

                AND ( 
                (P_CD_CENTRO_EXPEDIDOR = '9999' OR (E_AGCMAC.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
                )


        )

        ) 

        SELECT 
        CT_CART.CD_ELO_CARTEIRA,
        CT_CART.CD_ELO_AGENDAMENTO,
        CT_CART.SG_DESTINO_BACKLOG_CIF,
        CT_CART.QT_SALDO_MARCADO_TF,

        CT_CART.IC_NAO_LIBERADA_SEM_PROTOCOLO,
        CT_CART.IC_ENTREGA_CADENCIADA_CLIENTE,
        CT_CART.IC_DIFICULDADE_CONTRATACAO,
        CT_CART.IC_OUTROS, 
        CT_CART.CD_STATUS_TORRE_FRETES, 
        CT_CART.SG_STATUS_TORRE_FRETES,

		CASE 
		WHEN 
		(SELECT DISTINCT 1 
                FROM CTE_CARTEIRA NOEXCAR
                WHERE 
				NOEXCAR.CD_ELO_CARTEIRA = CT_CART.CD_ELO_CARTEIRA
				AND
                (
                (NOEXCAR.IC_NAO_LIBERADA_SEM_PROTOCOLO = 'N'
                AND NOEXCAR.IC_ENTREGA_CADENCIADA_CLIENTE = 'N'
                AND NOEXCAR.IC_DIFICULDADE_CONTRATACAO = 'N'
                AND NOEXCAR.IC_OUTROS = 'N' )
                AND NOEXCAR.QT_SALDO_MARCADO_TF <> 0
                AND NVL(NOEXCAR.SG_DESTINO_BACKLOG_CIF, '') = ''
                )
                OR (NOEXCAR.QT_SALDO_MARCADO_TF <> 0
                    AND NOT(NVL(NOEXCAR.SG_DESTINO_BACKLOG_CIF, 'WRONG') IN ('CSERV', 'CSHIP')))
                ) = 1 THEN 'N' 
		ELSE 'S' END CARTEIRA_REGRA_CAFIN, 

		CASE 
		WHEN 
		(SELECT DISTINCT 1 
                FROM CTE_CARTEIRA NOEXCAR
                WHERE 
				--NOEXCAR.CD_ELO_CARTEIRA = CT_CAR.CD_ELO_CARTEIRA
				--AND
                (
                (NOEXCAR.IC_NAO_LIBERADA_SEM_PROTOCOLO = 'N'
                AND NOEXCAR.IC_ENTREGA_CADENCIADA_CLIENTE = 'N'
                AND NOEXCAR.IC_DIFICULDADE_CONTRATACAO = 'N'
                AND NOEXCAR.IC_OUTROS = 'N' )
                AND NOEXCAR.QT_SALDO_MARCADO_TF <> 0
                AND NVL(NOEXCAR.SG_DESTINO_BACKLOG_CIF, '') = '')
                OR (NOEXCAR.QT_SALDO_MARCADO_TF <> 0
                    AND NOT(NVL(NOEXCAR.SG_DESTINO_BACKLOG_CIF, 'WRONG') IN ('CSERV', 'CSHIP')))
                ) = 1 THEN 'N' 
		ELSE 'S' END SEMANA_REGRA_CAFIN		

        FROM CTE_CARTEIRA CT_CART;

    END PX_ALLOW_CLOSE_WEEK;


      PROCEDURE PX_STATUS_DOCUMENT_IS(
        P_DT_WEEK_FROM          IN VARCHAR2,
        P_DT_WEEK_TO            IN VARCHAR2,
		P_CD_POLO          			   IN	VARCHAR2,
		P_CD_CENTRO_EXPEDIDOR   	   IN	VARCHAR2,
        P_RETURN                        OUT T_CURSOR

    ) IS


       BEGIN

        OPEN P_RETURN FOR

        SELECT  
        EC_I.CD_ELO_CARTEIRA, 
        EC_I.CD_ELO_AGENDAMENTO,
        EC_I.CD_STATUS_TORRE_FRETES, 
        I_ST_NEW_PRO.SG_STATUS SG_STATUS_TORRE_FRETES,
        E_ST_CS.SG_STATUS SG_STATUS_CUSTOMER_SERVICE,
        EAG_I.DT_WEEK_START,
        EAG_I.CD_POLO,
        EAG_I.CD_CENTRO_EXPEDIDOR,
		I_ST_AGENC.SG_STATUS SG_STATUS_GERAL_AGENDAMENTO,
		CASE
		WHEN I_ST_AGENC.SG_STATUS = 'AGENC' THEN 'CLOSED'
		WHEN I_ST_AGENC.SG_STATUS IS NULL THEN 'READONLY'
		ELSE 'WRITABLE' END STATUS_WEEK_IS


        FROM VND.ELO_CARTEIRA EC_I
        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO

        LEFT JOIN VND.ELO_STATUS I_ST_NEW_PRO
        ON
        EC_I.CD_STATUS_TORRE_FRETES =  I_ST_NEW_PRO.CD_ELO_STATUS
		AND I_ST_NEW_PRO.SG_STATUS  IN('CANEW', 'CAPRO', 'CAFIN')  --TORRE FRETE
        LEFT JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
        ON 
        I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
		AND I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'

        INNER JOIN VND.ELO_STATUS E_ST_CS
        ON
        EC_I.CD_STATUS_CUSTOMER_SERVICE =  E_ST_CS.CD_ELO_STATUS

        INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_CS
        ON 
        E_ST_CS.CD_ELO_TIPO_STATUS = I_ST_TIPO_CS.CD_ELO_TIPO_STATUS
		AND I_ST_TIPO_CS.SG_TIPO_STATUS  = 'CARTE'

		INNER JOIN VND.ELO_STATUS I_ST_AGENC
        ON
        EAG_I.CD_ELO_STATUS =  I_ST_AGENC.CD_ELO_STATUS
		--AND I_ST_AGENC.SG_STATUS  IN('AGENC')  --STATUS GERAL AGENDAMENTO
        INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_AG
        ON 
        I_ST_AGENC.CD_ELO_TIPO_STATUS = I_ST_TIPO_AG.CD_ELO_TIPO_STATUS
		AND I_ST_TIPO_AG.SG_TIPO_STATUS  = 'AGEND'

        WHERE 
        EC_I.IC_ATIVO = 'S'
        AND EAG_I.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND EC_I.IC_COOPERATIVE IN ('S', 'N')
        --AND I_ST_NEW_PRO.SG_STATUS  IN('CANEW', 'CAPRO')  --TORRE FRETE
        --AND I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'   
        --AND EC_I.SG_DESTINO_BACKLOG_CIF IN ('CSERV', 'CSHIP')

        AND 
        (TO_CHAR(EAG_I.DT_WEEK_START,'YYYYWW')  BETWEEN TO_CHAR(to_date(P_DT_WEEK_FROM,'YYYY-MM-DD'),'YYYYWW')
        AND TO_CHAR(to_date(P_DT_WEEK_TO,'YYYY-MM-DD'),'YYYYWW'))  

        AND 
        (
           ( (NVL(P_CD_POLO, '9999') = '9999' OR (EAG_I.CD_POLO IN  ( select regexp_substr(P_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null)))
            AND (NVL(P_CD_CENTRO_EXPEDIDOR, '9999') = '9999' OR (EAG_I.CD_CENTRO_EXPEDIDOR IN( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))

            OR 
            EXISTS 
                (SELECT 1
                FROM VND.ELO_AGENDAMENTO CAG
                INNER JOIN VND.ELO_AGENDAMENTO_POLO_CENTRO E_AGPC
                ON CAG.CD_ELO_AGENDAMENTO = E_AGPC.CD_ELO_AGENDAMENTO 
                INNER JOIN VND.ELO_AGENDAMENTO_CENTRO_MACHINE E_AGCMAC
                ON E_AGPC.CD_ELO_AGENDAMENTO = E_AGCMAC.CD_ELO_AGENDAMENTO 
                WHERE
                CAG.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
                AND NVL(CAG.CD_POLO, E_AGPC.CD_POLO) = E_AGPC.CD_POLO 
                AND NVL(CAG.CD_CENTRO_EXPEDIDOR, E_AGCMAC.CD_CENTRO_EXPEDIDOR) = E_AGCMAC.CD_CENTRO_EXPEDIDOR
                AND NVL(CAG.CD_MACHINE, E_AGCMAC.CD_MACHINE) = E_AGCMAC.CD_MACHINE
                AND CAG.IC_ATIVO = 'S'
                AND
                ( 
                (P_CD_POLO = '9999' OR (E_AGPC.CD_POLO IN (  select regexp_substr(P_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null))))

                AND ( 
                (P_CD_CENTRO_EXPEDIDOR = '9999' OR (E_AGCMAC.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
                )


        );




    END PX_STATUS_DOCUMENT_IS;


      PROCEDURE PX_ALLOW_CHANGES(
        P_DT_WEEK_START                IN	VARCHAR2,
		P_CD_POLO          			   IN	VARCHAR2,
		P_CD_CENTRO_EXPEDIDOR   	   IN	VARCHAR2,
		P_CD_ELO_CARTEIRA			   IN   VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE,
        P_RETURN                        OUT T_CURSOR

    ) IS

       V_STATUS_CADFIN                     VND.ELO_STATUS.CD_ELO_STATUS%TYPE; 

       BEGIN


        OPEN P_RETURN FOR

        SELECT  
        EC_I.CD_ELO_CARTEIRA,
		CASE 
		WHEN I_ST_NEW_PRO.SG_STATUS IN ('CAPRO', 'CANEW') AND 1 = (
                            SELECT 1 
                            FROM VND.ELO_STATUS I_ST_NEW_PRO
                            INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
                            ON 
                            I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
                            WHERE 
                            I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'
                            AND I_ST_NEW_PRO.SG_STATUS  ='CAFIN'
                            AND EC_I.CD_STATUS_CUSTOMER_SERVICE = I_ST_NEW_PRO.CD_ELO_STATUS
                            AND ROWNUM = 1 )   

        THEN 'S'  -- 'CAFIN'


		ELSE 'N' END PERMITIR_CHANGE

        FROM VND.ELO_CARTEIRA EC_I
        INNER JOIN VND.ELO_AGENDAMENTO EAG_I
        ON EC_I.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO

        LEFT JOIN VND.ELO_STATUS I_ST_NEW_PRO
        ON
        EC_I.CD_STATUS_TORRE_FRETES =  I_ST_NEW_PRO.CD_ELO_STATUS
		AND I_ST_NEW_PRO.SG_STATUS IN('CANEW', 'CAPRO')  --TORRE FRETE
        LEFT JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
        ON 
        I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
		AND I_ST_TIPO_NP.SG_TIPO_STATUS  = 'CARTE'  

        WHERE 
        EC_I.IC_ATIVO = 'S'
        AND EAG_I.IC_ATIVO = 'S'
        AND EC_I.CD_INCOTERMS = 'CIF'
        AND EC_I.IC_COOPERATIVE IN ('S', 'N')
		AND (NVL(P_CD_ELO_CARTEIRA, 0) = 0 OR P_CD_ELO_CARTEIRA = EC_I.CD_ELO_CARTEIRA) 


        AND TO_CHAR(EAG_I.DT_WEEK_START,'YYYYWW') = TO_CHAR(to_date(P_DT_WEEK_START,'YYYY-MM-DD'),'YYYYWW')
        AND 

        (
            (
            (NVL(P_CD_POLO, '9999') = '9999' 
            OR (EAG_I.CD_POLO IN  ( select regexp_substr(P_CD_POLO,'[^,]+', 1, level) 
                                    from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null)))
            AND (NVL(P_CD_CENTRO_EXPEDIDOR, '9999') = '9999' 
            OR 
            (EAG_I.CD_CENTRO_EXPEDIDOR IN( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) 
                                    from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null)))
            )
            OR 
            EXISTS 
                (SELECT 1
                FROM VND.ELO_AGENDAMENTO CAG
                INNER JOIN VND.ELO_AGENDAMENTO_POLO_CENTRO E_AGPC
                ON CAG.CD_ELO_AGENDAMENTO = E_AGPC.CD_ELO_AGENDAMENTO 
                INNER JOIN VND.ELO_AGENDAMENTO_CENTRO_MACHINE E_AGCMAC
                ON E_AGPC.CD_ELO_AGENDAMENTO = E_AGCMAC.CD_ELO_AGENDAMENTO 
                WHERE
                CAG.CD_ELO_AGENDAMENTO = EAG_I.CD_ELO_AGENDAMENTO
                AND NVL(CAG.CD_POLO, E_AGPC.CD_POLO) = E_AGPC.CD_POLO 
                AND NVL(CAG.CD_CENTRO_EXPEDIDOR, E_AGCMAC.CD_CENTRO_EXPEDIDOR) = E_AGCMAC.CD_CENTRO_EXPEDIDOR
                AND NVL(CAG.CD_MACHINE, E_AGCMAC.CD_MACHINE) = E_AGCMAC.CD_MACHINE
                AND CAG.IC_ATIVO = 'S'
                AND
                ( 
                (P_CD_POLO = '9999' OR (E_AGPC.CD_POLO IN (  select regexp_substr(P_CD_POLO,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_POLO, '[^,]+', 1, level) is not null))))

                AND ( 
                (P_CD_CENTRO_EXPEDIDOR = '9999' OR (E_AGCMAC.CD_CENTRO_EXPEDIDOR IN  ( select regexp_substr(P_CD_CENTRO_EXPEDIDOR,'[^,]+', 1, level) from dual connect by regexp_substr(P_CD_CENTRO_EXPEDIDOR, '[^,]+', 1, level) is not null))))
                )
        );


    END PX_ALLOW_CHANGES;
    
    
      PROCEDURE PE_DELETAR_CARTEIRA_FREIGH(
        P_CD_ELO_CARTEIRA_TORRE_FRETES IN      VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE,
        P_RETORNO                       OUT T_CURSOR
    ) IS

    V_CD_ELO_CARTEIRA_TORRE_FRETES       VND.ELO_CARTEIRA_TORRE_FRETES.CD_ELO_CARTEIRA_TORRE_FRETES%TYPE;
    V_TRAVA_STATUS VARCHAR2(1):='S';

    BEGIN

        V_CD_ELO_CARTEIRA_TORRE_FRETES:=P_CD_ELO_CARTEIRA_TORRE_FRETES;

        BEGIN
        DELETE FROM  VND.ELO_CARTEIRA_TORRE_FRETES    
        WHERE 
        CD_ELO_CARTEIRA_TORRE_FRETES = P_CD_ELO_CARTEIRA_TORRE_FRETES;
        COMMIT;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN 
            V_CD_ELO_CARTEIRA_TORRE_FRETES:=0;
            V_TRAVA_STATUS:= 'N';
            WHEN OTHERS THEN
                BEGIN
                    V_TRAVA_STATUS:= 'N';
                    V_CD_ELO_CARTEIRA_TORRE_FRETES:=0;
                    
                    RAISE_APPLICATION_ERROR(
                        -20001,
                        'ERRO ENCONTRADO - '
                         || SQLCODE
                         || ' -ERROR- '
                         || SQLERRM
                    );
                    ROLLBACK;
                END;
        END;

        OPEN P_RETORNO FOR
        SELECT CASE WHEN V_TRAVA_STATUS = 'S' THEN 1 ELSE 0 END  AS P_SUCESSO
        FROM DUAL;


    EXCEPTION
        WHEN OTHERS THEN
            BEGIN
                RAISE_APPLICATION_ERROR(
                    -20001,
                    'ERRO ENCONTRADO - '
                     || SQLCODE
                     || ' -ERROR- '
                     || SQLERRM
                );
                ROLLBACK;
            END;
    END PE_DELETAR_CARTEIRA_FREIGH;
    
    PROCEDURE PX_GET_CARTEIRA_PROTOCOLO (
        P_CD_ELO_CARTEIRA       IN VND.ELO_CARTEIRA.CD_ELO_CARTEIRA%TYPE,
        P_RETURN                OUT T_CURSOR
    )

    IS

BEGIN


        OPEN P_RETURN FOR


SELECT 

GRP.CD_ELO_CARTEIRA  ,    
VBPROT.NU_PROTOCOLO,
ROUND(SUM(VBPROT.QT_AGENDADA_PROTOCOLO - 
NVL(
        (
        SELECT SUM(FT.NU_QUANTIDADE) NU_QUANTIDADE 
        FROM VND.ELO_CARTEIRA_TORRE_FRETES FT
        WHERE 
        EC.CD_ELO_CARTEIRA = FT.CD_ELO_CARTEIRA
        AND FT.NU_PROTOCOLO = VBPROT.NU_PROTOCOLO
        )
    ,0)
    ),0) QT_AGENDADA_TORRE_FRETES,

ROUND(SUM(VBPROT.QT_AGENDADA_PROTOCOLO), 0) QT_AGENDADA_PROTOCOLO,
ROUND(SUM(VBPROT.QT_AGENDADA_PROTOCOLO),0) QT_SALDO_TF_PROTOCOLO

FROM  VND.ELO_CARTEIRA EC
INNER JOIN VND.ELO_VBAK_PROTOCOLO VBPROT
ON
VBPROT.CD_ELO_CARTEIRA = EC.CD_ELO_CARTEIRA
INNER JOIN ELO_CARTEIRA_GROUPING GRP
ON GRP.CD_ELO_CARTEIRA_GROUPING = EC.CD_ELO_CARTEIRA_GROUPING

WHERE 
EXISTS (SELECT 1 FROM VND.ELO_CARTEIRA CTA 
WHERE EC.CD_ELO_CARTEIRA_GROUPING = CTA.CD_ELO_CARTEIRA_GROUPING
AND CTA.CD_ELO_CARTEIRA = P_CD_ELO_CARTEIRA)

GROUP BY GRP.CD_ELO_CARTEIRA,
VBPROT.NU_PROTOCOLO

;


    END PX_GET_CARTEIRA_PROTOCOLO;    
        
 
   FUNCTION FX_GET_PROTOCOLO_TORRE_DATA(
           P_NU_PROTOCOLO VND.ELO_CARTEIRA_TORRE_FRETES.NU_PROTOCOLO%TYPE,
           P_COLUNA VARCHAR2 
   )
    RETURN VARCHAR2 IS

    P_RETORNO         VARCHAR2(4000);
    
V_COOPERADO VARCHAR2(4000);   
V_DESTINO VARCHAR2(4000);
V_ROTEIRO VARCHAR2(4000);
V_SALDO NUMBER(9,3);
V_CD_GRUPO_EMBALAGEM VARCHAR2(4000);
BEGIN
    
    BEGIN    
    select  CASE e.IC_ENTREGA_OUTRA_FILIAL when 'S' then cf.no_cooperativa_filial 
    else C.NO_COOPERADO end Cooperado, 
    CASE e.IC_ENTREGA_OUTRA_FILIAL when 'S' then upper(concat(concat(cfm.no_municipio,'-'), es.sg_estado))
    else upper(concat(concat(m.no_municipio,'-'), cfes.sg_estado)) end "Destino", 
    e.DS_ROTEIRO "Roteiro" , nvl(e.QT_QUANTIDADE,0)  - nvl(e.QT_FORNECIDO,0) SALDO, 
    (SELECT EMBL.CD_GRUPO_EMBALAGEM || '-' || EMBL.DS_GRUPO_EMBALAGEM  
    FROM vnd.sacaria SAC 
    INNER JOIN VND.GRUPO_EMBALAGEM EMBL
    ON 
    EMBL.CD_GRUPO_EMBALAGEM = SAC.CD_GRUPO_EMBALAGEM
    WHERE 
    SAC.CD_SACARIA = ae.CD_SACARIA
    AND ROWNUM =1) CD_GRUPO_EMBALAGEM
    
    INTO V_COOPERADO, V_DESTINO,V_ROTEIRO, V_SALDO, V_CD_GRUPO_EMBALAGEM
    from cpt.entrega e, cpt.autorizacao_entrega ae, cpt.cooperado c, 
    cpt.propriedade_cooperado p, ctf.municipio m, 
    ctf.estado es, cpt.cooperativa_filial cf, ctf.municipio cfm, 
    ctf.estado cfes
    where e.nu_protocolo_entrega = P_NU_PROTOCOLO --'R1163LL1'
    and ae.cd_autorizacao_entrega = e.cd_autorizacao_entrega
    and c.cd_cooperado = ae.cd_cooperado
    and p.cd_propriedade = ae.cd_propriedade
    and m.cd_municipio = p.cd_municipio
    and es.cd_estado = m.cd_estado
    and cf.cd_cooperativa_filial = ae.cd_cooperativa_filial
    and cfm.cd_municipio = cf.cd_municipio
    and cfes.cd_estado = cfm.cd_estado
    AND ROWNUM =1;
    EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
    V_COOPERADO:=NULL;   
    V_DESTINO :=NULL;
    V_ROTEIRO :=NULL;
    V_SALDO:=0;
    WHEN OTHERS  THEN 
    V_COOPERADO:=NULL;   
    V_DESTINO :=NULL;
    V_ROTEIRO :=NULL;
    V_SALDO:=0;
    
    END;
    
    P_RETORNO:=
        CASE 
        WHEN UPPER(P_COLUNA) = 'ROTEIRO' THEN V_ROTEIRO
        WHEN UPPER(P_COLUNA) = 'DESTINO' THEN V_DESTINO
        WHEN UPPER(P_COLUNA) = 'COOPERADO' THEN V_COOPERADO
        WHEN UPPER(P_COLUNA) = 'SALDO' THEN TO_CHAR(V_SALDO)
        WHEN UPPER(P_COLUNA) = 'CD_GRUPO_EMBALAGEM' THEN V_CD_GRUPO_EMBALAGEM
        ELSE V_ROTEIRO
    END;



    RETURN P_RETORNO;

  END FX_GET_PROTOCOLO_TORRE_DATA;   

   

END GX_ELO_FREIGHTOWER;
/