 CREATE OR REPLACE FORCE VIEW "VND"."VW_ELO_AGENDAMENTO_DAY_PLAN" 
 ( CD_ELO_AGENDAMENTO_DAY,CD_ELO_AGENDAMENTO_WEEK,NU_DIA_SEMANA, CD_GRUPO_EMBALAGEM, NU_QUANTIDADE ) AS 
 
WITH CTE_DAY_FU AS (

SELECT 
CD_ELO_AGENDAMENTO_WEEK,CD_ELO_AGENDAMENTO_ITEM,NU_SEMANA,QT_COTA,QT_SEMANA,QT_EMERGENCIAL, IC_AJUSTE 
FROM VND.VW_ELO_AGENDAMENTO_WEEK_PLAN 
WHERE IC_AJUSTE IN ('S', 'C')
),

CTE_DAY AS (
SELECT 
DD_DAY.CD_ELO_AGENDAMENTO_DAY, 
DD_DAY.CD_ELO_AGENDAMENTO_WEEK,
DD_DAY.NU_DIA_SEMANA,
DD_DAY.CD_GRUPO_EMBALAGEM,
DD_DAY.NU_QUANTIDADE,
ITEMFG.QT_SEMANA, ITEMFG.IC_AJUSTE

FROM VND.ELO_AGENDAMENTO_DAY DD_DAY
INNER JOIN CTE_DAY_FU ITEMFG
ON ITEMFG.CD_ELO_AGENDAMENTO_WEEK = DD_DAY.CD_ELO_AGENDAMENTO_WEEK

),
--SELECT * FROM CTE_DAY
CTE_STEP_DAY AS 
(
SELECT 
DD_DAY.CD_ELO_AGENDAMENTO_DAY, 
DD_DAY.CD_ELO_AGENDAMENTO_WEEK,
DD_DAY.NU_DIA_SEMANA,
DD_DAY.CD_GRUPO_EMBALAGEM,
DD_DAY.NU_QUANTIDADE,
DD_DAY.QT_SEMANA, 
DD_DAY.IC_AJUSTE,
CASE 
    WHEN 
        (SELECT 
        SUM(SDA.NU_QUANTIDADE) NU_QUANTIDADE 
        FROM CTE_DAY SDA 
        WHERE SDA.CD_ELO_AGENDAMENTO_WEEK = DD_DAY.CD_ELO_AGENDAMENTO_WEEK) >0 
        THEN  
            (SELECT 
            SUM(SDA.NU_QUANTIDADE) NU_QUANTIDADE 
            FROM CTE_DAY SDA 
            WHERE SDA.CD_ELO_AGENDAMENTO_WEEK = DD_DAY.CD_ELO_AGENDAMENTO_WEEK) 
        ELSE 1 END TOTAL_DAY

FROM CTE_DAY DD_DAY

)
SELECT 

DD_DAY.CD_ELO_AGENDAMENTO_DAY, 
DD_DAY.CD_ELO_AGENDAMENTO_WEEK,
DD_DAY.NU_DIA_SEMANA,
DD_DAY.CD_GRUPO_EMBALAGEM,
ROUND(((DD_DAY.NU_QUANTIDADE / DD_DAY.TOTAL_DAY) * DD_DAY.QT_SEMANA),3) NU_QUANTIDADE--,
--DD_DAY.QT_SEMANA--, 
--DD_DAY.IC_AJUSTE,
--DD_DAY.TOTAL_DAY

FROM CTE_STEP_DAY DD_DAY
UNION


SELECT 
DD_DAY.CD_ELO_AGENDAMENTO_DAY, 
DD_DAY.CD_ELO_AGENDAMENTO_WEEK,
DD_DAY.NU_DIA_SEMANA,
DD_DAY.CD_GRUPO_EMBALAGEM,
DD_DAY.NU_QUANTIDADE

FROM VND.ELO_AGENDAMENTO_ITEM ITEM
INNER JOIN VND.ELO_AGENDAMENTO_SUPERVISOR SUP
ON ITEM.CD_ELO_AGENDAMENTO_SUPERVISOR = SUP.CD_ELO_AGENDAMENTO_SUPERVISOR
INNER JOIN VND.ELO_AGENDAMENTO AGE
ON AGE.CD_ELO_AGENDAMENTO = SUP.CD_ELO_AGENDAMENTO
INNER JOIN VND.ELO_STATUS AGE_ST
ON AGE.CD_ELO_STATUS = AGE_ST.CD_ELO_STATUS
AND AGE_ST.SG_STATUS IN ('PLAN',' AGCTR')
INNER JOIN VND.ELO_AGENDAMENTO_WEEK IGWEEK
ON 
IGWEEK.CD_ELO_AGENDAMENTO_ITEM = ITEM.CD_ELO_AGENDAMENTO_ITEM
INNER JOIN VND.ELO_AGENDAMENTO_DAY DD_DAY
ON 
IGWEEK.CD_ELO_AGENDAMENTO_WEEK = DD_DAY.CD_ELO_AGENDAMENTO_WEEK

WHERE 
NOT EXISTS (SELECT 1 FROM CTE_DAY_FU IIW WHERE IIW.CD_ELO_AGENDAMENTO_WEEK = IGWEEK.CD_ELO_AGENDAMENTO_WEEK);


/
GRANT SELECT ON "VND"."VW_ELO_AGENDAMENTO_DAY_PLAN" TO VND, VND_SEC; 

