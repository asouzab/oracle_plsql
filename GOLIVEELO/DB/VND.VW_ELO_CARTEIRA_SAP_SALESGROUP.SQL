DROP MATERIALIZED VIEW VND.VW_ELO_CARTEIRA_SAP_SALESGROUP;
CREATE MATERIALIZED VIEW VND.VW_ELO_CARTEIRA_SAP_SALESGROUP 
    (NU_CARTEIRA_VERSION,CD_SALES_DISTRICT,NO_SALES_DISTRICT,CD_SALES_OFFICE,NO_SALES_OFFICE,
     CD_SALES_GROUP,NO_SALES_GROUP)
TABLESPACE WEB_DATA
PCTUSED    0
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOCACHE
NOLOGGING
NOCOMPRESS
BUILD IMMEDIATE
REFRESH COMPLETE
START WITH TO_DATE('18-05-2018 01:00:00','dd-mm-yyyy hh24:mi:ss')
NEXT SYSDATE+1 
WITH PRIMARY KEY
AS 
/* Formatted on 17/05/2018 15:51:30 (QP5 v5.318) */
WITH
    CTE_SALES_GROUP_INI
    AS
        (SELECT DISTINCT CTX.NU_CARTEIRA_VERSION,
                         CTX.CD_SALES_DISTRICT,
                         CTX.NO_SALES_DISTRICT,
                         CTX.CD_SALES_OFFICE,
                         CTX.NO_SALES_OFFICE,
                         CTX.CD_SALES_GROUP,
                         CTX.NO_SALES_GROUP
           FROM VND.ELO_CARTEIRA_SAP CTX
          WHERE CTX.DH_CARTEIRA > (SYSDATE - 30)),
    CTE_SALES_GROUP
    AS
        (  SELECT CTX.NU_CARTEIRA_VERSION,
                  MAX (CTX.CD_SALES_DISTRICT) CD_SALES_DISTRICT,
                  MAX (CTX.NO_SALES_DISTRICT) NO_SALES_DISTRICT,
                  MAX (CTX.CD_SALES_OFFICE) CD_SALES_OFFICE,
                  MAX (CTX.NO_SALES_OFFICE) NO_SALES_OFFICE,
                  CTX.CD_SALES_GROUP        CD_SALES_GROUP,
                  MAX (CTX.NO_SALES_GROUP)  NO_SALES_GROUP
             FROM CTE_SALES_GROUP_INI CTX
            WHERE     CTX.NO_SALES_OFFICE IS NOT NULL
                  AND NOT (CTX.NO_SALES_OFFICE = ' ')
                  AND CTX.NO_SALES_GROUP IS NOT NULL
                  AND NOT (CTX.NO_SALES_GROUP = ' ')
         GROUP BY CTX.NU_CARTEIRA_VERSION, CTX.CD_SALES_GROUP)
SELECT CTX.NU_CARTEIRA_VERSION,
       CTX.CD_SALES_DISTRICT,
       CTX.NO_SALES_DISTRICT,
       CTX.CD_SALES_OFFICE,
       CTX.NO_SALES_OFFICE,
       CTX.CD_SALES_GROUP,
       CTX.NO_SALES_GROUP
  FROM CTE_SALES_GROUP CTX
UNION
SELECT XCTX.NU_CARTEIRA_VERSION,
       XCTX.CD_SALES_DISTRICT,
       XCTX.NO_SALES_DISTRICT,
       XCTX.CD_SALES_OFFICE,
       XCTX.NO_SALES_OFFICE,
       XCTX.CD_SALES_GROUP,
       CASE 
       WHEN XCTX.NO_SALES_GROUP IS NULL THEN 
        (SELECT C.NO_SALES_GROUP FROM CTE_SALES_GROUP C WHERE C.CD_SALES_GROUP = XCTX.CD_SALES_GROUP AND ROWNUM=1 )
       WHEN XCTX.NO_SALES_GROUP = ' ' THEN 
        (SELECT C.NO_SALES_GROUP FROM CTE_SALES_GROUP C WHERE C.CD_SALES_GROUP = XCTX.CD_SALES_GROUP AND ROWNUM=1)
       WHEN TRIM(XCTX.NO_SALES_GROUP) = '' THEN 
        (SELECT C.NO_SALES_GROUP FROM CTE_SALES_GROUP C WHERE C.CD_SALES_GROUP = XCTX.CD_SALES_GROUP AND ROWNUM=1)
       WHEN LENGTH(XCTX.NO_SALES_GROUP) < 3 THEN 
        (SELECT C.NO_SALES_GROUP FROM CTE_SALES_GROUP C WHERE C.CD_SALES_GROUP = XCTX.CD_SALES_GROUP AND ROWNUM=1)
       ELSE XCTX.NO_SALES_GROUP END
 
       NO_SALES_GROUP
  FROM CTE_SALES_GROUP_INI XCTX
 WHERE NOT EXISTS
           (SELECT 1
              FROM CTE_SALES_GROUP JAFO
             WHERE     JAFO.CD_SALES_GROUP = XCTX.CD_SALES_GROUP
                   AND JAFO.NU_CARTEIRA_VERSION = XCTX.NU_CARTEIRA_VERSION);


COMMENT ON MATERIALIZED VIEW VND.VW_ELO_CARTEIRA_SAP_SALESGROUP IS 'snapshot table for snapshot VND.VW_ELO_CARTEIRA_SAP_SALESGROUP';

GRANT SELECT ON VND.VW_ELO_CARTEIRA_SAP_SALESGROUP TO VND, VND_SEC, CPT;