create or replace TRIGGER TU_TORRE_FRETES_CAPRO 
BEFORE INSERT OR UPDATE ON ELO_CARTEIRA_TORRE_FRETES 
REFERENCING OLD AS old NEW AS new FOR EACH ROW

DECLARE

V_TORRE_FRETES_PRO NUMBER;
V_TORRE_CANEW NUMBER;
V_CD_ELO_CARTEIRA NUMBER;

BEGIN
  
IF :new.NU_QUANTIDADE > 0 AND :new.VL_FRETE_CONTRATADO > 0  THEN 

    BEGIN
    SELECT I_ST_NEW_PRO.CD_ELO_STATUS INTO V_TORRE_CANEW
    FROM VND.ELO_CARTEIRA E_CT
    INNER JOIN VND.ELO_STATUS I_ST_NEW_PRO
    ON E_CT.CD_STATUS_TORRE_FRETES =  I_ST_NEW_PRO.CD_ELO_STATUS
    INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
    ON 
    I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
    WHERE
    I_ST_NEW_PRO.SG_STATUS IN('CANEW', 'CAPRO') 
    AND I_ST_TIPO_NP.SG_TIPO_STATUS = 'CARTE' 
    AND E_CT.CD_ELO_CARTEIRA = :new.CD_ELO_CARTEIRA;
    EXCEPTION 
    WHEN OTHERS THEN 
        V_TORRE_CANEW:= NULL;
    END;
        
    
    
    IF V_TORRE_CANEW IS NOT NULL THEN
        BEGIN
    
            BEGIN
            SELECT I_ST_NEW_PRO.CD_ELO_STATUS INTO V_TORRE_FRETES_PRO
            FROM VND.ELO_STATUS I_ST_NEW_PRO
            INNER JOIN VND.ELO_TIPO_STATUS  I_ST_TIPO_NP
            ON 
            I_ST_NEW_PRO.CD_ELO_TIPO_STATUS = I_ST_TIPO_NP.CD_ELO_TIPO_STATUS
            WHERE
            I_ST_NEW_PRO.SG_STATUS IN('CAPRO') 
            AND I_ST_TIPO_NP.SG_TIPO_STATUS = 'CARTE' ;
            EXCEPTION 
            WHEN OTHERS THEN 
                V_TORRE_FRETES_PRO:= NULL;
               
            END;
            
            BEGIN
            
            UPDATE VND.ELO_CARTEIRA c
            SET c.CD_STATUS_TORRE_FRETES = V_TORRE_FRETES_PRO,
            DH_MODIFICACAO_TORRE_FRETES= CURRENT_DATE,
            DH_CONTRATACAO_TORRE_FRETES= CURRENT_DATE
            
            WHERE
            c.CD_ELO_CARTEIRA_GROUPING = (SELECT X.CD_ELO_CARTEIRA_GROUPING FROM VND.ELO_CARTEIRA X WHERE X.CD_ELO_CARTEIRA = :new.CD_ELO_CARTEIRA )
            AND c.CD_STATUS_TORRE_FRETES IN( V_TORRE_CANEW, V_TORRE_FRETES_PRO);
            
            EXCEPTION 
            WHEN OTHERS THEN 
                ROLLBACK ;
               
            END;
        END ;
    
    END IF;


END IF;
  
  
END;